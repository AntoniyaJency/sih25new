
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Railway Map - Live Train Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1a1a2e, #16213e, #0f3460);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .map-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-panel h3 {
            margin: 0 0 15px 0;
            color: #ffd700;
            font-size: 1.1rem;
        }
        
        .train-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 4px solid #ffd700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .train-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .train-item.selected {
            background: rgba(255,215,0,0.2);
            border-left-color: #ff6b6b;
        }
        
        .train-number {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.9rem;
        }
        
        .train-route {
            font-size: 0.8rem;
            opacity: 0.8;
            margin: 3px 0;
        }
        
        .train-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .status-running { background: #4CAF50; }
        .status-delayed { background: #FF9800; }
        .status-arrived { background: #2196F3; }
        .status-scheduled { background: #9C27B0; }
        
        .stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        .stat-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš‚ Real-time Railway Map - Live Train Tracking</h1>
        <p>AI-Powered Train Traffic Control | Smart India Hackathon 2025 | Ministry of Railways</p>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading Railway Network...</p>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <div class="control-panel">
        <h3>ðŸš‚ Live Trains</h3>
        <div id="train-list">
            <!-- Train list will be populated here -->
        </div>
    </div>
    
    <div class="stats">
        <div class="stat-item">
            <span>Total Trains:</span>
            <span class="stat-value" id="total-trains">0</span>
        </div>
        <div class="stat-item">
            <span>Running:</span>
            <span class="stat-value" id="running-trains">0</span>
        </div>
        <div class="stat-item">
            <span>Average Speed:</span>
            <span class="stat-value" id="avg-speed">0 km/h</span>
        </div>
        <div class="stat-item">
            <span>Last Update:</span>
            <span class="stat-value" id="last-update">--:--:--</span>
        </div>
    </div>
    
    <div class="legend">
        <h4>Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffd700;"></div>
            <span>Terminal Station</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4CAF50;"></div>
            <span>Junction Station</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196F3;"></div>
            <span>Main Line</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FF9800;"></div>
            <span>Suburban Line</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on India
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Add dark theme tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Data storage
        let stations = [];
        let tracks = [];
        let trains = [];
        let trainMarkers = {};
        let trackLines = [];
        let stationMarkers = [];
        let selectedTrain = null;
        
        // Train icons
        const trainIcon = L.divIcon({
            className: 'train-marker',
            html: 'ðŸš‚',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const selectedTrainIcon = L.divIcon({
            className: 'selected-train-marker',
            html: 'ðŸš‚',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        // Station icons
        const terminalIcon = L.divIcon({
            className: 'terminal-marker',
            html: 'ðŸ¢',
            iconSize: [25, 25],
            iconAnchor: [12, 12]
        });
        
        const junctionIcon = L.divIcon({
            className: 'junction-marker',
            html: 'ðŸš‰',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Load initial data
        async function loadMapData() {
            try {
                const response = await fetch('/api/map-data');
                const data = await response.json();
                
                stations = data.stations;
                tracks = data.tracks;
                trains = data.trains;
                
                initializeMap();
                updateTrainList();
                updateStats();
                
                // Hide loading screen
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading map data:', error);
                // Use fallback data
                loadFallbackData();
            }
        }
        
        function loadFallbackData() {
            // Fallback data if API is not available
            stations = [
                {"id": "MUM", "name": "Mumbai Central", "lat": 19.0176, "lon": 72.8562, "type": "terminal", "platforms": 12},
                {"id": "DLI", "name": "Delhi", "lat": 28.6600, "lon": 77.2300, "type": "terminal", "platforms": 16},
                {"id": "MAS", "name": "Chennai Central", "lat": 13.0827, "lon": 80.2707, "type": "terminal", "platforms": 12},
                {"id": "SBC", "name": "Bangalore City", "lat": 12.9716, "lon": 77.5946, "type": "terminal", "platforms": 10},
                {"id": "THA", "name": "Thane", "lat": 19.1972, "lon": 72.9702, "type": "junction", "platforms": 8},
                {"id": "HYB", "name": "Hyderabad", "lat": 17.3850, "lon": 78.4867, "type": "junction", "platforms": 8}
            ];
            
            tracks = [
                {"id": "MUM-DLI", "from": {"lat": 19.0176, "lon": 72.8562}, "to": {"lat": 28.6600, "lon": 77.2300}, "distance": 1384, "max_speed": 160, "type": "main"},
                {"id": "MAS-SBC", "from": {"lat": 13.0827, "lon": 80.2707}, "to": {"lat": 12.9716, "lon": 77.5946}, "distance": 362, "max_speed": 120, "type": "main"},
                {"id": "MUM-THA", "from": {"lat": 19.0176, "lon": 72.8562}, "to": {"lat": 19.1972, "lon": 72.9702}, "distance": 35, "max_speed": 80, "type": "suburban"}
            ];
            
            trains = [
                {"id": "T001", "train_number": "12345", "train_type": "Rajdhani Express", "origin": "MUM", "destination": "DLI", "current_station": "MUM", "next_station": "THA", "lat": 19.0176, "lon": 72.8562, "speed": 120, "status": "running", "progress": 0.3},
                {"id": "T002", "train_number": "67890", "train_type": "Shatabdi Express", "origin": "MAS", "destination": "SBC", "current_station": "MAS", "next_station": "SBC", "lat": 13.0827, "lon": 80.2707, "speed": 130, "status": "running", "progress": 0.5},
                {"id": "T003", "train_number": "11111", "train_type": "Freight Train", "origin": "MUM", "destination": "THA", "current_station": "MUM", "next_station": "THA", "lat": 19.0176, "lon": 72.8562, "speed": 80, "status": "running", "progress": 0.7}
            ];
            
            initializeMap();
            updateTrainList();
            updateStats();
            document.getElementById('loading').style.display = 'none';
        }
        
        function initializeMap() {
            // Clear existing markers
            stationMarkers.forEach(marker => map.removeLayer(marker));
            trackLines.forEach(line => map.removeLayer(line));
            Object.values(trainMarkers).forEach(marker => map.removeLayer(marker));
            
            stationMarkers = [];
            trackLines = [];
            trainMarkers = {};
            
            // Add stations
            stations.forEach(station => {
                const icon = station.type === 'terminal' ? terminalIcon : junctionIcon;
                const marker = L.marker([station.lat, station.lon], {icon: icon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="color: black;">
                            <h3>${station.name}</h3>
                            <p><strong>Type:</strong> ${station.type}</p>
                            <p><strong>Platforms:</strong> ${station.platforms}</p>
                            <p><strong>Code:</strong> ${station.id}</p>
                        </div>
                    `);
                stationMarkers.push(marker);
            });
            
            // Add track lines
            tracks.forEach(track => {
                const color = track.type === 'main' ? '#2196F3' : '#FF9800';
                const line = L.polyline([
                    [track.from.lat, track.from.lon],
                    [track.to.lat, track.to.lon]
                ], {
                    color: color,
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
                
                line.bindPopup(`
                    <div style="color: black;">
                        <h4>${track.id}</h4>
                        <p><strong>Distance:</strong> ${track.distance} km</p>
                        <p><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                        <p><strong>Type:</strong> ${track.type}</p>
                    </div>
                `);
                
                trackLines.push(line);
            });
            
            // Add train markers
            trains.forEach(train => {
                const marker = L.marker([train.lat, train.lon], {icon: trainIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="color: black;">
                            <h3>${train.train_number}</h3>
                            <p><strong>Type:</strong> ${train.train_type}</p>
                            <p><strong>Route:</strong> ${train.origin} â†’ ${train.destination}</p>
                            <p><strong>Speed:</strong> ${train.speed} km/h</p>
                            <p><strong>Status:</strong> ${train.status}</p>
                            <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                        </div>
                    `);
                
                marker.on('click', () => selectTrain(train.id));
                trainMarkers[train.id] = marker;
            });
        }
        
        function updateTrainList() {
            const trainList = document.getElementById('train-list');
            trainList.innerHTML = '';
            
            trains.forEach(train => {
                const trainItem = document.createElement('div');
                trainItem.className = 'train-item';
                if (selectedTrain === train.id) {
                    trainItem.classList.add('selected');
                }
                
                trainItem.innerHTML = `
                    <div class="train-number">${train.train_number}</div>
                    <div class="train-route">${train.train_type}</div>
                    <div class="train-route">${train.origin} â†’ ${train.destination}</div>
                    <div class="train-status status-${train.status}">${train.status}</div>
                `;
                
                trainItem.onclick = () => selectTrain(train.id);
                trainList.appendChild(trainItem);
            });
        }
        
        function selectTrain(trainId) {
            selectedTrain = trainId;
            
            // Update train list selection
            document.querySelectorAll('.train-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Update train markers
            Object.entries(trainMarkers).forEach(([id, marker]) => {
                if (id === trainId) {
                    marker.setIcon(selectedTrainIcon);
                    map.setView([trains.find(t => t.id === trainId).lat, trains.find(t => t.id === trainId).lon], 8);
                } else {
                    marker.setIcon(trainIcon);
                }
            });
            
            updateTrainList();
        }
        
        function updateStats() {
            const runningTrains = trains.filter(t => t.status === 'running').length;
            const avgSpeed = trains.length > 0 ? Math.round(trains.reduce((sum, t) => sum + t.speed, 0) / trains.length) : 0;
            
            document.getElementById('total-trains').textContent = trains.length;
            document.getElementById('running-trains').textContent = runningTrains;
            document.getElementById('avg-speed').textContent = avgSpeed + ' km/h';
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        // Simulate real-time updates
        function simulateRealTimeUpdates() {
            trains.forEach(train => {
                if (train.status === 'running') {
                    // Simulate movement
                    const speedFactor = train.speed / 100;
                    train.progress += speedFactor * 0.01;
                    
                    if (train.progress > 1) {
                        train.progress = 0;
                        // Simulate reaching destination
                        if (Math.random() < 0.1) {
                            train.status = 'arrived';
                        }
                    }
                    
                    // Update position based on progress
                    const originStation = stations.find(s => s.id === train.origin);
                    const destStation = stations.find(s => s.id === train.destination);
                    
                    if (originStation && destStation) {
                        train.lat = originStation.lat + (destStation.lat - originStation.lat) * train.progress;
                        train.lon = originStation.lon + (destStation.lon - originStation.lon) * train.progress;
                    }
                }
            });
            
            // Update map
            Object.entries(trainMarkers).forEach(([id, marker]) => {
                const train = trains.find(t => t.id === id);
                if (train) {
                    marker.setLatLng([train.lat, train.lon]);
                }
            });
            
            updateStats();
        }
        
        // Start the application
        loadMapData();
        
        // Update every 2 seconds
        setInterval(simulateRealTimeUpdates, 2000);
        
        // Update train list every 5 seconds
        setInterval(updateTrainList, 5000);
    </script>
</body>
</html>
    