<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Traffic Control System - Smart India Hackathon 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Railway Traffic Control</div>
            <button class="mobile-menu-toggle">☰</button>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="map">Live Map</a></li>
                <li><a href="#" class="nav-link" data-page="trains">Trains</a></li>
                <li><a href="#" class="nav-link" data-page="analytics">Analytics</a></li>
                <li><a href="#" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>AI-Powered Railway Traffic Control</h1>
                <p>Maximizing Section Throughput Using Intelligent Decision Support System</p>
                <p>Smart India Hackathon 2025 - Ministry of Railways</p>
                <a href="#" class="btn" onclick="showPage('dashboard')">View Dashboard</a>
                <a href="#" class="btn btn-secondary" onclick="showPage('map')">Live Map</a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>🚂 Real-time Tracking</h3>
                    <p>Monitor all trains across the Indian railway network with live position updates and movement tracking.</p>
                </div>
                <div class="feature-card">
                    <h3>⚡ AI Optimization</h3>
                    <p>Advanced algorithms for conflict detection, route optimization, and throughput maximization.</p>
                </div>
                <div class="feature-card">
                    <h3>📊 Analytics Dashboard</h3>
                    <p>Comprehensive analytics and reporting for railway operations and performance metrics.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="page-header">
                <h2>Dashboard</h2>
                <p class="page-description">Real-time overview of railway operations and system performance</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>🚂 Active Trains</h3>
                    <div class="metric-value" id="dashboard-active-trains">50</div>
                    <div class="metric-label">Currently Running</div>
                    <div class="metric-trend">↗️ +5% from yesterday</div>
                </div>
                <div class="dashboard-card">
                    <h3>🚉 Stations</h3>
                    <div class="metric-value" id="dashboard-stations">124</div>
                    <div class="metric-label">Total Stations</div>
                    <div class="metric-trend">📍 All operational</div>
                </div>
                <div class="dashboard-card">
                    <h3>🛤️ Track Segments</h3>
                    <div class="metric-value" id="dashboard-tracks">86</div>
                    <div class="metric-label">Active Routes</div>
                    <div class="metric-trend">✅ 98% utilization</div>
                </div>
                <div class="dashboard-card">
                    <h3>⚡ System Status</h3>
                    <div class="metric-value online" id="dashboard-status">Online</div>
                    <div class="metric-label">All Systems Operational</div>
                    <div class="metric-trend">🟢 99.9% uptime</div>
                </div>
                <div class="dashboard-card">
                    <h3>⚠️ Active Alerts</h3>
                    <div class="metric-value" id="dashboard-alerts">3</div>
                    <div class="metric-label">Requires Attention</div>
                    <div class="metric-trend">🔴 2 High Priority</div>
                </div>
                <div class="dashboard-card">
                    <h3>🔄 Rerouting Events</h3>
                    <div class="metric-value" id="dashboard-rerouting">1</div>
                    <div class="metric-label">In Progress</div>
                    <div class="metric-trend">🟡 AI Optimizing</div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <h3>🚂 Recent Train Activity</h3>
                <div class="activity-feed" id="dashboard-activity">
                    <div class="activity-item">
                        <span class="activity-time">2 min ago</span>
                        <span class="activity-text">Train 12951 (Rajdhani Express) arrived at Mumbai Central</span>
                        <span class="activity-status success">✅ On Time</span>
                    </div>
                    <div class="activity-item">
                        <span class="activity-time">5 min ago</span>
                        <span class="activity-text">Train 12301 (Rajdhani Express) departed from Delhi</span>
                        <span class="activity-status success">✅ On Time</span>
                    </div>
                    <div class="activity-item">
                        <span class="activity-time">8 min ago</span>
                        <span class="activity-text">AI rerouting applied for Train 12431 due to track maintenance</span>
                        <span class="activity-status warning">🔄 Rerouted</span>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <h3>📈 Performance Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <h4>Average Speed</h4>
                        <div class="metric-number">135 km/h</div>
                        <div class="metric-change positive">+2.3%</div>
                    </div>
                    <div class="metric-item">
                        <h4>Punctuality Rate</h4>
                        <div class="metric-number">94.2%</div>
                        <div class="metric-change positive">+1.1%</div>
                    </div>
                    <div class="metric-item">
                        <h4>Section Utilization</h4>
                        <div class="metric-number">87.5%</div>
                        <div class="metric-change positive">+0.8%</div>
                    </div>
                    <div class="metric-item">
                        <h4>Energy Efficiency</h4>
                        <div class="metric-number">92.1%</div>
                        <div class="metric-change positive">+0.5%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Map Page -->
        <div id="map" class="page">
            <div class="page-header">
                <h2>Live Railway Map</h2>
                <p class="page-description">Interactive map showing real-time train positions and railway network across India</p>
            </div>
            
            <!-- Main Map Layout -->
            <div class="map-layout">
                <!-- Left Sidebar -->
                <div class="map-sidebar">
                    <!-- Map Controls -->
                    <div class="sidebar-section">
                        <h4>🎮 Map Controls</h4>
                        <div class="control-grid">
                            <button onclick="initializeMap()" class="btn btn-primary">🗺️ Initialize</button>
                            <button onclick="loadMapData()" class="btn btn-secondary">📊 Load Data</button>
                            <button onclick="refreshMap()" class="btn btn-success">🔄 Refresh</button>
                            <button onclick="forceUpdateTrains()" class="btn btn-info">🚂 Update</button>
                        </div>
                    </div>
                    
                    <!-- Display Options -->
                    <div class="sidebar-section">
                        <h4>⚙️ Display Options</h4>
                        <div class="control-grid">
                            <button onclick="toggleFullscreen()" class="btn btn-warning">📺 Fullscreen</button>
                            <button onclick="toggleVoiceAlerts()" class="btn" id="voice-btn">🔊 Voice</button>
                            <button onclick="toggleLiveMovement()" class="btn" id="movement-btn">▶️ Movement</button>
                        </div>
                    </div>
                    
                    <!-- Station Monitoring -->
                    <div class="sidebar-section">
                        <h4>📡 Station Monitoring</h4>
                        <div class="station-controls">
                            <div class="searchable-dropdown">
                                <div class="dropdown-container">
                                    <input type="text" id="station-search" placeholder="Search and select station..." class="searchable-input" oninput="filterStations()" onfocus="showDropdown()" onblur="hideDropdown()">
                                    <div class="dropdown-arrow" onclick="toggleDropdown()">▼</div>
                                </div>
                                <div id="station-dropdown" class="dropdown-list" style="display: none;">
                                    <div class="dropdown-options" id="station-options">
                                        <!-- Options will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="station-buttons">
                                <button onclick="populateStationDropdown()" class="btn btn-secondary">🔄 Load</button>
                                <button onclick="clearStationFocus()" class="btn btn-outline">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="sidebar-section">
                        <h4>📊 System Status</h4>
                        <div id="status-display" class="status-display">Ready</div>
                    </div>
                </div>
                
                <!-- Main Map Area -->
                <div class="map-main">
                    <div id="railway-map" class="railway-map"></div>
                    
                    <!-- AI Message Overlay -->
                    <div id="ai-overlay" class="ai-overlay">
                        <div id="ai-message"></div>
                    </div>
                </div>
                
                <!-- Right Panel -->
                <div class="map-right-panel">
                    <!-- Real-Time Data -->
                    <div class="panel-section">
                        <h4>📈 Real-Time Data</h4>
                        <div id="real-time-data" class="real-time-data">
                            <div class="data-item">
                                <span class="data-label">Active Trains:</span>
                                <span id="active-trains-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Total Stations:</span>
                                <span id="total-stations-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Track Segments:</span>
                                <span id="track-segments-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">System Status:</span>
                                <span id="system-status" class="data-value">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Live Station Monitoring Panel -->
            <div id="live-station-monitor" class="live-station-monitor" style="display: none;">
                <div class="monitor-header">
                    <h4>📡 Live Station Monitoring</h4>
                    <button onclick="closeLiveMonitor()" class="btn btn-secondary">✕ Close</button>
                </div>
                <div class="monitor-content">
                    <div class="station-info">
                        <h5 id="monitor-station-name">Station Name</h5>
                        <div class="station-stats">
                            <div class="stat-item">
                                <span class="stat-label">Connected Tracks:</span>
                                <span id="monitor-tracks-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Active Trains:</span>
                                <span id="monitor-trains-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Monitoring Status:</span>
                                <span id="monitor-status" class="stat-value">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="live-trains-list">
                        <h6>🚂 Live Train Movements</h6>
                        <div id="live-trains-container" class="trains-container">
                            <div class="loading">Loading live train data...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Controller Panel -->
        </div>

        <!-- Trains Page -->
        <div id="trains" class="page">
            <div class="page-header">
                <h2>Train Management</h2>
                <p class="page-description">Monitor and manage all active trains across the railway network</p>
            </div>
            
            <div class="trains-controls">
                <div class="search-filter">
                    <input type="text" id="train-search" placeholder="Search trains by number, type, or route..." class="search-input">
                    <select id="train-filter" class="filter-select">
                        <option value="all">All Trains</option>
                        <option value="running">Running</option>
                        <option value="delayed">Delayed</option>
                        <option value="on-time">On Time</option>
                        <option value="rajdhani">Rajdhani Express</option>
                        <option value="shatabdi">Shatabdi Express</option>
                        <option value="mail">Mail/Express</option>
                    </select>
                    <button onclick="refreshTrainData()" class="btn btn-primary">🔄 Refresh</button>
                </div>
            </div>
            
            <div class="trains-grid" id="trains-grid">
                <div class="loading">Loading train data...</div>
            </div>
            
            <div class="train-stats">
                <div class="stat-card">
                    <h4>Total Trains</h4>
                    <div class="stat-number" id="total-trains">50</div>
                </div>
                <div class="stat-card">
                    <h4>Running</h4>
                    <div class="stat-number running" id="running-trains">48</div>
                </div>
                <div class="stat-card">
                    <h4>Delayed</h4>
                    <div class="stat-number delayed" id="delayed-trains">2</div>
                </div>
                <div class="stat-card">
                    <h4>On Time</h4>
                    <div class="stat-number ontime" id="ontime-trains">46</div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="page-header">
                <h2>Analytics</h2>
                <p class="page-description">Comprehensive analytics and performance metrics</p>
            </div>
            
            <div class="analytics-controls">
                <div class="time-filter">
                    <select id="time-range" class="filter-select">
                        <option value="1h">Last Hour</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                    <button onclick="refreshAnalytics()" class="btn btn-primary">🔄 Refresh</button>
                </div>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card large">
                    <h3>📈 Performance Trends</h3>
                    <div class="chart-container">
                        <div class="chart-placeholder">
                            <div class="chart-title">Average Train Speed Over Time</div>
                            <div class="chart-visual">
                                <div class="chart-line">
                                    <div class="data-point" style="left: 10%; height: 60%;" title="130 km/h"></div>
                                    <div class="data-point" style="left: 30%; height: 70%;" title="135 km/h"></div>
                                    <div class="data-point" style="left: 50%; height: 65%;" title="132 km/h"></div>
                                    <div class="data-point" style="left: 70%; height: 75%;" title="138 km/h"></div>
                                    <div class="data-point" style="left: 90%; height: 80%;" title="142 km/h"></div>
                                </div>
                            </div>
                            <div class="chart-labels">
                                <span>00:00</span>
                                <span>06:00</span>
                                <span>12:00</span>
                                <span>18:00</span>
                                <span>24:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <h3>🚂 Train Performance</h3>
                    <div class="metric-list">
                        <div class="metric-row">
                            <span class="metric-name">Punctuality Rate</span>
                            <span class="metric-value">94.2%</span>
                            <span class="metric-change positive">+1.1%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Average Delay</span>
                            <span class="metric-value">4.2 min</span>
                            <span class="metric-change negative">-0.8 min</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Energy Efficiency</span>
                            <span class="metric-value">92.1%</span>
                            <span class="metric-change positive">+0.5%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Section Utilization</span>
                            <span class="metric-value">87.5%</span>
                            <span class="metric-change positive">+0.8%</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <h3>🚉 Station Analytics</h3>
                    <div class="station-list">
                        <div class="station-item">
                            <span class="station-name">Mumbai Central</span>
                            <span class="station-trains">45 trains/day</span>
                            <span class="station-delay">2.1% delay</span>
                        </div>
                        <div class="station-item">
                            <span class="station-name">Delhi</span>
                            <span class="station-trains">52 trains/day</span>
                            <span class="station-delay">1.8% delay</span>
                        </div>
                        <div class="station-item">
                            <span class="station-name">Chennai Central</span>
                            <span class="station-trains">38 trains/day</span>
                            <span class="station-delay">3.2% delay</span>
                        </div>
                        <div class="station-item">
                            <span class="station-name">Kolkata</span>
                            <span class="station-trains">41 trains/day</span>
                            <span class="station-delay">2.5% delay</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <h3>⚠️ Alert Analysis</h3>
                    <div class="alert-stats">
                        <div class="alert-type">
                            <span class="alert-icon">🔴</span>
                            <span class="alert-name">Collision Risk</span>
                            <span class="alert-count">3</span>
                        </div>
                        <div class="alert-type">
                            <span class="alert-icon">🟡</span>
                            <span class="alert-name">Rerouting</span>
                            <span class="alert-count">12</span>
                        </div>
                        <div class="alert-type">
                            <span class="alert-icon">🔵</span>
                            <span class="alert-name">Delays</span>
                            <span class="alert-count">8</span>
                        </div>
                        <div class="alert-type">
                            <span class="alert-icon">🟢</span>
                            <span class="alert-name">Resolved</span>
                            <span class="alert-count">156</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <h3>🛤️ Route Performance</h3>
                    <div class="route-list">
                        <div class="route-item">
                            <span class="route-name">Mumbai-Delhi</span>
                            <div class="route-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 94%;"></div>
                                </div>
                                <span class="progress-text">94% on-time</span>
                            </div>
                        </div>
                        <div class="route-item">
                            <span class="route-name">Delhi-Chennai</span>
                            <div class="route-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 91%;"></div>
                                </div>
                                <span class="progress-text">91% on-time</span>
                            </div>
                        </div>
                        <div class="route-item">
                            <span class="route-name">Chennai-Kolkata</span>
                            <div class="route-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 96%;"></div>
                                </div>
                                <span class="progress-text">96% on-time</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card large">
                    <h3>🤖 AI Optimization Impact</h3>
                    <div class="ai-metrics">
                        <div class="ai-metric">
                            <h4>Throughput Improvement</h4>
                            <div class="ai-value">+12.3%</div>
                            <div class="ai-description">Average section throughput increase</div>
                        </div>
                        <div class="ai-metric">
                            <h4>Delay Reduction</h4>
                            <div class="ai-value">-18.7%</div>
                            <div class="ai-description">Average delay reduction</div>
                        </div>
                        <div class="ai-metric">
                            <h4>Energy Savings</h4>
                            <div class="ai-value">+8.2%</div>
                            <div class="ai-description">Energy efficiency improvement</div>
                        </div>
                        <div class="ai-metric">
                            <h4>Cost Savings</h4>
                            <div class="ai-value">₹2.4M</div>
                            <div class="ai-description">Monthly operational savings</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about" class="page">
            <div class="page-header">
                <h2>About Railway Traffic Control System</h2>
                <p class="page-description">AI-Powered Decision Support System for Maximizing Section Throughput</p>
            </div>
            
            <div class="about-hero">
                <div class="hero-content">
                    <h1>🚂 Smart India Hackathon 2025</h1>
                    <h2>Ministry of Railways</h2>
                    <p class="hero-description">Revolutionary AI-powered railway traffic control system designed to maximize throughput, minimize delays, and ensure optimal train operations across India's vast railway network.</p>
                </div>
            </div>
            
            <div class="about-content">
                <div class="about-section">
                    <h3>🎯 Mission Statement</h3>
                    <div class="mission-content">
                        <p>To revolutionize railway traffic control through AI-powered decision support systems that maximize throughput while ensuring safety and efficiency across India's railway network.</p>
                        <div class="mission-goals">
                            <div class="goal-item">
                                <span class="goal-icon">🎯</span>
                                <span class="goal-text">Maximize Section Throughput</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-icon">⏱️</span>
                                <span class="goal-text">Minimize Travel Time</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-icon">🛡️</span>
                                <span class="goal-text">Ensure Safety</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-icon">⚡</span>
                                <span class="goal-text">Rapid Re-optimization</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="about-section">
                    <h3>🚀 Technology Stack</h3>
                    <div class="tech-grid">
                        <div class="tech-category">
                            <h4>🤖 Artificial Intelligence</h4>
                            <ul>
                                <li>Machine Learning Algorithms</li>
                                <li>Real-time Decision Support</li>
                                <li>Predictive Analytics</li>
                                <li>Optimization Algorithms</li>
                            </ul>
                        </div>
                        <div class="tech-category">
                            <h4>💻 Frontend Technologies</h4>
                            <ul>
                                <li>HTML5 & CSS3</li>
                                <li>JavaScript (ES6+)</li>
                                <li>Leaflet.js Maps</li>
                                <li>Responsive Design</li>
                            </ul>
                        </div>
                        <div class="tech-category">
                            <h4>⚙️ Backend Technologies</h4>
                            <ul>
                                <li>Python 3.8+</li>
                                <li>FastAPI Framework</li>
                                <li>Real-time Data Processing</li>
                                <li>RESTful APIs</li>
                            </ul>
                        </div>
                        <div class="tech-category">
                            <h4>🗄️ Data Management</h4>
                            <ul>
                                <li>Real-time Simulation</li>
                                <li>JSON Data Structures</li>
                                <li>Performance Monitoring</li>
                                <li>Audit Trails</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="about-section">
                    <h3>🌟 Key Features</h3>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">🗺️</div>
                            <h4>Real-time Map</h4>
                            <p>Interactive map showing live train positions, routes, and railway network across India</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🤖</div>
                            <h4>AI Controller</h4>
                            <p>Intelligent section controller with collision detection and rerouting capabilities</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📊</div>
                            <h4>Analytics Dashboard</h4>
                            <p>Comprehensive analytics and performance metrics for railway operations</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🚂</div>
                            <h4>Train Management</h4>
                            <p>Complete train monitoring, filtering, and management system</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🔊</div>
                            <h4>Voice Alerts</h4>
                            <p>Real-time voice notifications for critical events and alerts</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📈</div>
                            <h4>Performance Metrics</h4>
                            <p>Real-time KPIs including throughput, delays, and efficiency metrics</p>
                        </div>
                    </div>
                </div>
                
                <div class="about-section">
                    <h3>🏆 Smart India Hackathon 2025</h3>
                    <div class="hackathon-info">
                        <div class="hackathon-details">
                            <h4>Problem Statement</h4>
                            <p><strong>"Maximizing Section Throughput Using AI-Powered Precise Train Traffic Control"</strong></p>
                            <p>Develop an intelligent decision-support system for section controllers that leverages operations research and AI to model constraints, train priorities, and operational rules for conflict-free, feasible schedules.</p>
                        </div>
                        <div class="hackathon-details">
                            <h4>Ministry of Railways</h4>
                            <p>This system addresses the core challenge of maximizing throughput while minimizing delays in a constrained railway network, providing section controllers with AI-powered recommendations and real-time monitoring capabilities.</p>
                        </div>
                        <div class="hackathon-details">
                            <h4>Impact</h4>
                            <p>Expected to improve railway efficiency by 12-15%, reduce delays by 18-20%, and enhance passenger satisfaction through better on-time performance and optimized train schedules.</p>
                        </div>
                    </div>
                </div>
                
                <div class="about-section">
                    <h3>👥 Development Team</h3>
                    <div class="team-info">
                        <p>Developed by a dedicated team of engineers and data scientists for the Smart India Hackathon 2025, focusing on innovative solutions for India's railway infrastructure challenges.</p>
                        <div class="team-highlights">
                            <div class="highlight">🎓 Academic Excellence</div>
                            <div class="highlight">💡 Innovation Focus</div>
                            <div class="highlight">🇮🇳 National Impact</div>
                            <div class="highlight">🚀 Future-Ready Technology</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Railway Traffic Control System. Smart India Hackathon 2025 - Ministry of Railways</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let mapData = null;
        let trainMarkers = [];
        let stationMarkers = [];
        let trackLines = [];
        let isFullscreen = false;
        let voiceAlertsEnabled = false;
        let liveMovementEnabled = true;
        let realTimeUpdateInterval;
        let selectedStation = null;
        let liveStationMonitorInterval;

        // Navigation functionality
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Initialize map if on map page
            if (pageId === 'map') {
                setTimeout(() => {
                    initializeMap();
                    loadMapData();
                }, 100);
            }
            
            // Auto-load train data if on trains page
            if (pageId === 'trains' && mapData && mapData.trains) {
                setTimeout(() => refreshTrainData(), 100);
                setupTrainSearchListeners();
            }
            
            // Auto-load analytics data if on analytics page
            if (pageId === 'analytics') {
                setTimeout(() => {
                    refreshAnalytics();
                    // Set up auto-refresh every 5 seconds
                    if (window.analyticsInterval) {
                        clearInterval(window.analyticsInterval);
                    }
                    window.analyticsInterval = setInterval(() => {
                        refreshAnalytics();
                    }, 5000);
                }, 100);
            } else {
                // Clear analytics interval when leaving analytics page
                if (window.analyticsInterval) {
                    clearInterval(window.analyticsInterval);
                    window.analyticsInterval = null;
                }
            }
        }
        
        // Setup train search and filter event listeners
        function setupTrainSearchListeners() {
            const searchInput = document.getElementById('train-search');
            const filterSelect = document.getElementById('train-filter');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value;
                    const filterType = filterSelect ? filterSelect.value : 'all';
                    refreshTrainData(searchTerm, filterType);
                });
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    const filterType = this.value;
                    const searchTerm = searchInput ? searchInput.value : '';
                    refreshTrainData(searchTerm, filterType);
                });
            }
        }

        // Map initialization
        function initializeMap() {
            try {
                console.log('🗺️ Initializing map...');
                
                if (map) {
                    map.remove();
                }
                
                // Create new map with stable settings - centered on India
                map = L.map('railway-map', {
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    touchZoom: true,
                    zoomSnap: 0.25,
                    zoomDelta: 0.5,
                    wheelPxPerZoomLevel: 120
                }).setView([20.5937, 78.9629], 6); // Centered on India with zoom level 6
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 4,
                    opacity: 0.9
                }).addTo(map);
                
                // Prevent map resize issues
                map.on('resize', () => {
                    setTimeout(() => map.invalidateSize(), 100);
                });
                
                // Initial size validation
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                // Debug: Check if map is visible
                setTimeout(() => {
                    if (map) {
                        console.log('🗺️ Map is ready and visible');
                        console.log('📍 Map center:', map.getCenter());
                        console.log('🔍 Map zoom:', map.getZoom());
                        
                        // Force map to be visible
                        map.invalidateSize();
                        
                        // Auto-load data after map is ready
                        loadMapData();
                    } else {
                        console.error('❌ Map failed to initialize');
                        updateStatus('❌ Map failed to initialize');
                    }
                }, 1000);
                
                updateStatus('✅ Map initialized successfully');
                
            } catch (error) {
                console.error('❌ Map initialization error:', error);
                updateStatus('❌ Map initialization failed: ' + error.message);
            }
        }

        // Load map data
        function loadMapData() {
            console.log('📊 Loading map data...');
            updateStatus('📊 Loading map data...');
            
            // Check if we're on GitHub Pages or local development
            const isGitHubPages = window.location.hostname === 'antoniyaajency.github.io' || 
                                window.location.hostname.includes('github.io');
            
            if (isGitHubPages) {
                console.log('🌐 Detected GitHub Pages deployment, using fallback data');
                loadFallbackData();
                return;
            }
            
            // Try multiple API endpoints for different deployment scenarios
            const apiEndpoints = [
                'http://localhost:8084/api/map-data',
                'http://localhost:8081/api/map-data',
                'http://localhost:8080/api/map-data',
                '/api/map-data',
                './api/map-data'
            ];
            
            let currentEndpointIndex = 0;
            
            function tryNextEndpoint() {
                if (currentEndpointIndex >= apiEndpoints.length) {
                    console.log('🔄 All API endpoints failed, using fallback data');
                    loadFallbackData();
                    return;
                }
                
                const endpoint = apiEndpoints[currentEndpointIndex];
                console.log(`🔄 Trying endpoint: ${endpoint}`);
                
                fetch(endpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('✅ Map data loaded from:', endpoint);
                        mapData = data;
                        
                        // Add elements to map
                        addStationsToMap();
                        addTracksToMap();
                        addTrainsToMap();
                        addTrainPathVisualization();
                        
                        // Update real-time data display
                        updateRealTimeDataDisplay();
                        
                        // Start real-time updates
                        startRealTimeUpdates();
                        
                        // Populate station dropdown
                        populateStationDropdown();
                        
                        updateStatus('✅ Map data loaded successfully');
                    })
                    .catch(error => {
                        console.error(`❌ Error loading from ${endpoint}:`, error);
                        currentEndpointIndex++;
                        tryNextEndpoint();
                    });
            }
            
            tryNextEndpoint();
        }
        
        // Fallback data when API is not available
        function loadFallbackData() {
            console.log('🔄 Loading fallback data...');
            updateStatus('🔄 Loading fallback data...');
            
            // Load comprehensive trains data (all 50 trains from local backend)
            const allTrains = [
                // Rajdhani Express trains (Premium trains connecting Delhi)
                {"id": "T001", "train_number": "12951", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "BCT", "destination": "DLI", "current_station": "BCT", "next_station": "KYN", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.1, "lat": 19.0176, "lon": 72.8562, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 1},
                {"id": "T002", "train_number": "12301", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "HWH", "destination": "DLI", "current_station": "HWH", "next_station": "KGP", "status": "running", "speed": 140, "delay_minutes": 2, "progress": 0.2, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-WB", "priority": 1},
                {"id": "T003", "train_number": "12431", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "TVC", "destination": "DLI", "current_station": "TVC", "next_station": "ERS", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.3, "lat": 8.4875, "lon": 76.9525, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KER-TN", "priority": 1},
                {"id": "T004", "train_number": "12009", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "SBC", "destination": "DLI", "current_station": "SBC", "next_station": "SA", "status": "running", "speed": 130, "delay_minutes": 1, "progress": 0.4, "lat": 12.9716, "lon": 77.5946, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KAR-TN", "priority": 1},
                {"id": "T005", "train_number": "12423", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "DLI", "destination": "ALD", "current_station": "DLI", "next_station": "GZB", "status": "running", "speed": 140, "delay_minutes": 0, "progress": 0.1, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-NCR", "priority": 1},
                
                // Shatabdi Express trains (Day trains)
                {"id": "T006", "train_number": "12017", "train_name": "Shatabdi Express", "train_type": "Shatabdi Express", "origin": "DLI", "destination": "KTA", "current_station": "DLI", "next_station": "JP", "status": "running", "speed": 150, "delay_minutes": 0, "progress": 0.2, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-RJ", "priority": 2},
                {"id": "T007", "train_number": "12002", "train_name": "Shatabdi Express", "train_type": "Shatabdi Express", "origin": "BCT", "destination": "AII", "current_station": "BCT", "next_station": "PUNE", "status": "running", "speed": 140, "delay_minutes": 3, "progress": 0.5, "lat": 19.0176, "lon": 72.8562, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 2},
                {"id": "T008", "train_number": "12008", "train_name": "Shatabdi Express", "train_type": "Shatabdi Express", "origin": "MAS", "destination": "SBC", "current_station": "MAS", "next_station": "SA", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.6, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-KAR", "priority": 2},
                {"id": "T009", "train_number": "12004", "train_name": "Shatabdi Express", "train_type": "Shatabdi Express", "origin": "DLI", "destination": "LKO", "current_station": "DLI", "next_station": "CNB", "status": "running", "speed": 150, "delay_minutes": 1, "progress": 0.3, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 2},
                {"id": "T010", "train_number": "12010", "train_name": "Shatabdi Express", "train_type": "Shatabdi Express", "origin": "HWH", "destination": "BBS", "current_station": "HWH", "next_station": "KGP", "status": "running", "speed": 130, "delay_minutes": 2, "progress": 0.4, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-ODI", "priority": 2},
                
                // Duronto Express trains (Non-stop long distance)
                {"id": "T011", "train_number": "12259", "train_name": "Duronto Express", "train_type": "Duronto Express", "origin": "SC", "destination": "DLI", "current_station": "SC", "next_station": "NGP", "status": "running", "speed": 140, "delay_minutes": 0, "progress": 0.7, "lat": 17.4399, "lon": 78.5010, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TEL-MP", "priority": 2},
                {"id": "T012", "train_number": "12274", "train_name": "Duronto Express", "train_type": "Duronto Express", "origin": "HWH", "destination": "DLI", "current_station": "HWH", "next_station": "MGS", "status": "running", "speed": 140, "delay_minutes": 1, "progress": 0.5, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-UP", "priority": 2},
                {"id": "T013", "train_number": "12218", "train_name": "Duronto Express", "train_type": "Duronto Express", "origin": "CSMT", "destination": "SC", "current_station": "CSMT", "next_station": "PUNE", "status": "running", "speed": 120, "delay_minutes": 4, "progress": 0.8, "lat": 18.9398, "lon": 72.8355, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-TEL", "priority": 2},
                {"id": "T014", "train_number": "12290", "train_name": "Duronto Express", "train_type": "Duronto Express", "origin": "MAS", "destination": "DLI", "current_station": "MAS", "next_station": "BZA", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.2, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TEL", "priority": 2},
                {"id": "T015", "train_number": "12246", "train_name": "Duronto Express", "train_type": "Duronto Express", "origin": "YPR", "destination": "DLI", "current_station": "YPR", "next_station": "UBL", "status": "running", "speed": 130, "delay_minutes": 2, "progress": 0.6, "lat": 13.0284, "lon": 77.5043, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KAR-KAR", "priority": 2},
                
                // Superfast Express trains
                {"id": "T016", "train_number": "12049", "train_name": "Gatimaan Express", "train_type": "Gatimaan Express", "origin": "DLI", "destination": "JHS", "current_station": "DLI", "next_station": "AGR", "status": "running", "speed": 160, "delay_minutes": 0, "progress": 0.1, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 2},
                {"id": "T017", "train_number": "22691", "train_name": "Rajdhani Express", "train_type": "Rajdhani Express", "origin": "DLI", "destination": "KOL", "current_station": "DLI", "next_station": "CNB", "status": "running", "speed": 140, "delay_minutes": 0, "progress": 0.2, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 1},
                {"id": "T018", "train_number": "12434", "train_name": "Chennai Rajdhani", "train_type": "Chennai Rajdhani", "origin": "MAS", "destination": "DLI", "current_station": "MAS", "next_station": "RU", "status": "running", "speed": 130, "delay_minutes": 1, "progress": 0.3, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TEL", "priority": 1},
                {"id": "T019", "train_number": "12952", "train_name": "Mumbai Rajdhani", "train_type": "Mumbai Rajdhani", "origin": "DLI", "destination": "BCT", "current_station": "DLI", "next_station": "KTA", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.4, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-RJ", "priority": 1},
                {"id": "T020", "train_number": "22406", "train_name": "Vande Bharat Express", "train_type": "Vande Bharat Express", "origin": "DLI", "destination": "KTA", "current_station": "DLI", "next_station": "JP", "status": "running", "speed": 160, "delay_minutes": 0, "progress": 0.3, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-RJ", "priority": 2},
                
                // Long Distance Express trains
                {"id": "T021", "train_number": "12615", "train_name": "Grand Trunk Express", "train_type": "Grand Trunk Express", "origin": "MAS", "destination": "DLI", "current_station": "MAS", "next_station": "GNT", "status": "running", "speed": 110, "delay_minutes": 5, "progress": 0.4, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TEL", "priority": 3},
                {"id": "T022", "train_number": "12842", "train_name": "Coromandel Express", "train_type": "Coromandel Express", "origin": "HWH", "destination": "MAS", "current_station": "HWH", "next_station": "BBS", "status": "running", "speed": 120, "delay_minutes": 3, "progress": 0.5, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-ODI", "priority": 3},
                {"id": "T023", "train_number": "12840", "train_name": "Howrah Mail", "train_type": "Howrah Mail", "origin": "MAS", "destination": "HWH", "current_station": "MAS", "next_station": "VSKP", "status": "running", "speed": 110, "delay_minutes": 2, "progress": 0.6, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TEL", "priority": 3},
                {"id": "T024", "train_number": "12321", "train_name": "Howrah Mail", "train_type": "Howrah Mail", "origin": "HWH", "destination": "BCT", "current_station": "HWH", "next_station": "NGP", "status": "running", "speed": 110, "delay_minutes": 7, "progress": 0.6, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-MP", "priority": 3},
                {"id": "T025", "train_number": "16031", "train_name": "Andaman Express", "train_type": "Andaman Express", "origin": "MAS", "destination": "VM", "current_station": "MAS", "next_station": "VM", "status": "running", "speed": 100, "delay_minutes": 4, "progress": 0.7, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TN", "priority": 3},
                
                // Regional Express trains
                {"id": "T026", "train_number": "11013", "train_name": "Coimbatore Express", "train_type": "Coimbatore Express", "origin": "MAS", "destination": "CBE", "current_station": "MAS", "next_station": "SA", "status": "running", "speed": 100, "delay_minutes": 3, "progress": 0.8, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TN", "priority": 3},
                {"id": "T027", "train_number": "12163", "train_name": "Mumbai Express", "train_type": "Mumbai Express", "origin": "BCT", "destination": "PUNE", "current_station": "BCT", "next_station": "PUNE", "status": "running", "speed": 100, "delay_minutes": 2, "progress": 0.5, "lat": 19.0176, "lon": 72.8562, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 3},
                {"id": "T028", "train_number": "12779", "train_name": "Goa Express", "train_type": "Goa Express", "origin": "HWH", "destination": "VSKP", "current_station": "HWH", "next_station": "VSKP", "status": "running", "speed": 110, "delay_minutes": 5, "progress": 0.4, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-TEL", "priority": 3},
                {"id": "T029", "train_number": "12432", "train_name": "Trivandrum Rajdhani", "train_type": "Trivandrum Rajdhani", "origin": "DLI", "destination": "TVC", "current_station": "DLI", "next_station": "BPL", "status": "running", "speed": 130, "delay_minutes": 1, "progress": 0.2, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-MP", "priority": 1},
                {"id": "T030", "train_number": "12269", "train_name": "Chennai Duronto", "train_type": "Chennai Duronto", "origin": "HWH", "destination": "MAS", "current_station": "HWH", "next_station": "BZA", "status": "running", "speed": 130, "delay_minutes": 0, "progress": 0.3, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-TEL", "priority": 2},
                
                // Mail/Express trains
                {"id": "T031", "train_number": "12651", "train_name": "Sampark Kranti Express", "train_type": "Sampark Kranti Express", "origin": "TVC", "destination": "DLI", "current_station": "TVC", "next_station": "CBE", "status": "running", "speed": 110, "delay_minutes": 2, "progress": 0.6, "lat": 8.4875, "lon": 76.9525, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KER-TN", "priority": 3},
                {"id": "T032", "train_number": "12617", "train_name": "Mangala Lakshadweep Express", "train_type": "Mangala Lakshadweep Express", "origin": "ERS", "destination": "DLI", "current_station": "ERS", "next_station": "SRR", "status": "running", "speed": 110, "delay_minutes": 3, "progress": 0.7, "lat": 9.9718, "lon": 76.2847, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KER-KER", "priority": 3},
                {"id": "T033", "train_number": "12625", "train_name": "Kerala Express", "train_type": "Kerala Express", "origin": "TVC", "destination": "DLI", "current_station": "TVC", "next_station": "PGT", "status": "running", "speed": 110, "delay_minutes": 1, "progress": 0.5, "lat": 8.4875, "lon": 76.9525, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KER-KER", "priority": 3},
                {"id": "T034", "train_number": "12484", "train_name": "Punjab Express", "train_type": "Punjab Express", "origin": "DLI", "destination": "CNB", "current_station": "DLI", "next_station": "GZB", "status": "running", "speed": 100, "delay_minutes": 4, "progress": 0.8, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 3},
                {"id": "T035", "train_number": "12472", "train_name": "Swaraj Express", "train_type": "Swaraj Express", "origin": "PUNE", "destination": "SUR", "current_station": "PUNE", "next_station": "SUR", "status": "running", "speed": 100, "delay_minutes": 2, "progress": 0.6, "lat": 18.5204, "lon": 73.8567, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MAH-MAH", "priority": 3},
                
                // Freight trains (cargo)
                {"id": "T036", "train_number": "FG001", "train_name": "Container Freight", "train_type": "Container Freight", "origin": "BCT", "destination": "PUNE", "current_station": "BCT", "next_station": "PUNE", "status": "running", "speed": 80, "delay_minutes": 15, "progress": 0.3, "lat": 19.0176, "lon": 72.8562, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 4},
                {"id": "T037", "train_number": "FG002", "train_name": "Coal Freight", "train_type": "Coal Freight", "origin": "BBS", "destination": "HWH", "current_station": "BBS", "next_station": "HWH", "status": "running", "speed": 70, "delay_minutes": 20, "progress": 0.4, "lat": 20.2961, "lon": 85.8245, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "ODI-WB", "priority": 4},
                {"id": "T038", "train_number": "FG003", "train_name": "Iron Ore Freight", "train_type": "Iron Ore Freight", "origin": "BZA", "destination": "VSKP", "current_station": "BZA", "next_station": "VSKP", "status": "running", "speed": 75, "delay_minutes": 18, "progress": 0.5, "lat": 16.5062, "lon": 80.6480, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TEL-TEL", "priority": 4},
                {"id": "T039", "train_number": "FG004", "train_name": "Petroleum Freight", "train_type": "Petroleum Freight", "origin": "JU", "destination": "AII", "current_station": "JU", "next_station": "AII", "status": "running", "speed": 70, "delay_minutes": 22, "progress": 0.6, "lat": 26.2389, "lon": 73.0243, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "RJ-RJ", "priority": 4},
                {"id": "T040", "train_number": "FG005", "train_name": "Food Grains Freight", "train_type": "Food Grains Freight", "origin": "DLI", "destination": "MAS", "current_station": "DLI", "next_station": "CNB", "status": "running", "speed": 80, "delay_minutes": 16, "progress": 0.7, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 4},
                
                // Suburban/Local trains
                {"id": "T041", "train_number": "SL001", "train_name": "Local Train", "train_type": "Local Train", "origin": "CSMT", "destination": "KYN", "current_station": "CSMT", "next_station": "THA", "status": "running", "speed": 60, "delay_minutes": 5, "progress": 0.2, "lat": 18.9398, "lon": 72.8355, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 5},
                {"id": "T042", "train_number": "SL002", "train_name": "Local Train", "train_type": "Local Train", "origin": "MAS", "destination": "TBM", "current_station": "MAS", "next_station": "CGL", "status": "running", "speed": 50, "delay_minutes": 8, "progress": 0.3, "lat": 13.0827, "lon": 80.2707, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TN-TN", "priority": 5},
                {"id": "T043", "train_number": "SL003", "train_name": "EMU Local", "train_type": "EMU Local", "origin": "HWH", "destination": "SRC", "current_station": "HWH", "next_station": "SRC", "status": "running", "speed": 45, "delay_minutes": 10, "progress": 0.4, "lat": 22.5848, "lon": 88.3426, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KOL-WB", "priority": 5},
                {"id": "T044", "train_number": "SL004", "train_name": "MEMU Local", "train_type": "MEMU Local", "origin": "DLI", "destination": "GZB", "current_station": "DLI", "next_station": "GZB", "status": "running", "speed": 55, "delay_minutes": 6, "progress": 0.5, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-NCR", "priority": 5},
                {"id": "T045", "train_number": "SL005", "train_name": "Passenger Train", "train_type": "Passenger Train", "origin": "BZA", "destination": "SC", "current_station": "BZA", "next_station": "WL", "status": "running", "speed": 40, "delay_minutes": 12, "progress": 0.6, "lat": 16.5062, "lon": 80.6480, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "TEL-TEL", "priority": 5},
                
                // Special trains
                {"id": "T046", "train_number": "SP001", "train_name": "Palace on Wheels", "train_type": "Palace on Wheels", "origin": "DLI", "destination": "JP", "current_station": "DLI", "next_station": "JP", "status": "running", "speed": 90, "delay_minutes": 0, "progress": 0.8, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-RJ", "priority": 1},
                {"id": "T047", "train_number": "SP002", "train_name": "Deccan Odyssey", "train_type": "Deccan Odyssey", "origin": "BCT", "destination": "PUNE", "current_station": "BCT", "next_station": "PUNE", "status": "running", "speed": 80, "delay_minutes": 0, "progress": 0.9, "lat": 19.0176, "lon": 72.8562, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "MUM-MAH", "priority": 1},
                {"id": "T048", "train_number": "SP003", "train_name": "Golden Chariot", "train_type": "Golden Chariot", "origin": "SBC", "destination": "YPR", "current_station": "SBC", "next_station": "YPR", "status": "running", "speed": 70, "delay_minutes": 0, "progress": 0.7, "lat": 12.9716, "lon": 77.5946, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "KAR-KAR", "priority": 1},
                {"id": "T049", "train_number": "SP004", "train_name": "Maharaja Express", "train_type": "Maharaja Express", "origin": "DLI", "destination": "BCT", "current_station": "DLI", "next_station": "JP", "status": "running", "speed": 100, "delay_minutes": 0, "progress": 0.6, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-RJ", "priority": 1},
                {"id": "T050", "train_number": "SP005", "train_name": "Buddhist Circuit Train", "train_type": "Buddhist Circuit Train", "origin": "DLI", "destination": "BSB", "current_station": "DLI", "next_station": "LKO", "status": "running", "speed": 90, "delay_minutes": 0, "progress": 0.5, "lat": 28.6448, "lon": 77.2194, "collision_risk": false, "rerouting_needed": false, "ai_message": "", "section_id": "DEL-UP", "priority": 1}
            ];
            
            mapData = {
                stations: [
                    // Northern Railway Zone
                    {"id": "DLI", "name": "New Delhi", "lat": 28.6448, "lon": 77.2194},
                    {"id": "NDLS", "name": "New Delhi Railway Station", "lat": 28.6448, "lon": 77.2194},
                    {"id": "AGR", "name": "Agra Cantt", "lat": 27.1767, "lon": 78.0081},
                    {"id": "JHS", "name": "Jhansi", "lat": 25.4484, "lon": 78.5685},
                    {"id": "GWL", "name": "Gwalior", "lat": 26.2183, "lon": 78.1828},
                    {"id": "BPL", "name": "Bhopal", "lat": 23.2599, "lon": 77.4126},
                    {"id": "UJN", "name": "Ujjain", "lat": 23.1765, "lon": 75.7885},
                    {"id": "RTM", "name": "Ratlam", "lat": 23.3315, "lon": 75.0367},
                    {"id": "KTA", "name": "Kota", "lat": 25.2138, "lon": 75.8648},
                    {"id": "AII", "name": "Ajmer", "lat": 26.4499, "lon": 74.6399},
                    {"id": "JP", "name": "Jaipur", "lat": 26.9196, "lon": 75.7878},
                    {"id": "BIKANER", "name": "Bikaner", "lat": 28.0229, "lon": 73.3119},
                    {"id": "JU", "name": "Jodhpur", "lat": 26.2389, "lon": 73.0243},
                    
                    // Western Railway Zone
                    {"id": "BCT", "name": "Mumbai Central", "lat": 19.0176, "lon": 72.8562},
                    {"id": "CSMT", "name": "Chhatrapati Shivaji Maharaj Terminus", "lat": 18.9398, "lon": 72.8355},
                    {"id": "THA", "name": "Thane", "lat": 19.1972, "lon": 72.9702},
                    {"id": "KYN", "name": "Kalyan", "lat": 19.2437, "lon": 73.1305},
                    {"id": "PUNE", "name": "Pune", "lat": 18.5204, "lon": 73.8567},
                    {"id": "PUNE_JN", "name": "Pune Junction", "lat": 18.5204, "lon": 73.8567},
                    {"id": "SUR", "name": "Solapur", "lat": 17.6599, "lon": 75.9064},
                    {"id": "UBL", "name": "Hubli", "lat": 15.3647, "lon": 75.1240},
                    {"id": "BZA", "name": "Vijayawada", "lat": 16.5062, "lon": 80.6480},
                    {"id": "MAS", "name": "Chennai Central", "lat": 13.0827, "lon": 80.2707},
                    {"id": "NAS", "name": "Nashik Road", "lat": 19.9975, "lon": 73.7898},
                    {"id": "MMR", "name": "Manmad", "lat": 20.2437, "lon": 74.4378},
                    {"id": "JL", "name": "Jalgaon", "lat": 21.0077, "lon": 75.5626},
                    {"id": "BSL", "name": "Bhusaval", "lat": 21.0542, "lon": 75.7849},
                    {"id": "AK", "name": "Akola", "lat": 20.7002, "lon": 77.0082},
                    {"id": "BD", "name": "Badnera", "lat": 20.7506, "lon": 77.7749},
                    {"id": "NGP", "name": "Nagpur", "lat": 21.1458, "lon": 79.0882},
                    
                    // Eastern Railway Zone
                    {"id": "HWH", "name": "Howrah", "lat": 22.5848, "lon": 88.3426},
                    {"id": "KOAA", "name": "Kolkata Airport", "lat": 22.6533, "lon": 88.4467},
                    {"id": "SRC", "name": "Santragachi", "lat": 22.6033, "lon": 88.2667},
                    {"id": "KGP", "name": "Kharagpur", "lat": 22.3460, "lon": 87.3197},
                    {"id": "BBS", "name": "Bhubaneswar", "lat": 20.2961, "lon": 85.8245},
                    {"id": "CTC", "name": "Cuttack", "lat": 20.4625, "lon": 85.8828},
                    {"id": "PURI", "name": "Puri", "lat": 19.8135, "lon": 85.8312},
                    {"id": "VZM", "name": "Vizianagaram", "lat": 18.1124, "lon": 83.4116},
                    {"id": "VSKP", "name": "Visakhapatnam", "lat": 17.7231, "lon": 83.3219},
                    {"id": "RJY", "name": "Rajahmundry", "lat": 17.0005, "lon": 81.8040},
                    {"id": "ELR", "name": "Eluru", "lat": 16.7107, "lon": 81.0953},
                    
                    // Southern Railway Zone
                    {"id": "MSB", "name": "Chennai Beach", "lat": 13.0878, "lon": 80.2785},
                    {"id": "TBM", "name": "Tambaram", "lat": 12.9249, "lon": 80.1000},
                    {"id": "CGL", "name": "Chengalpattu", "lat": 12.6918, "lon": 79.9753},
                    {"id": "VM", "name": "Villupuram", "lat": 11.9401, "lon": 79.4861},
                    {"id": "VRI", "name": "Vriddhachalam", "lat": 11.5196, "lon": 79.3250},
                    {"id": "TPJ", "name": "Tiruchirapalli", "lat": 10.7905, "lon": 78.7047},
                    {"id": "DG", "name": "Dindigul", "lat": 10.3673, "lon": 77.9803},
                    {"id": "MDU", "name": "Madurai", "lat": 9.9252, "lon": 78.1198},
                    {"id": "TEN", "name": "Tirunelveli", "lat": 8.7139, "lon": 77.7567},
                    {"id": "NCJ", "name": "Nagercoil", "lat": 8.1840, "lon": 77.4343},
                    {"id": "TVC", "name": "Thiruvananthapuram Central", "lat": 8.4875, "lon": 76.9525},
                    {"id": "QLN", "name": "Kollam", "lat": 8.8932, "lon": 76.6141},
                    {"id": "ALLP", "name": "Alappuzha", "lat": 9.4981, "lon": 76.3388},
                    {"id": "ERS", "name": "Ernakulam South", "lat": 9.9718, "lon": 76.2847},
                    {"id": "TCR", "name": "Thrissur", "lat": 10.5276, "lon": 76.2144},
                    {"id": "SRR", "name": "Shoranur", "lat": 10.7614, "lon": 76.2711},
                    {"id": "PGT", "name": "Palakkad", "lat": 10.7867, "lon": 76.6548},
                    {"id": "CBE", "name": "Coimbatore", "lat": 11.0168, "lon": 76.9558},
                    {"id": "TUP", "name": "Tiruppur", "lat": 11.1085, "lon": 77.3411},
                    {"id": "ED", "name": "Erode", "lat": 11.3410, "lon": 77.7172},
                    {"id": "SA", "name": "Salem", "lat": 11.6643, "lon": 78.1460},
                    {"id": "BWT", "name": "Bangarapet", "lat": 12.9904, "lon": 78.1719},
                    {"id": "SBC", "name": "Bangalore City", "lat": 12.9716, "lon": 77.5946},
                    {"id": "YPR", "name": "Yesvantpur", "lat": 13.0284, "lon": 77.5043},
                    {"id": "TK", "name": "Tumkur", "lat": 13.3379, "lon": 77.1027},
                    {"id": "ASK", "name": "Arsikere", "lat": 13.3147, "lon": 76.2567},
                    {"id": "DVG", "name": "Davangere", "lat": 14.4644, "lon": 75.9167},
                    {"id": "BGM", "name": "Belagavi", "lat": 15.8497, "lon": 74.4977},
                    
                    // South Central Railway Zone
                    {"id": "SC", "name": "Secunderabad", "lat": 17.4399, "lon": 78.5010},
                    {"id": "HYB", "name": "Hyderabad Deccan", "lat": 17.3850, "lon": 78.4867},
                    {"id": "KCG", "name": "Kacheguda", "lat": 17.3753, "lon": 78.4744},
                    {"id": "BMT", "name": "Begumpet", "lat": 17.4399, "lon": 78.4399},
                    {"id": "WL", "name": "Warangal", "lat": 17.9669, "lon": 79.5941},
                    {"id": "RU", "name": "Renigunta", "lat": 13.6288, "lon": 79.5130},
                    {"id": "TPTY", "name": "Tirupati", "lat": 13.6288, "lon": 79.4192},
                    {"id": "GDR", "name": "Gudur", "lat": 14.1543, "lon": 79.8507},
                    {"id": "NLR", "name": "Nellore", "lat": 14.4426, "lon": 79.9865},
                    {"id": "OGL", "name": "Ongole", "lat": 15.5057, "lon": 80.0499},
                    {"id": "CLX", "name": "Chirala", "lat": 15.8267, "lon": 80.3528},
                    {"id": "TEL", "name": "Tenali", "lat": 16.2428, "lon": 80.6514},
                    {"id": "GNT", "name": "Guntur", "lat": 16.3067, "lon": 80.4365},
                    
                    // North Eastern Railway Zone
                    {"id": "LKO", "name": "Lucknow", "lat": 26.8393, "lon": 80.9231},
                    {"id": "GKP", "name": "Gorakhpur", "lat": 26.7606, "lon": 83.3732},
                    {"id": "CPR", "name": "Chhapra", "lat": 25.7890, "lon": 84.0174},
                    {"id": "SV", "name": "Siwan", "lat": 26.2183, "lon": 84.3616},
                    {"id": "GD", "name": "Gonda", "lat": 27.1404, "lon": 81.9784},
                    {"id": "FD", "name": "Faizabad", "lat": 26.7751, "lon": 82.1382},
                    {"id": "AY", "name": "Ayodhya", "lat": 26.7751, "lon": 82.1382},
                    {"id": "BSB", "name": "Varanasi", "lat": 25.3176, "lon": 82.9739},
                    {"id": "MGS", "name": "Mughal Sarai", "lat": 25.2916, "lon": 83.1216},
                    {"id": "ARJ", "name": "Aunrihar", "lat": 25.4378, "lon": 83.6017},
                    {"id": "GCT", "name": "Ghazipur City", "lat": 25.5881, "lon": 83.5775},
                    {"id": "MAU", "name": "Mau", "lat": 25.9417, "lon": 83.5611},
                    {"id": "IAA", "name": "Indara", "lat": 26.0394, "lon": 83.6281},
                    
                    // East Coast Railway Zone
                    {"id": "BHC", "name": "Bhadrakh", "lat": 21.0543, "lon": 86.5025},
                    {"id": "BLS", "name": "Balasore", "lat": 21.4942, "lon": 86.9320},
                    {"id": "JER", "name": "Jaleswar", "lat": 21.4017, "lon": 87.2211},
                    {"id": "HIJ", "name": "Hijilli", "lat": 22.2833, "lon": 87.3000},
                    {"id": "MDN", "name": "Midnapore", "lat": 22.4249, "lon": 87.3190},
                    {"id": "DVD", "name": "Duvvada", "lat": 17.6844, "lon": 83.2042},
                    {"id": "AKP", "name": "Anakapalle", "lat": 17.6911, "lon": 83.0036},
                    {"id": "TUNI", "name": "Tuni", "lat": 17.3500, "lon": 82.5500},
                    
                    // West Central Railway Zone
                    {"id": "JBP", "name": "Jabalpur", "lat": 23.1815, "lon": 79.9864},
                    {"id": "KTE", "name": "Katni", "lat": 23.8367, "lon": 80.3942},
                    {"id": "STA", "name": "Satna", "lat": 24.5667, "lon": 80.8167},
                    {"id": "MKP", "name": "Manikpur", "lat": 25.2957, "lon": 81.0350},
                    {"id": "COI", "name": "Chheoki", "lat": 25.1342, "lon": 81.8439},
                    {"id": "ALD", "name": "Allahabad", "lat": 25.4358, "lon": 81.8463},
                    {"id": "SRJ", "name": "Shankargarh", "lat": 25.1833, "lon": 81.6167},
                    {"id": "MZP", "name": "Mirzapur", "lat": 25.1467, "lon": 82.5698},
                    {"id": "BDL", "name": "Vindhyachal", "lat": 25.1667, "lon": 82.6500},
                    {"id": "MOF", "name": "Mondh", "lat": 25.2000, "lon": 82.7000},
                    
                    // North Central Railway Zone
                    {"id": "ALJN", "name": "Aligarh Junction", "lat": 27.8906, "lon": 78.0880},
                    {"id": "TDL", "name": "Tundla", "lat": 27.2167, "lon": 78.2833},
                    {"id": "ETW", "name": "Etawah", "lat": 26.7605, "lon": 79.0147},
                    {"id": "CNB", "name": "Kanpur Central", "lat": 26.4499, "lon": 80.3319},
                    {"id": "ON", "name": "Unnao", "lat": 26.5464, "lon": 80.4984},
                    {"id": "LJN", "name": "Lucknow Junction", "lat": 26.8393, "lon": 80.9231},
                    {"id": "BE", "name": "Bareilly", "lat": 28.3670, "lon": 79.4304},
                    {"id": "MB", "name": "Moradabad", "lat": 28.8386, "lon": 78.7733},
                    {"id": "GZB", "name": "Ghaziabad", "lat": 28.6692, "lon": 77.4538},
                    {"id": "MTC", "name": "Meerut City", "lat": 28.9845, "lon": 77.7064}
                ],
                tracks: [
                    // Golden Quadrilateral - Main trunk routes
                    // Delhi-Mumbai via Jaipur-Ajmer route
                    {"id": "DLI-GZB", "from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "GZB", "lat": 28.6692, "lon": 77.4538}, "distance": 25, "max_speed": 160, "type": "main"},
                    {"id": "GZB-MB", "from": {"id": "GZB", "lat": 28.6692, "lon": 77.4538}, "to": {"id": "MB", "lat": 28.8386, "lon": 78.7733}, "distance": 140, "max_speed": 130, "type": "main"},
                    {"id": "MB-BE", "from": {"id": "MB", "lat": 28.8386, "lon": 78.7733}, "to": {"id": "BE", "lat": 28.3670, "lon": 79.4304}, "distance": 90, "max_speed": 120, "type": "main"},
                    {"id": "BE-LKO", "from": {"id": "BE", "lat": 28.3670, "lon": 79.4304}, "to": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}, "distance": 250, "max_speed": 110, "type": "main"},
                    {"id": "LKO-CNB", "from": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}, "to": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}, "distance": 75, "max_speed": 130, "type": "main"},
                    {"id": "CNB-JHS", "from": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}, "to": {"id": "JHS", "lat": 25.4484, "lon": 78.5685}, "distance": 295, "max_speed": 130, "type": "main"},
                    {"id": "JHS-BPL", "from": {"id": "JHS", "lat": 25.4484, "lon": 78.5685}, "to": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}, "distance": 180, "max_speed": 130, "type": "main"},
                    {"id": "BPL-NGP", "from": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}, "to": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}, "distance": 350, "max_speed": 120, "type": "main"},
                    {"id": "NGP-BSL", "from": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}, "to": {"id": "BSL", "lat": 21.0542, "lon": 75.7849}, "distance": 140, "max_speed": 110, "type": "main"},
                    {"id": "BSL-MMR", "from": {"id": "BSL", "lat": 21.0542, "lon": 75.7849}, "to": {"id": "MMR", "lat": 20.2437, "lon": 74.4378}, "distance": 65, "max_speed": 100, "type": "main"},
                    {"id": "MMR-KYN", "from": {"id": "MMR", "lat": 20.2437, "lon": 74.4378}, "to": {"id": "KYN", "lat": 19.2437, "lon": 73.1305}, "distance": 180, "max_speed": 100, "type": "main"},
                    {"id": "KYN-BCT", "from": {"id": "KYN", "lat": 19.2437, "lon": 73.1305}, "to": {"id": "BCT", "lat": 19.0176, "lon": 72.8562}, "distance": 54, "max_speed": 80, "type": "suburban"},
                    
                    // Delhi-Mumbai via Kota-Ratlam route  
                    {"id": "DLI-JP", "from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "JP", "lat": 26.9196, "lon": 75.7878}, "distance": 308, "max_speed": 130, "type": "main"},
                    {"id": "JP-AII", "from": {"id": "JP", "lat": 26.9196, "lon": 75.7878}, "to": {"id": "AII", "lat": 26.4499, "lon": 74.6399}, "distance": 135, "max_speed": 110, "type": "main"},
                    {"id": "AII-KTA", "from": {"id": "AII", "lat": 26.4499, "lon": 74.6399}, "to": {"id": "KTA", "lat": 25.2138, "lon": 75.8648}, "distance": 195, "max_speed": 130, "type": "main"},
                    {"id": "KTA-RTM", "from": {"id": "KTA", "lat": 25.2138, "lon": 75.8648}, "to": {"id": "RTM", "lat": 23.3315, "lon": 75.0367}, "distance": 108, "max_speed": 120, "type": "main"},
                    {"id": "RTM-UJN", "from": {"id": "RTM", "lat": 23.3315, "lon": 75.0367}, "to": {"id": "UJN", "lat": 23.1765, "lon": 75.7885}, "distance": 90, "max_speed": 100, "type": "main"},
                    {"id": "UJN-BPL", "from": {"id": "UJN", "lat": 23.1765, "lon": 75.7885}, "to": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}, "distance": 185, "max_speed": 110, "type": "main"},
                    
                    // Delhi-Chennai main line
                    {"from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "AGR", "lat": 27.1767, "lon": 78.0081}},
                    {"from": {"id": "AGR", "lat": 27.1767, "lon": 78.0081}, "to": {"id": "GWL", "lat": 26.2183, "lon": 78.1828}},
                    {"from": {"id": "GWL", "lat": 26.2183, "lon": 78.1828}, "to": {"id": "JHS", "lat": 25.4484, "lon": 78.5685}},
                    {"from": {"id": "JHS", "lat": 25.4484, "lon": 78.5685}, "to": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}},
                    {"from": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}, "to": {"id": "JBP", "lat": 23.1815, "lon": 79.9864}},
                    {"from": {"id": "JBP", "lat": 23.1815, "lon": 79.9864}, "to": {"id": "KTE", "lat": 23.8367, "lon": 80.3942}},
                    {"from": {"id": "KTE", "lat": 23.8367, "lon": 80.3942}, "to": {"id": "STA", "lat": 24.5667, "lon": 80.8167}},
                    {"from": {"id": "STA", "lat": 24.5667, "lon": 80.8167}, "to": {"id": "ALD", "lat": 25.4358, "lon": 81.8463}},
                    {"from": {"id": "ALD", "lat": 25.4358, "lon": 81.8463}, "to": {"id": "MGS", "lat": 25.2916, "lon": 83.1216}},
                    {"from": {"id": "MGS", "lat": 25.2916, "lon": 83.1216}, "to": {"id": "SC", "lat": 17.4399, "lon": 78.5010}},
                    {"from": {"id": "SC", "lat": 17.4399, "lon": 78.5010}, "to": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}},
                    {"from": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}, "to": {"id": "MAS", "lat": 13.0827, "lon": 80.2707}},
                    
                    // Delhi-Kolkata main line
                    {"from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}},
                    {"from": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}, "to": {"id": "ALD", "lat": 25.4358, "lon": 81.8463}},
                    {"from": {"id": "ALD", "lat": 25.4358, "lon": 81.8463}, "to": {"id": "BSB", "lat": 25.3176, "lon": 82.9739}},
                    {"from": {"id": "BSB", "lat": 25.3176, "lon": 82.9739}, "to": {"id": "MGS", "lat": 25.2916, "lon": 83.1216}},
                    {"from": {"id": "MGS", "lat": 25.2916, "lon": 83.1216}, "to": {"id": "GKP", "lat": 26.7606, "lon": 83.3732}},
                    {"from": {"id": "GKP", "lat": 26.7606, "lon": 83.3732}, "to": {"id": "CPR", "lat": 25.7890, "lon": 84.0174}},
                    {"from": {"id": "CPR", "lat": 25.7890, "lon": 84.0174}, "to": {"id": "HWH", "lat": 22.5848, "lon": 88.3426}},
                    
                    // Mumbai-Chennai via Pune
                    {"from": {"id": "BCT", "lat": 19.0176, "lon": 72.8562}, "to": {"id": "PUNE", "lat": 18.5204, "lon": 73.8567}},
                    {"from": {"id": "PUNE", "lat": 18.5204, "lon": 73.8567}, "to": {"id": "SUR", "lat": 17.6599, "lon": 75.9064}},
                    {"from": {"id": "SUR", "lat": 17.6599, "lon": 75.9064}, "to": {"id": "UBL", "lat": 15.3647, "lon": 75.1240}},
                    {"from": {"id": "UBL", "lat": 15.3647, "lon": 75.1240}, "to": {"id": "SBC", "lat": 12.9716, "lon": 77.5946}},
                    {"from": {"id": "SBC", "lat": 12.9716, "lon": 77.5946}, "to": {"id": "SA", "lat": 11.6643, "lon": 78.1460}},
                    {"from": {"id": "SA", "lat": 11.6643, "lon": 78.1460}, "to": {"id": "ED", "lat": 11.3410, "lon": 77.7172}},
                    {"from": {"id": "ED", "lat": 11.3410, "lon": 77.7172}, "to": {"id": "CBE", "lat": 11.0168, "lon": 76.9558}},
                    {"from": {"id": "CBE", "lat": 11.0168, "lon": 76.9558}, "to": {"id": "TPJ", "lat": 10.7905, "lon": 78.7047}},
                    {"from": {"id": "TPJ", "lat": 10.7905, "lon": 78.7047}, "to": {"id": "MAS", "lat": 13.0827, "lon": 80.2707}},
                    
                    // Mumbai-Kolkata via Nagpur
                    {"from": {"id": "BCT", "lat": 19.0176, "lon": 72.8562}, "to": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}},
                    {"from": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}, "to": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}},
                    {"from": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}, "to": {"id": "VSKP", "lat": 17.7231, "lon": 83.3219}},
                    {"from": {"id": "VSKP", "lat": 17.7231, "lon": 83.3219}, "to": {"id": "BBS", "lat": 20.2961, "lon": 85.8245}},
                    {"from": {"id": "BBS", "lat": 20.2961, "lon": 85.8245}, "to": {"id": "HWH", "lat": 22.5848, "lon": 88.3426}},
                    
                    // Southern Peninsula routes
                    {"from": {"id": "MAS", "lat": 13.0827, "lon": 80.2707}, "to": {"id": "SBC", "lat": 12.9716, "lon": 77.5946}},
                    {"from": {"id": "MAS", "lat": 13.0827, "lon": 80.2707}, "to": {"id": "TVC", "lat": 8.4875, "lon": 76.9525}},
                    {"from": {"id": "TVC", "lat": 8.4875, "lon": 76.9525}, "to": {"id": "ERS", "lat": 9.9718, "lon": 76.2847}},
                    {"from": {"id": "ERS", "lat": 9.9718, "lon": 76.2847}, "to": {"id": "CBE", "lat": 11.0168, "lon": 76.9558}},
                    {"from": {"id": "SBC", "lat": 12.9716, "lon": 77.5946}, "to": {"id": "HYB", "lat": 17.3850, "lon": 78.4867}},
                    {"from": {"id": "HYB", "lat": 17.3850, "lon": 78.4867}, "to": {"id": "SC", "lat": 17.4399, "lon": 78.5010}},
                    
                    // Eastern routes
                    {"from": {"id": "HWH", "lat": 22.5848, "lon": 88.3426}, "to": {"id": "BBS", "lat": 20.2961, "lon": 85.8245}},
                    {"from": {"id": "BBS", "lat": 20.2961, "lon": 85.8245}, "to": {"id": "PURI", "lat": 19.8135, "lon": 85.8312}},
                    {"from": {"id": "HWH", "lat": 22.5848, "lon": 88.3426}, "to": {"id": "KGP", "lat": 22.3460, "lon": 87.3197}},
                    {"from": {"id": "KGP", "lat": 22.3460, "lon": 87.3197}, "to": {"id": "VSKP", "lat": 17.7231, "lon": 83.3219}},
                    
                    // Western routes  
                    {"from": {"id": "BCT", "lat": 19.0176, "lon": 72.8562}, "to": {"id": "CSMT", "lat": 18.9398, "lon": 72.8355}},
                    {"from": {"id": "CSMT", "lat": 18.9398, "lon": 72.8355}, "to": {"id": "THA", "lat": 19.1972, "lon": 72.9702}},
                    {"from": {"id": "THA", "lat": 19.1972, "lon": 72.9702}, "to": {"id": "KYN", "lat": 19.2437, "lon": 73.1305}},
                    {"from": {"id": "BCT", "lat": 19.0176, "lon": 72.8562}, "to": {"id": "AII", "lat": 26.4499, "lon": 74.6399}},
                    {"from": {"id": "AII", "lat": 26.4499, "lon": 74.6399}, "to": {"id": "JU", "lat": 26.2389, "lon": 73.0243}},
                    
                    // Northern routes
                    {"from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "BIKANER", "lat": 28.0229, "lon": 73.3119}},
                    {"from": {"id": "JP", "lat": 26.9196, "lon": 75.7878}, "to": {"id": "BIKANER", "lat": 28.0229, "lon": 73.3119}},
                    {"from": {"id": "DLI", "lat": 28.6448, "lon": 77.2194}, "to": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}},
                    {"from": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}, "to": {"id": "GKP", "lat": 26.7606, "lon": 83.3732}},
                    
                    // North Eastern routes
                    {"from": {"id": "GKP", "lat": 26.7606, "lon": 83.3732}, "to": {"id": "GD", "lat": 27.1404, "lon": 81.9784}},
                    {"from": {"id": "GD", "lat": 27.1404, "lon": 81.9784}, "to": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}},
                    {"from": {"id": "LKO", "lat": 26.8393, "lon": 80.9231}, "to": {"id": "FD", "lat": 26.7751, "lon": 82.1382}},
                    {"from": {"id": "FD", "lat": 26.7751, "lon": 82.1382}, "to": {"id": "BSB", "lat": 25.3176, "lon": 82.9739}},
                    
                    // South Central routes
                    {"from": {"id": "SC", "lat": 17.4399, "lon": 78.5010}, "to": {"id": "WL", "lat": 17.9669, "lon": 79.5941}},
                    {"from": {"id": "WL", "lat": 17.9669, "lon": 79.5941}, "to": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}},
                    {"from": {"id": "BZA", "lat": 16.5062, "lon": 80.6480}, "to": {"id": "RU", "lat": 13.6288, "lon": 79.5130}},
                    {"from": {"id": "RU", "lat": 13.6288, "lon": 79.5130}, "to": {"id": "TPTY", "lat": 13.6288, "lon": 79.4192}},
                    {"from": {"id": "RU", "lat": 13.6288, "lon": 79.5130}, "to": {"id": "MAS", "lat": 13.0827, "lon": 80.2707}},
                    
                    // Additional important connections
                    {"from": {"id": "PUNE", "lat": 18.5204, "lon": 73.8567}, "to": {"id": "SBC", "lat": 12.9716, "lon": 77.5946}},
                    {"from": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}, "to": {"id": "HYB", "lat": 17.3850, "lon": 78.4867}},
                    {"from": {"id": "BPL", "lat": 23.2599, "lon": 77.4126}, "to": {"id": "UJN", "lat": 23.1765, "lon": 75.7885}},
                    {"from": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}, "to": {"id": "LJN", "lat": 26.8393, "lon": 80.9231}},
                    {"from": {"id": "ALJN", "lat": 27.8906, "lon": 78.0880}, "to": {"id": "CNB", "lat": 26.4499, "lon": 80.3319}},
                    {"from": {"id": "AGR", "lat": 27.1767, "lon": 78.0081}, "to": {"id": "ALJN", "lat": 27.8906, "lon": 78.0880}},
                    {"from": {"id": "JBP", "lat": 23.1815, "lon": 79.9864}, "to": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}},
                    {"from": {"id": "KTE", "lat": 23.8367, "lon": 80.3942}, "to": {"id": "NGP", "lat": 21.1458, "lon": 79.0882}}
                ],
                trains: allTrains,
                collisions: [],
                rerouting: [],
                timestamp: new Date().toISOString()
            };
            
            // Add elements to map
            addStationsToMap();
            addTracksToMap();
            addTrainsToMap();
            addTrainPathVisualization();
            
            // Update real-time data display
            updateRealTimeDataDisplay();
            
            // Start simulated real-time updates (mimics local backend)
            startSimulatedRealTimeUpdates();
            
            // Populate station dropdown
            populateStationDropdown();
            
            updateStatus('✅ Fallback data loaded successfully');
            console.log('✅ Fallback data loaded');
        }

        // Add stations to map
        function addStationsToMap() {
            if (!mapData || !mapData.stations) return;
            
            console.log('🚉 Adding stations to map...');
            
            mapData.stations.forEach(station => {
                const stationMarker = L.marker([station.lat, station.lon], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: '🚉',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                stationMarker.bindPopup(`
                    <div class="station-popup">
                        <h4>${station.name}</h4>
                        <p><strong>Code:</strong> ${station.id}</p>
                        <p><strong>Type:</strong> ${station.type}</p>
                        <p><strong>Platforms:</strong> ${station.platforms}</p>
                    </div>
                `);
                
                stationMarkers.push(stationMarker);
            });
            
            console.log(`✅ Added ${mapData.stations.length} stations to map`);
        }

        // Add tracks to map
        function addTracksToMap() {
            if (!mapData || !mapData.tracks) return;
            
            console.log('🛤️ Adding tracks to map...');
            
            mapData.tracks.forEach(track => {
                const trackLine = L.polyline([
                    [track.from.lat, track.from.lon],
                    [track.to.lat, track.to.lon]
                ], {
                    color: '#1e40af',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 5'
                }).addTo(map);
                
                trackLine.bindPopup(`
                    <div class="track-popup">
                        <h4>Track ${track.id}</h4>
                        <p><strong>Distance:</strong> ${track.distance} km</p>
                        <p><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                        <p><strong>Type:</strong> ${track.type}</p>
                    </div>
                `);
                
                trackLines.push(trackLine);
            });
            
            console.log(`✅ Added ${mapData.tracks.length} tracks to map`);
        }

        // Add trains to map
        function addTrainsToMap() {
            if (!mapData || !mapData.trains) return;
            
            console.log('🚂 Adding trains to map...');
            
            mapData.trains.forEach(train => {
                // Calculate initial position on track
                const trackPosition = calculateTrainPositionOnTrack(train);
                
                const trainMarker = L.marker([trackPosition.lat, trackPosition.lon], {
                    icon: L.divIcon({
                        className: 'train-marker',
                        html: getTrainIcon(train),
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                trainMarker.bindPopup(`
                    <div class="train-popup">
                        <h4>${train.train_number} - ${train.train_type}</h4>
                        <p><strong>Speed:</strong> ${train.speed} km/h</p>
                        <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                        <p><strong>Status:</strong> ${train.status}</p>
                        <p><strong>Route:</strong> ${train.origin} → ${train.destination}</p>
                        <p><strong>Current:</strong> ${train.current_station}</p>
                        <p><strong>Next:</strong> ${train.next_station}</p>
                        ${train.collision_risk ? '<p style="color: red;"><strong>⚠️ Collision Risk!</strong></p>' : ''}
                        ${train.rerouting_needed ? '<p style="color: orange;"><strong>🔄 Rerouting Needed</strong></p>' : ''}
                    </div>
                `);
                
                trainMarker.trainNumber = train.train_number;
                trainMarkers.push(trainMarker);
            });
            
            console.log(`✅ Added ${mapData.trains.length} trains to map`);
        }
        
        // Add train path visualization
        function addTrainPathVisualization() {
            if (!mapData || !mapData.trains) return;
            
            console.log('🛤️ Adding train path visualization...');
            
            mapData.trains.forEach(train => {
                const track = findTrainTrack(train);
                if (track) {
                    // Create a path line showing the train's route
                    const pathLine = L.polyline([
                        [track.from.lat, track.from.lon],
                        [track.to.lat, track.to.lon]
                    ], {
                        color: '#ff6b35',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    // Add to train markers for cleanup
                    const trainMarker = trainMarkers.find(m => m.trainNumber === train.train_number);
                    if (trainMarker) {
                        trainMarker.pathLine = pathLine;
                    }
                }
            });
            
            console.log('✅ Added train path visualization');
        }

        // Get train icon with enhanced visibility
        function getTrainIcon(train) {
            const isMoving = train.speed > 0;
            const direction = getTrainDirection(train);
            
            return `
                <div class="train-icon-container" style="position: relative;">
                    <span class="train-emoji" style="font-size: 16px; color: #1e40af; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); display: block;">
                        🚂
                    </span>
                    ${isMoving ? `<div class="movement-indicator" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 1s infinite;"></div>` : ''}
                    ${direction ? `<div class="direction-arrow" style="position: absolute; top: 50%; left: -10px; transform: translateY(-50%); font-size: 12px; color: #1e40af;">${direction}</div>` : ''}
                </div>
            `;
        }
        
        // Get train direction arrow
        function getTrainDirection(train) {
            if (!train.current_station || !train.next_station) return '';
            
            // Simple direction based on station names (you can enhance this)
            const current = train.current_station.toLowerCase();
            const next = train.next_station.toLowerCase();
            
            // Basic directional logic
            if (current.includes('north') || current.includes('delhi')) return '→';
            if (current.includes('south') || current.includes('chennai')) return '←';
            if (current.includes('east') || current.includes('kolkata')) return '↑';
            if (current.includes('west') || current.includes('mumbai')) return '↓';
            
            return '→'; // Default right arrow
        }

        // Calculate train position on track with spacing to avoid overlaps
        function calculateTrainPositionOnTrack(train) {
            if (!mapData || !mapData.tracks) return { lat: train.lat, lon: train.lon };
            
            // Find the track the train is currently on
            const currentTrack = findTrainTrack(train);
            if (!currentTrack) return { lat: train.lat, lon: train.lon };
            
            // Calculate position based on progress along the track
            const progress = train.progress || 0;
            const fromLat = currentTrack.from.lat;
            const fromLon = currentTrack.from.lon;
            const toLat = currentTrack.to.lat;
            const toLon = currentTrack.to.lon;
            
            // Interpolate position along the track
            let lat = fromLat + (toLat - fromLat) * progress;
            let lon = fromLon + (toLon - fromLon) * progress;
            
            // Add spacing to prevent overlapping trains
            const spacingOffset = calculateTrainSpacing(train, currentTrack);
            lat += spacingOffset.lat;
            lon += spacingOffset.lon;
            
            return { lat, lon };
        }
        
        // Calculate spacing offset to prevent train overlaps
        function calculateTrainSpacing(train, track) {
            if (!mapData || !mapData.trains) return { lat: 0, lon: 0 };
            
            // Find all trains on the same track
            const trainsOnSameTrack = mapData.trains.filter(otherTrain => {
                if (otherTrain.train_number === train.train_number) return false;
                const otherTrack = findTrainTrack(otherTrain);
                return otherTrack && 
                       ((track.from.id === otherTrack.from.id && track.to.id === otherTrack.to.id) ||
                        (track.from.id === otherTrack.to.id && track.to.id === otherTrack.from.id));
            });
            
            // Calculate offset based on train number and progress to create better spacing
            const trainIndex = mapData.trains.findIndex(t => t.train_number === train.train_number);
            const progress = train.progress || 0;
            
            // Create a more distributed spacing pattern
            const spacingPattern = [
                { lat: 0, lon: 0 },           // Center
                { lat: 0.0008, lon: 0.0008 }, // Top-right
                { lat: -0.0008, lon: 0.0008 }, // Bottom-right
                { lat: 0.0008, lon: -0.0008 }, // Top-left
                { lat: -0.0008, lon: -0.0008 }, // Bottom-left
                { lat: 0.0012, lon: 0 },      // Right
                { lat: -0.0012, lon: 0 },     // Left
                { lat: 0, lon: 0.0012 },      // Top
                { lat: 0, lon: -0.0012 }      // Bottom
            ];
            
            const patternIndex = trainIndex % spacingPattern.length;
            const baseOffset = spacingPattern[patternIndex];
            
            // Add slight variation based on progress to avoid static positioning
            const progressVariation = Math.sin(progress * Math.PI * 4) * 0.0002;
            
            return { 
                lat: baseOffset.lat + progressVariation, 
                lon: baseOffset.lon + progressVariation 
            };
        }
        
        // Find which track a train is currently on
        function findTrainTrack(train) {
            if (!mapData || !mapData.tracks) return null;
            
            // Try to find track based on current and next station
            const currentStation = train.current_station;
            const nextStation = train.next_station;
            
            // First, try to find a track that connects the current and next stations
            let track = mapData.tracks.find(t => {
                // Get station coordinates for comparison
                const fromStation = mapData.stations.find(s => s.id === t.from.id);
                const toStation = mapData.stations.find(s => s.id === t.to.id);
                
                if (!fromStation || !toStation) return false;
                
                // Check if this track connects current and next stations
                return (fromStation.id === currentStation && toStation.id === nextStation) ||
                       (toStation.id === currentStation && fromStation.id === nextStation);
            });
            
            // If not found, try to find any track involving current station
            if (!track) {
                track = mapData.tracks.find(t => {
                    const fromStation = mapData.stations.find(s => s.id === t.from.id);
                    const toStation = mapData.stations.find(s => s.id === t.to.id);
                    
                    if (!fromStation || !toStation) return false;
                    
                    return fromStation.id === currentStation || toStation.id === currentStation;
                });
            }
            
            // If still not found, try to find track based on train's origin and destination
            if (!track) {
                track = mapData.tracks.find(t => {
                    const fromStation = mapData.stations.find(s => s.id === t.from.id);
                    const toStation = mapData.stations.find(s => s.id === t.to.id);
                    
                    if (!fromStation || !toStation) return false;
                    
                    return (fromStation.id === train.origin && toStation.id === train.destination) ||
                           (toStation.id === train.origin && fromStation.id === train.destination);
                });
            }
            
            // If still not found, use a default track (first available)
            if (!track && mapData.tracks.length > 0) {
                track = mapData.tracks[0];
            }
            
            return track;
        }
        
        // Update train positions with enhanced movement
        function updateTrainPositions() {
            if (!mapData || !mapData.trains) return;
            
            mapData.trains.forEach(train => {
                const marker = trainMarkers.find(m => m.trainNumber === train.train_number);
                if (marker) {
                    // Calculate position on track
                    const trackPosition = calculateTrainPositionOnTrack(train);
                    
                    // Get current position
                    const currentPos = marker.getLatLng();
                    const newPos = [trackPosition.lat, trackPosition.lon];
                    
                    // Calculate distance moved
                    const distance = currentPos.distanceTo(newPos);
                    
                    // Enhanced animation based on movement
                    if (distance > 0.001) { // Only animate if train actually moved
                        // Smooth animation with longer duration for visible movement
                        marker.setLatLng(newPos, { 
                            animate: true, 
                            duration: Math.min(2.0, Math.max(0.5, distance * 1000)) // Dynamic duration based on distance
                        });
                        
                        // Add movement trail effect
                        addMovementTrail(currentPos, newPos, train.train_number);
                        
                        console.log(`🚂 Train ${train.train_number} moving: ${distance.toFixed(4)}km`);
                    }
                    
                    // Update popup with fresh data
                    marker.bindPopup(`
                        <div class="train-popup">
                            <h4>${train.train_number} - ${train.train_type}</h4>
                            <p><strong>Speed:</strong> ${train.speed} km/h</p>
                            <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                            <p><strong>Status:</strong> ${train.status}</p>
                            <p><strong>Route:</strong> ${train.origin} → ${train.destination}</p>
                            <p><strong>Current:</strong> ${train.current_station}</p>
                            <p><strong>Next:</strong> ${train.next_station}</p>
                            <p><strong>Movement:</strong> ${distance > 0.001 ? 'Moving' : 'Stationary'}</p>
                            ${train.collision_risk ? '<p style="color: red;"><strong>⚠️ Collision Risk!</strong></p>' : ''}
                            ${train.rerouting_needed ? '<p style="color: orange;"><strong>🔄 Rerouting Needed</strong></p>' : ''}
                        </div>
                    `);
                    
                    // Enhanced visual effects
                    const element = marker.getElement();
                    if (train.collision_risk) {
                        element.style.animation = 'train-alert 1s infinite';
                        element.style.filter = 'hue-rotate(0deg) brightness(1.3)';
                        // Voice alert for collision risk
                        if (voiceAlertsEnabled) {
                            speakAlert(`Collision risk detected for train ${train.train_number} ${train.train_name}`);
                        }
                    } else if (train.rerouting_needed) {
                        element.style.animation = 'train-warning 1s infinite';
                        element.style.filter = 'hue-rotate(30deg) brightness(1.2)';
                        // Voice alert for rerouting
                        if (voiceAlertsEnabled) {
                            speakAlert(`Rerouting needed for train ${train.train_number} ${train.train_name}`);
                        }
                    } else {
                        // Enhanced movement animation
                        if (distance > 0.001) {
                            element.style.animation = 'train-move-fast 1s infinite';
                            element.style.filter = 'brightness(1.1)';
                        } else {
                            element.style.animation = 'train-move 2s infinite';
                            element.style.filter = 'brightness(1)';
                        }
                    }
                }
            });
        }
        
        // Add movement trail effect
        function addMovementTrail(fromPos, toPos, trainNumber) {
            // Create a temporary trail line
            const trail = L.polyline([fromPos, toPos], {
                color: '#ff6b35',
                weight: 1,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            
            // Remove trail after animation
            setTimeout(() => {
                map.removeLayer(trail);
            }, 2000);
        }

        // Simulated real-time updates (mimics local backend behavior)
        function startSimulatedRealTimeUpdates() {
            if (window.simulatedUpdateInterval) {
                clearInterval(window.simulatedUpdateInterval);
            }
            
            console.log('🔄 Starting simulated real-time updates...');
            
            // Update every 3 seconds (same as local backend)
            window.simulatedUpdateInterval = setInterval(() => {
                if (!mapData || !mapData.trains) return;
                
                // Track previous states for voice alerts
                const previousStates = mapData.trains.map(train => ({
                    id: train.id,
                    collision_risk: train.collision_risk,
                    rerouting_needed: train.rerouting_needed,
                    delay_minutes: train.delay_minutes,
                    progress: train.progress
                }));
                
                // Simulate train movement and updates
                mapData.trains.forEach(train => {
                    // Simulate progress changes
                    train.progress = Math.min(1.0, train.progress + Math.random() * 0.1);
                    
                    // Simulate speed variations
                    train.speed = Math.max(80, Math.min(160, train.speed + (Math.random() - 0.5) * 10));
                    
                    // Simulate delay changes
                    train.delay_minutes = Math.max(0, train.delay_minutes + (Math.random() - 0.7) * 2);
                    
                    // Simulate collision risks and rerouting
                    if (Math.random() < 0.05) { // 5% chance
                        train.collision_risk = Math.random() < 0.5;
                        train.rerouting_needed = Math.random() < 0.3;
                    }
                    
                    // Clear events after some time
                    if (Math.random() < 0.1) {
                        train.collision_risk = false;
                        train.rerouting_needed = false;
                    }
                    
                    // Update timestamp
                    mapData.timestamp = new Date().toISOString();
                });
                
                // Voice alerts for state changes
                if (voiceAlertsEnabled) {
                    mapData.trains.forEach((train, index) => {
                        const prev = previousStates[index];
                        
                        // Collision risk alert
                        if (!prev.collision_risk && train.collision_risk) {
                            speakAlert(`Alert! Collision risk detected for train ${train.train_number} ${train.train_name}`);
                        }
                        
                        // Rerouting alert
                        if (!prev.rerouting_needed && train.rerouting_needed) {
                            speakAlert(`Rerouting required for train ${train.train_number} ${train.train_name}`);
                        }
                        
                        // Delay alert
                        if (train.delay_minutes > 10 && prev.delay_minutes <= 10) {
                            speakAlert(`Train ${train.train_number} ${train.train_name} is experiencing significant delays of ${Math.round(train.delay_minutes)} minutes`);
                        }
                        
                        // Station approach alert
                        if (train.progress > 0.9 && prev.progress <= 0.9) {
                            const stationName = getStationName(train.next_station);
                            speakAlert(`Train ${train.train_number} ${train.train_name} approaching ${stationName}`);
                        }
                        
                        // Clear alerts
                        if (prev.collision_risk && !train.collision_risk) {
                            speakAlert(`Collision risk cleared for train ${train.train_number} ${train.train_name}`);
                        }
                        
                        if (prev.rerouting_needed && !train.rerouting_needed) {
                            speakAlert(`Rerouting completed for train ${train.train_number} ${train.train_name}`);
                        }
                    });
                }
                
                // Update the map with new positions
                updateTrainPositions();
                updateRealTimeDataDisplay();
                
                console.log('🔄 Simulated update completed');
            }, 3000); // 3 second intervals
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            realTimeUpdateInterval = setInterval(() => {
                // Fetch fresh data from backend
                fetch('http://localhost:8084/api/map-data')
                    .then(response => response.json())
                    .then(data => {
                        mapData = data;
                        updateTrainPositions();
                        updateRealTimeDataDisplay();
                        console.log('🔄 Real-time update completed');
                    })
                    .catch(error => {
                        console.error('❌ Real-time update error:', error);
                    });
            }, 2000);
        }

        // Update real-time data display
        function updateRealTimeDataDisplay() {
            if (!mapData) return;
            
            document.getElementById('active-trains-count').textContent = mapData.trains.length;
            document.getElementById('total-stations-count').textContent = mapData.stations.length;
            document.getElementById('track-segments-count').textContent = mapData.tracks.length;
            document.getElementById('system-status').textContent = 'Online';
        }

        // Station selection
        function selectStation(stationId = null) {
            // If no stationId provided, try to get from old dropdown (for backward compatibility)
            if (!stationId) {
                const select = document.getElementById('station-select');
                if (select) {
                    stationId = select.value;
                }
            }
            
            if (stationId) {
                const station = mapData.stations.find(s => s.id === stationId);
                if (station) {
                    selectedStation = station;
                    console.log('🎯 Station selected:', station.name, station.id);
                    
                    // Focus map on selected station
                    map.setView([station.lat, station.lon], 12, { animate: false });
                    
                    // Highlight the station on the map
                    highlightStationOnMap(station);
                    
                    // Start monitoring
                    startLiveStationMonitoring(station);
                    
                    updateStatus(`📍 Monitoring station: ${station.name}`);
                    
                    // Voice alert for station selection
                    if (voiceAlertsEnabled) {
                        speakAlert(`Now monitoring station ${station.name}`);
                    }
                } else {
                    console.error('❌ Station not found:', stationId);
                }
            } else {
                clearStationFocus();
            }
        }
        
        // Highlight station on map
        function highlightStationOnMap(station) {
            // Remove existing highlights
            if (window.stationHighlight) {
                map.removeLayer(window.stationHighlight);
            }
            
            // Add highlight marker
            const highlightIcon = L.divIcon({
                className: 'station-highlight-marker',
                html: `<div style="
                    width: 20px;
                    height: 20px;
                    background: #ef4444;
                    border: 3px solid #ffffff;
                    border-radius: 50%;
                    box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
                    animation: pulse 1.5s infinite;
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            window.stationHighlight = L.marker([station.lat, station.lon], {
                icon: highlightIcon,
                zIndexOffset: 1000
            }).addTo(map);
            
            // Add popup with station info
            window.stationHighlight.bindPopup(`
                <div class="station-popup">
                    <h4>📍 ${station.name}</h4>
                    <p><strong>Station ID:</strong> ${station.id}</p>
                    <p><strong>Coordinates:</strong> ${station.lat.toFixed(4)}, ${station.lon.toFixed(4)}</p>
                    <p><strong>Status:</strong> <span class="status-active">Active Monitoring</span></p>
                </div>
            `).openPopup();
        }

        // Start live station monitoring
        function startLiveStationMonitoring(station) {
            document.getElementById('live-station-monitor').style.display = 'block';
            document.getElementById('monitor-station-name').textContent = station.name;
            
            updateLiveStationData(station);
            
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
            
            liveStationMonitorInterval = setInterval(() => {
                updateLiveStationData(station);
            }, 3000);
        }

        // Update live station data
        function updateLiveStationData(station) {
            if (!mapData || !mapData.trains) return;
            
            console.log('🔍 Updating station data for:', station.name, station.id);
            console.log('🚂 Total trains available:', mapData.trains.length);
            
            // Find trains at or approaching this station - improved filtering
            const trainsAtStation = mapData.trains.filter(train => {
                const isAtStation = train.current_station === station.id;
                const isNextStation = train.next_station === station.id;
                const isOrigin = train.origin === station.id;
                const isDestination = train.destination === station.id;
                
                if (isAtStation || isNextStation || isOrigin || isDestination) {
                    console.log(`🚂 Train ${train.train_number} found at ${station.name}:`, {
                        current_station: train.current_station,
                        next_station: train.next_station,
                        origin: train.origin,
                        destination: train.destination,
                        reason: isAtStation ? 'current' : isNextStation ? 'next' : isOrigin ? 'origin' : 'destination'
                    });
                }
                
                return isAtStation || isNextStation || isOrigin || isDestination;
            });
            
            // Find connected tracks
            const connectedTracks = mapData.tracks.filter(track => 
                track.from.lat === station.lat && track.from.lon === station.lon ||
                track.to.lat === station.lat && track.to.lon === station.lon
            );
            
            console.log(`📊 Found ${trainsAtStation.length} trains and ${connectedTracks.length} tracks for ${station.name}`);
            
            // Update display
            document.getElementById('monitor-tracks-count').textContent = connectedTracks.length;
            document.getElementById('monitor-trains-count').textContent = trainsAtStation.length;
            document.getElementById('monitor-status').textContent = 'Active';
            
            // Update trains list
            updateLiveTrainsList(trainsAtStation, connectedTracks);
        }

        // Update live trains list
        function updateLiveTrainsList(trains, tracks) {
            const container = document.getElementById('live-trains-container');
            
            console.log('📋 Updating trains list with:', trains.length, 'trains');
            
            if (trains.length === 0) {
                container.innerHTML = '<div class="no-trains"><p>🚂 No trains at this station</p><p>Try selecting a different station or wait for trains to arrive</p></div>';
                return;
            }
            
            container.innerHTML = trains.map(train => {
                // Determine train location status
                let locationStatus = '';
                if (train.current_station === train.origin) {
                    locationStatus = '🚉 At Origin Station';
                } else if (train.current_station === train.destination) {
                    locationStatus = '🏁 At Destination';
                } else if (train.next_station === train.origin) {
                    locationStatus = '🚂 Approaching Station';
                } else {
                    locationStatus = `🚂 Current: ${train.current_station}`;
                }
                
                return `
                    <div class="train-item">
                        <div class="train-header">
                            <span class="train-number">${train.train_number}</span>
                            <span class="train-name">${train.train_type}</span>
                            <span class="train-status ${train.status.toLowerCase()}">${train.status}</span>
                        </div>
                        <div class="train-details">
                            <div class="train-route">
                                <span class="route-from">${train.origin}</span>
                                <span class="route-arrow">→</span>
                                <span class="route-to">${train.destination}</span>
                            </div>
                            <div class="train-location">
                                <span class="location-text">${locationStatus}</span>
                            </div>
                            <div class="train-metrics">
                                <div class="metric">Speed: ${train.speed} km/h</div>
                                <div class="metric">Progress: ${Math.round(train.progress * 100)}%</div>
                                <div class="metric">Delay: ${train.delay_minutes || 0} min</div>
                            </div>
                            ${train.collision_risk ? '<span class="alert-badge collision">⚠️ Collision Risk</span>' : ''}
                            ${train.rerouting_needed ? '<span class="alert-badge rerouting">🔄 Rerouting Needed</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Close live monitor
        function closeLiveMonitor() {
            document.getElementById('live-station-monitor').style.display = 'none';
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
        }

        // Clear station focus
        function clearStationFocus() {
            selectedStation = null;
            
            // Clear search input
            const searchInput = document.getElementById('station-search');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Remove station highlight from map
            if (window.stationHighlight) {
                map.removeLayer(window.stationHighlight);
                window.stationHighlight = null;
            }
            
            hideDropdown();
            closeLiveMonitor();
            updateStatus('📍 Station monitoring cleared');
        }

        // Populate station dropdown
        function populateStationDropdown() {
            const searchInput = document.getElementById('station-search');
            const dropdownOptions = document.getElementById('station-options');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            dropdownOptions.innerHTML = '';
            
            if (mapData && mapData.stations) {
                let filteredStations = mapData.stations;
                
                // Apply search filter if there's a search term
                if (searchTerm) {
                    filteredStations = mapData.stations.filter(station => 
                        station.name.toLowerCase().includes(searchTerm) ||
                        station.id.toLowerCase().includes(searchTerm)
                    );
                }
                
                filteredStations.forEach(station => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = `${station.name} (${station.id})`;
                    option.onclick = () => selectStationOption(station);
                    dropdownOptions.appendChild(option);
                });
                
                // Show count of filtered results
                if (searchTerm && filteredStations.length === 0) {
                    const noResultsOption = document.createElement('div');
                    noResultsOption.className = 'dropdown-option no-results';
                    noResultsOption.textContent = 'No stations found';
                    dropdownOptions.appendChild(noResultsOption);
                }
            }
        }
        
        // Select station option from dropdown
        function selectStationOption(station) {
            const searchInput = document.getElementById('station-search');
            if (searchInput) {
                searchInput.value = `${station.name} (${station.id})`;
            }
            hideDropdown();
            selectStation(station.id);
        }
        
        // Filter stations based on search input
        function filterStations() {
            populateStationDropdown();
            showDropdown();
        }
        
        // Show dropdown
        function showDropdown() {
            const dropdown = document.getElementById('station-dropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
                populateStationDropdown();
            }
        }
        
        // Hide dropdown
        function hideDropdown() {
            // Add delay to allow click events to fire
            setTimeout(() => {
                const dropdown = document.getElementById('station-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 150);
        }
        
        // Toggle dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('station-dropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none') {
                    showDropdown();
                } else {
                    hideDropdown();
                }
            }
        }

        // Toggle functions
        function toggleFullscreen() {
            if (!isFullscreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                isFullscreen = false;
            }
        }

        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            const btn = document.getElementById('voice-btn');
            btn.textContent = voiceAlertsEnabled ? '🔊 Voice ON' : '🔊 Voice';
            btn.style.backgroundColor = voiceAlertsEnabled ? '#059669' : '';
            
            if (voiceAlertsEnabled) {
                updateStatus('🔊 Voice alerts enabled');
                console.log('🔊 Voice alerts enabled');
                // Test voice synthesis
                speakAlert('Voice alerts are now enabled');
            } else {
                updateStatus('🔇 Voice alerts disabled');
                console.log('🔇 Voice alerts disabled');
                // Stop any ongoing speech
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }
        }
        
        // Voice synthesis function
        function speakAlert(message) {
            if (voiceAlertsEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 0.7;
                speechSynthesis.speak(utterance);
            }
        }
        
        // Helper function to get station name by ID
        function getStationName(stationId) {
            if (!mapData || !mapData.stations) return stationId;
            const station = mapData.stations.find(s => s.id === stationId);
            return station ? station.name : stationId;
        }

        function toggleLiveMovement() {
            liveMovementEnabled = !liveMovementEnabled;
            const btn = document.getElementById('movement-btn');
            btn.textContent = liveMovementEnabled ? '⏸️ Pause' : '▶️ Movement';
            btn.style.backgroundColor = liveMovementEnabled ? '#059669' : '';
            
            if (liveMovementEnabled) {
                // Start real-time updates
                startRealTimeUpdates();
                updateStatus('🚂 Live movement started');
                console.log('🚂 Live movement enabled');
            } else {
                // Stop real-time updates
                if (realTimeUpdateInterval) {
                    clearInterval(realTimeUpdateInterval);
                    realTimeUpdateInterval = null;
                }
                updateStatus('⏸️ Live movement paused');
                console.log('⏸️ Live movement paused');
            }
        }

        

        
        // Refresh train data for trains page
        function refreshTrainData(searchTerm = '', filterType = 'all') {
            console.log('🚂 Refreshing train data...');
            if (!mapData || !mapData.trains) {
                console.log('❌ No map data available');
                return;
            }
            
            const trainsGrid = document.getElementById('trains-grid');
            let trains = mapData.trains;
            
            // Apply search filter
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                trains = trains.filter(train => 
                    train.train_number.toLowerCase().includes(searchLower) ||
                    train.train_type.toLowerCase().includes(searchLower) ||
                    train.origin.toLowerCase().includes(searchLower) ||
                    train.destination.toLowerCase().includes(searchLower) ||
                    train.current_station.toLowerCase().includes(searchLower)
                );
            }
            
            // Apply type filter
            if (filterType !== 'all') {
                trains = trains.filter(train => {
                    switch(filterType) {
                        case 'running':
                            return train.status === 'running' || train.status === 'in_transit';
                        case 'delayed':
                            return train.delay_minutes > 0;
                        case 'on-time':
                            return train.delay_minutes <= 0;
                        case 'rajdhani':
                            return train.train_type.toLowerCase().includes('rajdhani');
                        case 'shatabdi':
                            return train.train_type.toLowerCase().includes('shatabdi');
                        case 'mail':
                            return train.train_type.toLowerCase().includes('mail') || train.train_type.toLowerCase().includes('express');
                        default:
                            return true;
                    }
                });
            }
            
            // Update stats
            const totalTrains = trains.length;
            const runningTrains = trains.filter(t => t.status === 'running' || t.status === 'in_transit').length;
            const delayedTrains = trains.filter(t => t.delay_minutes > 0).length;
            const onTimeTrains = trains.filter(t => t.delay_minutes <= 0).length;
            
            document.getElementById('total-trains').textContent = totalTrains;
            document.getElementById('running-trains').textContent = runningTrains;
            document.getElementById('delayed-trains').textContent = delayedTrains;
            document.getElementById('ontime-trains').textContent = onTimeTrains;
            
            // Generate train cards
            trainsGrid.innerHTML = trains.map(train => `
                <div class="train-card ${train.status}">
                    <div class="train-header">
                        <h4>${train.train_number}</h4>
                        <span class="train-type">${train.train_type}</span>
                        <span class="train-status ${train.status}">${train.status}</span>
                    </div>
                    <div class="train-details">
                        <div class="train-route">
                            <span class="route-label">Route:</span>
                            <span class="route-text">${train.origin} → ${train.destination}</span>
                        </div>
                        <div class="train-location">
                            <span class="location-label">Current:</span>
                            <span class="location-text">${train.current_station}</span>
                        </div>
                        <div class="train-metrics">
                            <div class="metric">
                                <span class="metric-label">Speed:</span>
                                <span class="metric-value">${train.speed} km/h</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Progress:</span>
                                <span class="metric-value">${Math.round((train.progress || 0) * 100)}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Delay:</span>
                                <span class="metric-value ${train.delay_minutes > 0 ? 'delayed' : 'ontime'}">${train.delay_minutes || 0} min</span>
                            </div>
                        </div>
                        <div class="train-alerts">
                            ${train.collision_risk ? '<span class="alert-badge collision">⚠️ Collision Risk</span>' : ''}
                            ${train.rerouting_needed ? '<span class="alert-badge rerouting">🔄 Rerouting</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            console.log(`✅ Loaded ${trains.length} trains`);
        }
        
        // Refresh analytics data
        function refreshAnalytics() {
            console.log('📊 Refreshing analytics data...');
            
            if (!mapData || !mapData.trains) {
                console.log('❌ No train data available for analytics');
                return;
            }
            
            // Update real-time analytics with live data
            updatePerformanceTrends();
            updateTrainPerformanceMetrics();
            updateStationAnalytics();
            updateAlertAnalysis();
            updateRoutePerformance();
            updateAIOptimizationImpact();
            
            console.log('✅ Analytics refreshed with live data');
        }
        
        // Update performance trends chart with real data
        function updatePerformanceTrends() {
            if (!mapData.trains) return;
            
            const trains = mapData.trains;
            const avgSpeed = trains.reduce((sum, train) => sum + (train.speed || 0), 0) / trains.length;
            const onTimeRate = trains.filter(t => (t.delay_minutes || 0) <= 0).length / trains.length * 100;
            const efficiency = trains.filter(t => t.status === 'running' || t.status === 'in_transit').length / trains.length * 100;
            
            // Update chart data points
            const dataPoints = document.querySelectorAll('.chart-line .data-point');
            const speeds = [avgSpeed * 0.9, avgSpeed * 1.05, avgSpeed * 0.95, avgSpeed * 1.1, avgSpeed];
            
            dataPoints.forEach((point, index) => {
                if (speeds[index]) {
                    const height = Math.min(Math.max((speeds[index] / 150) * 100, 20), 90);
                    point.style.height = height + '%';
                    point.title = Math.round(speeds[index]) + ' km/h';
                }
            });
        }
        
        // Update train performance metrics
        function updateTrainPerformanceMetrics() {
            if (!mapData.trains) return;
            
            const trains = mapData.trains;
            const totalTrains = trains.length;
            const onTimeTrains = trains.filter(t => (t.delay_minutes || 0) <= 0).length;
            const delayedTrains = trains.filter(t => (t.delay_minutes || 0) > 0).length;
            const avgSpeed = trains.reduce((sum, train) => sum + (train.speed || 0), 0) / totalTrains;
            const punctualityRate = (onTimeTrains / totalTrains * 100).toFixed(1);
            
            // Update metrics
            const metricElements = {
                'Punctuality Rate': punctualityRate + '%',
                'Average Speed': Math.round(avgSpeed) + ' km/h',
                'On-Time Trains': onTimeTrains,
                'Delayed Trains': delayedTrains
            };
            
            Object.entries(metricElements).forEach(([name, value]) => {
                const element = Array.from(document.querySelectorAll('.metric-name')).find(el => el.textContent === name);
                if (element) {
                    const valueElement = element.nextElementSibling;
                    if (valueElement) {
                        valueElement.textContent = value;
                    }
                }
            });
        }
        
        // Update station analytics
        function updateStationAnalytics() {
            if (!mapData.stations || !mapData.trains) return;
            
            // Calculate station delays
            const stationDelays = {};
            mapData.stations.forEach(station => {
                const trainsAtStation = mapData.trains.filter(train => 
                    train.current_station === station.id || train.next_station === station.id
                );
                const avgDelay = trainsAtStation.length > 0 
                    ? trainsAtStation.reduce((sum, train) => sum + (train.delay_minutes || 0), 0) / trainsAtStation.length
                    : 0;
                stationDelays[station.name] = {
                    trains: trainsAtStation.length,
                    avgDelay: Math.round(avgDelay)
                };
            });
            
            // Update station list
            const stationList = document.querySelector('.station-list');
            if (stationList) {
                stationList.innerHTML = Object.entries(stationDelays)
                    .sort((a, b) => b[1].trains - a[1].trains)
                    .slice(0, 5)
                    .map(([name, data]) => `
                        <div class="station-item">
                            <span class="station-name">${name}</span>
                            <span class="station-trains">${data.trains} trains</span>
                            <span class="station-delay ${data.avgDelay > 5 ? 'high' : data.avgDelay > 0 ? 'medium' : 'low'}">${data.avgDelay}min</span>
                        </div>
                    `).join('');
            }
        }
        
        // Update alert analysis
        function updateAlertAnalysis() {
            if (!mapData.trains) return;
            
            const trains = mapData.trains;
            const collisionAlerts = trains.filter(t => t.collision_risk).length;
            const reroutingAlerts = trains.filter(t => t.rerouting_needed).length;
            const delayAlerts = trains.filter(t => (t.delay_minutes || 0) > 15).length;
            
            // Update alert statistics
            const alertStats = document.querySelector('.alert-stats');
            if (alertStats) {
                alertStats.innerHTML = `
                    <div class="alert-type">
                        <span class="alert-icon">⚠️</span>
                        <span class="alert-name">Collision Risk</span>
                        <span class="alert-count">${collisionAlerts}</span>
                    </div>
                    <div class="alert-type">
                        <span class="alert-icon">🔄</span>
                        <span class="alert-name">Rerouting</span>
                        <span class="alert-count">${reroutingAlerts}</span>
                    </div>
                    <div class="alert-type">
                        <span class="alert-icon">⏰</span>
                        <span class="alert-name">Major Delays</span>
                        <span class="alert-count">${delayAlerts}</span>
                    </div>
                `;
            }
        }
        
        // Update route performance
        function updateRoutePerformance() {
            if (!mapData.trains) return;
            
            // Calculate route performance
            const routeStats = {};
            mapData.trains.forEach(train => {
                const routeKey = `${train.origin}-${train.destination}`;
                if (!routeStats[routeKey]) {
                    routeStats[routeKey] = {
                        trains: 0,
                        onTime: 0,
                        delayed: 0,
                        avgSpeed: 0,
                        totalSpeed: 0
                    };
                }
                routeStats[routeKey].trains++;
                routeStats[routeKey].totalSpeed += train.speed || 0;
                routeStats[routeKey].avgSpeed = routeStats[routeKey].totalSpeed / routeStats[routeKey].trains;
                
                if ((train.delay_minutes || 0) <= 0) {
                    routeStats[routeKey].onTime++;
                } else {
                    routeStats[routeKey].delayed++;
                }
            });
            
            // Update route list
            const routeList = document.querySelector('.route-list');
            if (routeList) {
                routeList.innerHTML = Object.entries(routeStats)
                    .sort((a, b) => b[1].trains - a[1].trains)
                    .slice(0, 5)
                    .map(([route, stats]) => {
                        const onTimeRate = (stats.onTime / stats.trains * 100).toFixed(1);
                        return `
                            <div class="route-item">
                                <span class="route-name">${route}</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${onTimeRate}%"></div>
                                </div>
                                <span class="progress-text">${onTimeRate}%</span>
                            </div>
                        `;
                    }).join('');
            }
        }
        
        // Update AI optimization impact
        function updateAIOptimizationImpact() {
            if (!mapData.trains) return;
            
            const trains = mapData.trains;
            const totalTrains = trains.length;
            const aiOptimized = trains.filter(t => t.rerouting_needed || t.collision_risk).length;
            const efficiencyGain = Math.min(aiOptimized * 2.5, 15); // Simulated efficiency gain
            const delayReduction = Math.min(aiOptimized * 1.8, 12); // Simulated delay reduction
            
            // Update AI metrics
            const aiMetrics = document.querySelector('.ai-metrics');
            if (aiMetrics) {
                aiMetrics.innerHTML = `
                    <div class="ai-metric">
                        <h4>Optimized Trains</h4>
                        <div class="ai-value">${aiOptimized}/${totalTrains}</div>
                        <div class="ai-description">AI-assisted routing</div>
                    </div>
                    <div class="ai-metric">
                        <h4>Efficiency Gain</h4>
                        <div class="ai-value">+${efficiencyGain.toFixed(1)}%</div>
                        <div class="ai-description">Throughput improvement</div>
                    </div>
                    <div class="ai-metric">
                        <h4>Delay Reduction</h4>
                        <div class="ai-value">-${delayReduction.toFixed(1)}%</div>
                        <div class="ai-description">Average delay reduction</div>
                    </div>
                `;
            }
        }

        // Utility functions
        function refreshMap() {
            if (map) {
                map.invalidateSize();
                updateStatus('🔄 Map refreshed');
            }
        }

        function forceUpdateTrains() {
            // Force refresh train data
            fetch('http://localhost:8084/api/map-data')
                .then(response => response.json())
                .then(data => {
                    mapData = data;
                    
                    // Clear existing train markers
                    trainMarkers.forEach(marker => map.removeLayer(marker));
                    trainMarkers = [];
                    
                    // Re-add trains with fresh data
                    addTrainsToMap();
                    updateRealTimeDataDisplay();
                    
                    updateStatus('🚂 Train data force updated');
                    console.log('🚂 Force update completed');
                })
                .catch(error => {
                    console.error('❌ Force update error:', error);
                    updateStatus('❌ Force update failed');
                });
        }

        function updateStatus(message) {
            document.getElementById('status-display').textContent = message;
            console.log('📊 Status:', message);
        }

        // Debug function to show train movement
        function debugTrainMovement() {
            if (!mapData || !mapData.trains) return;
            
            console.log('🚂 Debug: Train Movement Data');
            mapData.trains.slice(0, 5).forEach(train => {
                console.log(`Train ${train.train_number}:`, {
                    position: `[${train.lat.toFixed(4)}, ${train.lon.toFixed(4)}]`,
                    speed: `${train.speed} km/h`,
                    progress: `${Math.round(train.progress * 100)}%`,
                    status: train.status,
                    collision_risk: train.collision_risk,
                    rerouting_needed: train.rerouting_needed
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Railway Traffic Control System initialized');
            
            // Set up navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
                document.querySelector('.nav-links').classList.toggle('active');
            });
            
            // Auto-populate station dropdown
            setTimeout(() => {
                populateStationDropdown();
            }, 1000);
            
            // Debug train movement every 10 seconds
            setInterval(() => {
                if (mapData && mapData.trains) {
                    debugTrainMovement();
                }
            }, 10000);
        });
    </script>
</body>
</html>

