<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Traffic Control System - Smart India Hackathon 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Railway Traffic Control</div>
            <button class="mobile-menu-toggle">‚ò∞</button>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="map">Live Map</a></li>
                <li><a href="#" class="nav-link" data-page="trains">Trains</a></li>
                <li><a href="#" class="nav-link" data-page="analytics">Analytics</a></li>
                <li><a href="#" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>AI-Powered Railway Traffic Control</h1>
                <p>Maximizing Section Throughput Using Intelligent Decision Support System</p>
                <p>Smart India Hackathon 2025 - Ministry of Railways</p>
                <a href="#" class="btn" onclick="showPage('dashboard')">View Dashboard</a>
                <a href="#" class="btn btn-secondary" onclick="showPage('map')">Live Map</a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>üöÇ Real-time Tracking</h3>
                    <p>Monitor all trains across the Indian railway network with live position updates and movement tracking.</p>
                </div>
                <div class="feature-card">
                    <h3>‚ö° AI Optimization</h3>
                    <p>Advanced algorithms for conflict detection, route optimization, and throughput maximization.</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Analytics Dashboard</h3>
                    <p>Comprehensive KPIs, performance metrics, and predictive analytics for better decision making.</p>
                </div>
                <div class="feature-card">
                    <h3>üéØ Simulation Engine</h3>
                    <p>What-if scenarios and disruption handling with rapid re-optimization capabilities.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="page-header">
                <h2>System Dashboard</h2>
                <p class="page-description">Real-time monitoring and control of the railway traffic system</p>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-stations">-</div>
                    <div class="stat-label">Total Stations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-trains">-</div>
                    <div class="stat-label">Active Trains</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-tracks">-</div>
                    <div class="stat-label">Track Segments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="system-efficiency">-</div>
                    <div class="stat-label">System Efficiency</div>
                </div>
            </div>

            <div class="train-list">
                <h3>Recent Train Activity</h3>
                <div id="recent-trains">
                    <div class="loading">Loading train data...</div>
                </div>
            </div>
        </div>

        <!-- Live Map Page -->
        <div id="map" class="page">
            <div class="page-header">
                <h2>Live Railway Map</h2>
                <p class="page-description">Interactive map showing real-time train positions and railway network</p>
            </div>
            <div class="map-container">
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="initializeMap()" class="btn">Initialize Map</button>
                    <button onclick="loadMapData()" class="btn btn-secondary">Load Data</button>
                    <button onclick="refreshMap()" class="btn btn-success">Refresh</button>
                    <button onclick="toggleFullscreen()" class="btn btn-warning">Fullscreen</button>
                    <button onclick="toggleVoiceAlerts()" class="btn" id="voice-btn">üîä Voice Alerts</button>
                    <button onclick="toggleLiveMovement()" class="btn" id="movement-btn">‚ñ∂Ô∏è Live Movement</button>
                </div>
                
                <!-- Alert Panel -->
                <div id="alert-panel" style="margin-bottom: 10px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 5px; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #dc2626;">üö® Active Alerts</h4>
                    <div id="alert-list"></div>
                </div>
                
                <div id="railway-map" style="height: 600px; border: 2px solid #e5e7eb; border-radius: 10px; position: relative;"></div>
                
                <!-- AI Message Overlay -->
                <div id="ai-overlay" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; display: none; max-width: 300px; z-index: 1000;">
                    <div id="ai-message"></div>
                </div>
                
                <div id="map-status" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Map Status:</strong> <span id="status-text">Ready to initialize</span>
                </div>
            </div>
        </div>

        <!-- Trains Page -->
        <div id="trains" class="page">
            <div class="page-header">
                <h2>Train Management</h2>
                <p class="page-description">Monitor and manage all active trains across the railway network</p>
            </div>
            <div class="train-list">
                <div id="all-trains">
                    <div class="loading">Loading train information...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="page-header">
                <h2>Performance Analytics</h2>
                <p class="page-description">Comprehensive performance metrics and system analytics</p>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number">95.2%</div>
                    <div class="stat-label">Punctuality Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">87.5%</div>
                    <div class="stat-label">Throughput Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">12</div>
                    <div class="stat-label">Conflicts Resolved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">2.3 min</div>
                    <div class="stat-label">Average Delay</div>
                </div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about" class="page">
            <div class="page-header">
                <h2>About the System</h2>
                <p class="page-description">Learn about our AI-powered railway traffic control technology</p>
            </div>
            <div class="features">
                <div class="feature-card">
                    <h3>üéØ Mission</h3>
                    <p>To revolutionize railway traffic control through AI-powered optimization, ensuring maximum efficiency and safety across India's vast railway network.</p>
                </div>
                <div class="feature-card">
                    <h3>üîß Technology</h3>
                    <p>Built with FastAPI, React, Leaflet.js, and advanced optimization algorithms using Google OR-Tools for real-time decision support.</p>
                </div>
                <div class="feature-card">
                    <h3>üìà Impact</h3>
                    <p>Reducing delays, maximizing throughput, and providing intelligent decision support for railway traffic controllers nationwide.</p>
                </div>
                <div class="feature-card">
                    <h3>üöÄ Future</h3>
                    <p>Integration with existing railway control systems, machine learning enhancements, and predictive analytics for proactive management.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Railway Traffic Control System - Smart India Hackathon</p>
        <p>Ministry of Railways | AI-Powered Decision Support System</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Global variables for map
        let map = null;
        let mapData = null;
        let stationMarkers = [];
        let trainMarkers = [];
        let trackLines = [];
        let liveMovementEnabled = false;
        let voiceAlertsEnabled = false;
        let updateInterval = null;
        let speechSynthesis = window.speechSynthesis;

        // Update status text
        function updateStatus(message) {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = message;
            }
            console.log('üó∫Ô∏è Status:', message);
        }

        // Initialize the map
        function initializeMap() {
            try {
                updateStatus('Initializing map...');
                
                const mapContainer = document.getElementById('railway-map');
                if (!mapContainer) {
                    updateStatus('‚ùå Map container not found!');
                    return;
                }

                // Clear existing map if any
                if (map) {
                    map.remove();
                }

                // Create new map
                map = L.map('railway-map').setView([20.5937, 78.9629], 5);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                updateStatus('‚úÖ Map initialized successfully!');
                
                // Auto-load data after map is ready
                setTimeout(() => {
                    loadMapData();
                }, 500);
                
            } catch (error) {
                updateStatus('‚ùå Error initializing map: ' + error.message);
                console.error('Map initialization error:', error);
            }
        }


        // Add stations to map
        function addStationsToMap() {
            if (!map || !mapData) return;
            
            // Clear existing station markers
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            mapData.stations.forEach(station => {
                const marker = L.marker([station.lat, station.lon]).addTo(map);
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e3a8a;">${station.name}</h3>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${station.type}</p>
                        <p style="margin: 5px 0;"><strong>Platforms:</strong> ${station.platforms}</p>
                        <p style="margin: 5px 0;"><strong>ID:</strong> ${station.id}</p>
                    </div>
                `);
                stationMarkers.push(marker);
            });
        }

        // Add tracks to map
        function addTracksToMap() {
            if (!map || !mapData) return;
            
            // Clear existing track lines
            trackLines.forEach(line => map.removeLayer(line));
            trackLines = [];
            
            mapData.tracks.forEach(track => {
                const fromStation = mapData.stations.find(s => s.id === track.from_station);
                const toStation = mapData.stations.find(s => s.id === track.to_station);
                
                if (fromStation && toStation) {
                    const polyline = L.polyline([
                        [fromStation.lat, fromStation.lon],
                        [toStation.lat, toStation.lon]
                    ], {
                        color: getTrackColor(track.track_type),
                        weight: getTrackWeight(track.track_type),
                        opacity: 0.8
                    }).addTo(map);
                    
                    polyline.bindPopup(`
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0;">Track Segment</h4>
                            <p style="margin: 5px 0;"><strong>From:</strong> ${fromStation.name}</p>
                            <p style="margin: 5px 0;"><strong>To:</strong> ${toStation.name}</p>
                            <p style="margin: 5px 0;"><strong>Distance:</strong> ${track.distance} km</p>
                            <p style="margin: 5px 0;"><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${track.track_type}</p>
                        </div>
                    `);
                    trackLines.push(polyline);
                }
            });
        }

        // Add trains to map
        function addTrainsToMap() {
            if (!map || !mapData) return;
            
            // Clear existing train markers
            trainMarkers.forEach(marker => map.removeLayer(marker));
            trainMarkers = [];
            
            mapData.trains.forEach(train => {
                // Determine marker style based on alerts
                let markerClass = 'train-marker';
                let markerColor = '';
                
                if (train.collision_risk) {
                    markerClass += ' collision-risk';
                    markerColor = 'red';
                } else if (train.rerouting_needed) {
                    markerClass += ' rerouting-needed';
                    markerColor = 'orange';
                }
                
                const trainIcon = L.divIcon({
                    className: markerClass,
                    html: getTrainIcon(train.train_type, markerColor),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const trainMarker = L.marker([train.lat, train.lon], {
                    icon: trainIcon
                }).addTo(map);
                
                // Enhanced popup with AI messages
                let popupContent = `
                    <div style="min-width: 280px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e3a8a;">${train.train_number}</h3>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${train.train_type}</p>
                        <p style="margin: 5px 0;"><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</p>
                        <p style="margin: 5px 0;"><strong>Current:</strong> ${train.current_station}</p>
                        <p style="margin: 5px 0;"><strong>Next:</strong> ${train.next_station}</p>
                        <p style="margin: 5px 0;"><strong>Speed:</strong> ${train.speed} km/h</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> ${train.status}</p>
                        <p style="margin: 5px 0;"><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                `;
                
                if (train.ai_message) {
                    popupContent += `
                        <div style="margin-top: 10px; padding: 8px; background: ${train.collision_risk ? '#fef2f2' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${train.collision_risk ? '#dc2626' : '#d97706'};">
                            <strong>ü§ñ AI Alert:</strong><br>
                            ${train.ai_message}
                        </div>
                    `;
                }
                
                popupContent += `</div>`;
                
                trainMarker.bindPopup(popupContent);
                trainMarkers.push(trainMarker);
            });
        }

        // Helper functions
        function getTrackColor(trackType) {
            const colors = {
                'main': '#1e3a8a',
                'suburban': '#dc2626',
                'branch': '#d97706',
                'freight': '#6b7280'
            };
            return colors[trackType] || '#1e3a8a';
        }

        function getTrackWeight(trackType) {
            const weights = {
                'main': 4,
                'suburban': 3,
                'branch': 2,
                'freight': 2
            };
            return weights[trackType] || 3;
        }

        function getTrainIcon(trainType, color = '') {
            const icons = {
                'Rajdhani Express': 'üöÑ',
                'Shatabdi Express': 'üöÖ',
                'Duronto Express': 'üöÜ',
                'Vande Bharat Express': 'üöà',
                'Express': 'üöÇ',
                'Mail': 'üöÉ',
                'Freight': 'üöõ',
                'Local': 'üöã'
            };
            
            const icon = icons[trainType] || 'üöÇ';
            
            if (color === 'red') {
                return `<div style="color: red; font-size: 20px; text-shadow: 2px 2px 4px rgba(255,0,0,0.8); animation: pulse-red 1s infinite;">${icon}</div>`;
            } else if (color === 'orange') {
                return `<div style="color: orange; font-size: 20px; text-shadow: 2px 2px 4px rgba(255,165,0,0.8); animation: pulse-orange 1s infinite;">${icon}</div>`;
            } else {
                return `<div style="font-size: 20px;">${icon}</div>`;
            }
        }

        // Refresh map data
        function refreshMap() {
            if (map) {
                loadMapData();
            } else {
                updateStatus('‚ùå Please initialize map first');
            }
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            const mapContainer = document.getElementById('railway-map');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().then(() => {
                    mapContainer.style.height = '100vh';
                    if (map) {
                        map.invalidateSize();
                    }
                    updateStatus('‚úÖ Fullscreen mode enabled');
                }).catch(err => {
                    updateStatus('‚ùå Error entering fullscreen: ' + err.message);
                });
            } else {
                document.exitFullscreen().then(() => {
                    mapContainer.style.height = '600px';
                    if (map) {
                        map.invalidateSize();
                    }
                    updateStatus('‚úÖ Fullscreen mode disabled');
                });
            }
        }

        // Toggle voice alerts
        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.textContent = voiceAlertsEnabled ? 'üîá Voice Alerts' : 'üîä Voice Alerts';
            voiceBtn.style.backgroundColor = voiceAlertsEnabled ? '#dc2626' : '';
            updateStatus(voiceAlertsEnabled ? '‚úÖ Voice alerts enabled' : '‚úÖ Voice alerts disabled');
        }

        // Toggle live movement
        function toggleLiveMovement() {
            liveMovementEnabled = !liveMovementEnabled;
            const movementBtn = document.getElementById('movement-btn');
            movementBtn.textContent = liveMovementEnabled ? '‚è∏Ô∏è Live Movement' : '‚ñ∂Ô∏è Live Movement';
            movementBtn.style.backgroundColor = liveMovementEnabled ? '#dc2626' : '';
            
            if (liveMovementEnabled) {
                startLiveMovement();
                updateStatus('‚úÖ Live movement enabled');
            } else {
                stopLiveMovement();
                updateStatus('‚úÖ Live movement disabled');
            }
        }

        // Start live movement updates
        function startLiveMovement() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(() => {
                if (map && mapData) {
                    loadMapData();
                }
            }, 3000); // Update every 3 seconds
        }

        // Stop live movement updates
        function stopLiveMovement() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Speak alert message
        function speakAlert(message) {
            if (voiceAlertsEnabled && speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        // Show AI message overlay
        function showAIMessage(message, duration = 5000) {
            const overlay = document.getElementById('ai-overlay');
            const messageDiv = document.getElementById('ai-message');
            
            if (overlay && messageDiv) {
                messageDiv.textContent = message;
                overlay.style.display = 'block';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, duration);
            }
        }

        // Update alert panel
        function updateAlertPanel(collisions, rerouting) {
            const alertPanel = document.getElementById('alert-panel');
            const alertList = document.getElementById('alert-list');
            
            if (!alertPanel || !alertList) return;
            
            const allAlerts = [...collisions, ...rerouting];
            
            if (allAlerts.length > 0) {
                alertPanel.style.display = 'block';
                alertList.innerHTML = '';
                
                allAlerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = `
                        padding: 8px; margin: 5px 0; border-radius: 4px;
                        background: ${alert.severity === 'high' ? '#fef2f2' : '#fef3c7'};
                        border-left: 4px solid ${alert.severity === 'high' ? '#dc2626' : '#d97706'};
                    `;
                    alertDiv.innerHTML = `
                        <strong>${alert.train_number}</strong><br>
                        ${alert.message}<br>
                        <small>${new Date(alert.timestamp).toLocaleTimeString()}</small>
                    `;
                    alertList.appendChild(alertDiv);
                    
                    // Speak high priority alerts
                    if (alert.severity === 'high') {
                        speakAlert(`Collision risk detected for train ${alert.train_number}`);
                    }
                });
            } else {
                alertPanel.style.display = 'none';
            }
        }

        // Enhanced loadMapData function
        async function loadMapData() {
            try {
                updateStatus('Loading data from API...');
                
                const response = await fetch('http://localhost:8081/api/map-data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                mapData = await response.json();
                updateStatus(`‚úÖ Data loaded! Stations: ${mapData.stations.length}, Trains: ${mapData.trains.length}, Tracks: ${mapData.tracks.length}`);
                
                // Add data to map
                addStationsToMap();
                addTracksToMap();
                addTrainsToMap();
                
                // Update alerts
                if (mapData.collisions || mapData.rerouting) {
                    updateAlertPanel(mapData.collisions || [], mapData.rerouting || []);
                }
                
                // Show AI messages for trains with alerts
                mapData.trains.forEach(train => {
                    if (train.ai_message) {
                        showAIMessage(`${train.train_number}: ${train.ai_message}`, 3000);
                    }
                });
                
                updateStatus(`‚úÖ Map fully loaded with ${mapData.stations.length} stations, ${mapData.tracks.length} tracks, and ${mapData.trains.length} trains!`);
                
            } catch (error) {
                updateStatus('‚ùå Error loading data: ' + error.message);
                console.error('Data loading error:', error);
            }
        }

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Ready to initialize map');
        });
    </script>
</body>
</html>
