<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Traffic Control System - Smart India Hackathon 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Railway Traffic Control</div>
            <button class="mobile-menu-toggle">‚ò∞</button>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="map">Live Map</a></li>
                <li><a href="#" class="nav-link" data-page="trains">Trains</a></li>
                <li><a href="#" class="nav-link" data-page="analytics">Analytics</a></li>
                <li><a href="#" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>AI-Powered Railway Traffic Control</h1>
                <p>Maximizing Section Throughput Using Intelligent Decision Support System</p>
                <p>Smart India Hackathon 2025 - Ministry of Railways</p>
                <a href="#" class="btn" onclick="showPage('dashboard')">View Dashboard</a>
                <a href="#" class="btn btn-secondary" onclick="showPage('map')">Live Map</a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>üöÇ Real-time Tracking</h3>
                    <p>Monitor all trains across the Indian railway network with live position updates and movement tracking.</p>
                </div>
                <div class="feature-card">
                    <h3>‚ö° AI Optimization</h3>
                    <p>Advanced algorithms for conflict detection, route optimization, and throughput maximization.</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Analytics Dashboard</h3>
                    <p>Comprehensive analytics and reporting for railway operations and performance metrics.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="page-header">
                <h2>üìä Dashboard</h2>
                <p class="page-description">Real-time overview of railway operations and system performance</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>üöÇ Active Trains</h3>
                    <div class="metric-value">50</div>
                    <div class="metric-label">Currently Running</div>
                </div>
                <div class="dashboard-card">
                    <h3>üöâ Stations</h3>
                    <div class="metric-value">124</div>
                    <div class="metric-label">Total Stations</div>
                </div>
                <div class="dashboard-card">
                    <h3>üõ§Ô∏è Track Segments</h3>
                    <div class="metric-value">86</div>
                    <div class="metric-label">Active Routes</div>
                </div>
                <div class="dashboard-card">
                    <h3>‚ö° System Status</h3>
                    <div class="metric-value online">Online</div>
                    <div class="metric-label">All Systems Operational</div>
                </div>
            </div>
        </div>

        <!-- Live Map Page -->
        <div id="map" class="page">
            <div class="page-header">
                <h2>üó∫Ô∏è Live Railway Map</h2>
                <p class="page-description">Interactive map showing real-time train positions and railway network across India</p>
            </div>
            
            <!-- Main Map Layout -->
            <div class="map-layout">
                <!-- Left Sidebar -->
                <div class="map-sidebar">
                    <!-- Map Controls -->
                    <div class="sidebar-section">
                        <h4>üéÆ Map Controls</h4>
                        <div class="control-grid">
                            <button onclick="initializeMap()" class="btn btn-primary">üó∫Ô∏è Initialize</button>
                            <button onclick="loadMapData()" class="btn btn-secondary">üìä Load Data</button>
                            <button onclick="refreshMap()" class="btn btn-success">üîÑ Refresh</button>
                            <button onclick="forceUpdateTrains()" class="btn btn-info">üöÇ Update</button>
                        </div>
                    </div>
                    
                    <!-- Display Options -->
                    <div class="sidebar-section">
                        <h4>‚öôÔ∏è Display Options</h4>
                        <div class="control-grid">
                            <button onclick="toggleFullscreen()" class="btn btn-warning">üì∫ Fullscreen</button>
                            <button onclick="toggleVoiceAlerts()" class="btn" id="voice-btn">üîä Voice</button>
                            <button onclick="toggleLiveMovement()" class="btn" id="movement-btn">‚ñ∂Ô∏è Movement</button>
                            <button onclick="showSectionController()" class="btn" id="controller-btn">üéõÔ∏è Controller</button>
                        </div>
                    </div>
                    
                    <!-- Station Monitoring -->
                    <div class="sidebar-section">
                        <h4>üì° Station Monitoring</h4>
                        <div class="station-controls">
                            <select id="station-select" onchange="selectStation()" class="form-select">
                                <option value="">Select station to monitor...</option>
                            </select>
                            <div class="station-buttons">
                                <button onclick="populateStationDropdown()" class="btn btn-secondary">üîÑ Load</button>
                                <button onclick="clearStationFocus()" class="btn btn-outline">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="sidebar-section">
                        <h4>üìä System Status</h4>
                        <div id="status-display" class="status-display">Ready</div>
                    </div>
                </div>
                
                <!-- Main Map Area -->
                <div class="map-main">
                    <div id="railway-map" class="railway-map"></div>
                    
                    <!-- AI Message Overlay -->
                    <div id="ai-overlay" class="ai-overlay">
                        <div id="ai-message"></div>
                    </div>
                </div>
                
                <!-- Right Panel -->
                <div class="map-right-panel">
                    <!-- Real-Time Data -->
                    <div class="panel-section">
                        <h4>üìà Real-Time Data</h4>
                        <div id="real-time-data" class="real-time-data">
                            <div class="data-item">
                                <span class="data-label">Active Trains:</span>
                                <span id="active-trains-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Total Stations:</span>
                                <span id="total-stations-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Track Segments:</span>
                                <span id="track-segments-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">System Status:</span>
                                <span id="system-status" class="data-value">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Live Station Monitoring Panel -->
            <div id="live-station-monitor" class="live-station-monitor" style="display: none;">
                <div class="monitor-header">
                    <h4>üì° Live Station Monitoring</h4>
                    <button onclick="closeLiveMonitor()" class="btn btn-secondary">‚úï Close</button>
                </div>
                <div class="monitor-content">
                    <div class="station-info">
                        <h5 id="monitor-station-name">Station Name</h5>
                        <div class="station-stats">
                            <div class="stat-item">
                                <span class="stat-label">Connected Tracks:</span>
                                <span id="monitor-tracks-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Active Trains:</span>
                                <span id="monitor-trains-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Monitoring Status:</span>
                                <span id="monitor-status" class="stat-value">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="live-trains-list">
                        <h6>üöÇ Live Train Movements</h6>
                        <div id="live-trains-container" class="trains-container">
                            <div class="loading">Loading live train data...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Controller Panel -->
            <div id="ai-controller-panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid #dc2626; border-radius: 10px; padding: 20px; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #dc2626;">üéõÔ∏è AI Section Controller</h3>
                    <button onclick="hideAIControllerPanel()" style="background: #dc2626; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
                </div>
                <div id="ai-controller-content"></div>
            </div>
        </div>

        <!-- Trains Page -->
        <div id="trains" class="page">
            <div class="page-header">
                <h2>üöÇ Train Management</h2>
                <p class="page-description">Monitor and manage all active trains across the railway network</p>
            </div>
            
            <div class="trains-grid">
                <div class="loading">Loading train data...</div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="page-header">
                <h2>üìä Analytics</h2>
                <p class="page-description">Comprehensive analytics and performance metrics</p>
            </div>
            
            <div class="analytics-grid">
                <div class="loading">Loading analytics data...</div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about" class="page">
            <div class="page-header">
                <h2>‚ÑπÔ∏è About</h2>
                <p class="page-description">Learn more about the Railway Traffic Control System</p>
            </div>
            
            <div class="about-content">
                <div class="about-card">
                    <h3>üéØ Mission</h3>
                    <p>To revolutionize railway traffic control through AI-powered decision support systems that maximize throughput while ensuring safety and efficiency.</p>
                </div>
                <div class="about-card">
                    <h3>üöÄ Technology</h3>
                    <p>Built with cutting-edge technologies including machine learning, real-time data processing, and advanced optimization algorithms.</p>
                </div>
                <div class="about-card">
                    <h3>üèÜ Smart India Hackathon 2025</h3>
                    <p>Developed for the Ministry of Railways as part of the Smart India Hackathon 2025 initiative.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Railway Traffic Control System. Smart India Hackathon 2025 - Ministry of Railways</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let mapData = null;
        let trainMarkers = [];
        let stationMarkers = [];
        let trackLines = [];
        let isFullscreen = false;
        let voiceAlertsEnabled = false;
        let liveMovementEnabled = true;
        let realTimeUpdateInterval;
        let selectedStation = null;
        let liveStationMonitorInterval;

        // Navigation functionality
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Initialize map if on map page
            if (pageId === 'map') {
                setTimeout(() => {
                    initializeMap();
                    loadMapData();
                }, 100);
            }
        }

        // Map initialization
        function initializeMap() {
            try {
                console.log('üó∫Ô∏è Initializing map...');
                
                if (map) {
                    map.remove();
                }
                
                // Create new map with stable settings - centered on India
                map = L.map('railway-map', {
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    touchZoom: true,
                    zoomSnap: 0.25,
                    zoomDelta: 0.5,
                    wheelPxPerZoomLevel: 120
                }).setView([20.5937, 78.9629], 6); // Centered on India with zoom level 6
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 4,
                    opacity: 0.9
                }).addTo(map);
                
                // Prevent map resize issues
                map.on('resize', () => {
                    setTimeout(() => map.invalidateSize(), 100);
                });
                
                // Initial size validation
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                // Debug: Check if map is visible
                setTimeout(() => {
                    if (map) {
                        console.log('üó∫Ô∏è Map is ready and visible');
                        console.log('üìç Map center:', map.getCenter());
                        console.log('üîç Map zoom:', map.getZoom());
                        
                        // Force map to be visible
                        map.invalidateSize();
                        
                        // Auto-load data after map is ready
                        loadMapData();
                    } else {
                        console.error('‚ùå Map failed to initialize');
                        updateStatus('‚ùå Map failed to initialize');
                    }
                }, 1000);
                
                updateStatus('‚úÖ Map initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Map initialization error:', error);
                updateStatus('‚ùå Map initialization failed: ' + error.message);
            }
        }

        // Load map data
        function loadMapData() {
            console.log('üìä Loading map data...');
            updateStatus('üìä Loading map data...');
            
            fetch('http://localhost:8081/api/map-data')
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Map data loaded:', data);
                    mapData = data;
                    
                    // Add elements to map
                    addStationsToMap();
                    addTracksToMap();
                    addTrainsToMap();
                    addTrainPathVisualization();
                    
                    // Update real-time data display
                    updateRealTimeDataDisplay();
                    
                    // Start real-time updates
                    startRealTimeUpdates();
                    
                    // Populate station dropdown
                    populateStationDropdown();
                    
                    updateStatus('‚úÖ Map data loaded successfully');
                })
                .catch(error => {
                    console.error('‚ùå Error loading map data:', error);
                    updateStatus('‚ùå Failed to load map data: ' + error.message);
                });
        }

        // Add stations to map
        function addStationsToMap() {
            if (!mapData || !mapData.stations) return;
            
            console.log('üöâ Adding stations to map...');
            
            mapData.stations.forEach(station => {
                const stationMarker = L.marker([station.lat, station.lon], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: 'üöâ',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                stationMarker.bindPopup(`
                    <div class="station-popup">
                        <h4>${station.name}</h4>
                        <p><strong>Code:</strong> ${station.id}</p>
                        <p><strong>Type:</strong> ${station.type}</p>
                        <p><strong>Platforms:</strong> ${station.platforms}</p>
                    </div>
                `);
                
                stationMarkers.push(stationMarker);
            });
            
            console.log(`‚úÖ Added ${mapData.stations.length} stations to map`);
        }

        // Add tracks to map
        function addTracksToMap() {
            if (!mapData || !mapData.tracks) return;
            
            console.log('üõ§Ô∏è Adding tracks to map...');
            
            mapData.tracks.forEach(track => {
                const trackLine = L.polyline([
                    [track.from.lat, track.from.lon],
                    [track.to.lat, track.to.lon]
                ], {
                    color: '#1e40af',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 5'
                }).addTo(map);
                
                trackLine.bindPopup(`
                    <div class="track-popup">
                        <h4>Track ${track.id}</h4>
                        <p><strong>Distance:</strong> ${track.distance} km</p>
                        <p><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                        <p><strong>Type:</strong> ${track.type}</p>
                    </div>
                `);
                
                trackLines.push(trackLine);
            });
            
            console.log(`‚úÖ Added ${mapData.tracks.length} tracks to map`);
        }

        // Add trains to map
        function addTrainsToMap() {
            if (!mapData || !mapData.trains) return;
            
            console.log('üöÇ Adding trains to map...');
            
            mapData.trains.forEach(train => {
                // Calculate initial position on track
                const trackPosition = calculateTrainPositionOnTrack(train);
                
                const trainMarker = L.marker([trackPosition.lat, trackPosition.lon], {
                    icon: L.divIcon({
                        className: 'train-marker',
                        html: getTrainIcon(train),
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                trainMarker.bindPopup(`
                    <div class="train-popup">
                        <h4>${train.train_number} - ${train.train_type}</h4>
                        <p><strong>Speed:</strong> ${train.speed} km/h</p>
                        <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                        <p><strong>Status:</strong> ${train.status}</p>
                        <p><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</p>
                        <p><strong>Current:</strong> ${train.current_station}</p>
                        <p><strong>Next:</strong> ${train.next_station}</p>
                        ${train.collision_risk ? '<p style="color: red;"><strong>‚ö†Ô∏è Collision Risk!</strong></p>' : ''}
                        ${train.rerouting_needed ? '<p style="color: orange;"><strong>üîÑ Rerouting Needed</strong></p>' : ''}
                    </div>
                `);
                
                trainMarker.trainNumber = train.train_number;
                trainMarkers.push(trainMarker);
            });
            
            console.log(`‚úÖ Added ${mapData.trains.length} trains to map`);
        }
        
        // Add train path visualization
        function addTrainPathVisualization() {
            if (!mapData || !mapData.trains) return;
            
            console.log('üõ§Ô∏è Adding train path visualization...');
            
            mapData.trains.forEach(train => {
                const track = findTrainTrack(train);
                if (track) {
                    // Create a path line showing the train's route
                    const pathLine = L.polyline([
                        [track.from.lat, track.from.lon],
                        [track.to.lat, track.to.lon]
                    ], {
                        color: '#ff6b35',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    // Add to train markers for cleanup
                    const trainMarker = trainMarkers.find(m => m.trainNumber === train.train_number);
                    if (trainMarker) {
                        trainMarker.pathLine = pathLine;
                    }
                }
            });
            
            console.log('‚úÖ Added train path visualization');
        }

        // Get train icon with enhanced visibility
        function getTrainIcon(train) {
            const isMoving = train.speed > 0;
            const direction = getTrainDirection(train);
            
            return `
                <div class="train-icon-container" style="position: relative;">
                    <span class="train-emoji" style="font-size: 20px; color: #1e40af; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); display: block;">
                        üöÇ
                    </span>
                    ${isMoving ? `<div class="movement-indicator" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 1s infinite;"></div>` : ''}
                    ${direction ? `<div class="direction-arrow" style="position: absolute; top: 50%; left: -10px; transform: translateY(-50%); font-size: 12px; color: #1e40af;">${direction}</div>` : ''}
                </div>
            `;
        }
        
        // Get train direction arrow
        function getTrainDirection(train) {
            if (!train.current_station || !train.next_station) return '';
            
            // Simple direction based on station names (you can enhance this)
            const current = train.current_station.toLowerCase();
            const next = train.next_station.toLowerCase();
            
            // Basic directional logic
            if (current.includes('north') || current.includes('delhi')) return '‚Üí';
            if (current.includes('south') || current.includes('chennai')) return '‚Üê';
            if (current.includes('east') || current.includes('kolkata')) return '‚Üë';
            if (current.includes('west') || current.includes('mumbai')) return '‚Üì';
            
            return '‚Üí'; // Default right arrow
        }

        // Calculate train position on track
        function calculateTrainPositionOnTrack(train) {
            if (!mapData || !mapData.tracks) return { lat: train.lat, lon: train.lon };
            
            // Find the track the train is currently on
            const currentTrack = findTrainTrack(train);
            if (!currentTrack) return { lat: train.lat, lon: train.lon };
            
            // Calculate position based on progress along the track
            const progress = train.progress || 0;
            const fromLat = currentTrack.from.lat;
            const fromLon = currentTrack.from.lon;
            const toLat = currentTrack.to.lat;
            const toLon = currentTrack.to.lon;
            
            // Interpolate position along the track
            const lat = fromLat + (toLat - fromLat) * progress;
            const lon = fromLon + (toLon - fromLon) * progress;
            
            return { lat, lon };
        }
        
        // Find which track a train is currently on
        function findTrainTrack(train) {
            if (!mapData || !mapData.tracks) return null;
            
            // Try to find track based on current and next station
            const currentStation = train.current_station;
            const nextStation = train.next_station;
            
            // First, try to find a track that connects the current and next stations
            let track = mapData.tracks.find(t => {
                // Get station coordinates for comparison
                const fromStation = mapData.stations.find(s => s.id === t.from.id);
                const toStation = mapData.stations.find(s => s.id === t.to.id);
                
                if (!fromStation || !toStation) return false;
                
                // Check if this track connects current and next stations
                return (fromStation.id === currentStation && toStation.id === nextStation) ||
                       (toStation.id === currentStation && fromStation.id === nextStation);
            });
            
            // If not found, try to find any track involving current station
            if (!track) {
                track = mapData.tracks.find(t => {
                    const fromStation = mapData.stations.find(s => s.id === t.from.id);
                    const toStation = mapData.stations.find(s => s.id === t.to.id);
                    
                    if (!fromStation || !toStation) return false;
                    
                    return fromStation.id === currentStation || toStation.id === currentStation;
                });
            }
            
            // If still not found, try to find track based on train's origin and destination
            if (!track) {
                track = mapData.tracks.find(t => {
                    const fromStation = mapData.stations.find(s => s.id === t.from.id);
                    const toStation = mapData.stations.find(s => s.id === t.to.id);
                    
                    if (!fromStation || !toStation) return false;
                    
                    return (fromStation.id === train.origin && toStation.id === train.destination) ||
                           (toStation.id === train.origin && fromStation.id === train.destination);
                });
            }
            
            // If still not found, use a default track (first available)
            if (!track && mapData.tracks.length > 0) {
                track = mapData.tracks[0];
            }
            
            return track;
        }
        
        // Update train positions with enhanced movement
        function updateTrainPositions() {
            if (!mapData || !mapData.trains) return;
            
            mapData.trains.forEach(train => {
                const marker = trainMarkers.find(m => m.trainNumber === train.train_number);
                if (marker) {
                    // Calculate position on track
                    const trackPosition = calculateTrainPositionOnTrack(train);
                    
                    // Get current position
                    const currentPos = marker.getLatLng();
                    const newPos = [trackPosition.lat, trackPosition.lon];
                    
                    // Calculate distance moved
                    const distance = currentPos.distanceTo(newPos);
                    
                    // Enhanced animation based on movement
                    if (distance > 0.001) { // Only animate if train actually moved
                        // Smooth animation with longer duration for visible movement
                        marker.setLatLng(newPos, { 
                            animate: true, 
                            duration: Math.min(2.0, Math.max(0.5, distance * 1000)) // Dynamic duration based on distance
                        });
                        
                        // Add movement trail effect
                        addMovementTrail(currentPos, newPos, train.train_number);
                        
                        console.log(`üöÇ Train ${train.train_number} moving: ${distance.toFixed(4)}km`);
                    }
                    
                    // Update popup with fresh data
                    marker.bindPopup(`
                        <div class="train-popup">
                            <h4>${train.train_number} - ${train.train_type}</h4>
                            <p><strong>Speed:</strong> ${train.speed} km/h</p>
                            <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                            <p><strong>Status:</strong> ${train.status}</p>
                            <p><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</p>
                            <p><strong>Current:</strong> ${train.current_station}</p>
                            <p><strong>Next:</strong> ${train.next_station}</p>
                            <p><strong>Movement:</strong> ${distance > 0.001 ? 'Moving' : 'Stationary'}</p>
                            ${train.collision_risk ? '<p style="color: red;"><strong>‚ö†Ô∏è Collision Risk!</strong></p>' : ''}
                            ${train.rerouting_needed ? '<p style="color: orange;"><strong>üîÑ Rerouting Needed</strong></p>' : ''}
                        </div>
                    `);
                    
                    // Enhanced visual effects
                    const element = marker.getElement();
                    if (train.collision_risk) {
                        element.style.animation = 'train-alert 1s infinite';
                        element.style.filter = 'hue-rotate(0deg) brightness(1.3)';
                        // Voice alert for collision risk
                        if (voiceAlertsEnabled && train.ai_message) {
                            speakAlert(`Collision risk detected for train ${train.train_number}`);
                        }
                    } else if (train.rerouting_needed) {
                        element.style.animation = 'train-warning 1s infinite';
                        element.style.filter = 'hue-rotate(30deg) brightness(1.2)';
                        // Voice alert for rerouting
                        if (voiceAlertsEnabled && train.ai_message) {
                            speakAlert(`Rerouting needed for train ${train.train_number}`);
                        }
                    } else {
                        // Enhanced movement animation
                        if (distance > 0.001) {
                            element.style.animation = 'train-move-fast 1s infinite';
                            element.style.filter = 'brightness(1.1)';
                        } else {
                            element.style.animation = 'train-move 2s infinite';
                            element.style.filter = 'brightness(1)';
                        }
                    }
                }
            });
        }
        
        // Add movement trail effect
        function addMovementTrail(fromPos, toPos, trainNumber) {
            // Create a temporary trail line
            const trail = L.polyline([fromPos, toPos], {
                color: '#ff6b35',
                weight: 1,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            
            // Remove trail after animation
            setTimeout(() => {
                map.removeLayer(trail);
            }, 2000);
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            realTimeUpdateInterval = setInterval(() => {
                // Fetch fresh data from backend
                fetch('http://localhost:8081/api/map-data')
                    .then(response => response.json())
                    .then(data => {
                        mapData = data;
                        updateTrainPositions();
                        updateRealTimeDataDisplay();
                        console.log('üîÑ Real-time update completed');
                    })
                    .catch(error => {
                        console.error('‚ùå Real-time update error:', error);
                    });
            }, 2000);
        }

        // Update real-time data display
        function updateRealTimeDataDisplay() {
            if (!mapData) return;
            
            document.getElementById('active-trains-count').textContent = mapData.trains.length;
            document.getElementById('total-stations-count').textContent = mapData.stations.length;
            document.getElementById('track-segments-count').textContent = mapData.tracks.length;
            document.getElementById('system-status').textContent = 'Online';
        }

        // Station selection
        function selectStation() {
            const select = document.getElementById('station-select');
            const stationId = select.value;
            
            if (stationId) {
                const station = mapData.stations.find(s => s.id === stationId);
                if (station) {
                    selectedStation = station;
                    map.setView([station.lat, station.lon], 12, { animate: false });
                    startLiveStationMonitoring(station);
                }
            } else {
                clearStationFocus();
            }
        }

        // Start live station monitoring
        function startLiveStationMonitoring(station) {
            document.getElementById('live-station-monitor').style.display = 'block';
            document.getElementById('monitor-station-name').textContent = station.name;
            
            updateLiveStationData(station);
            
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
            
            liveStationMonitorInterval = setInterval(() => {
                updateLiveStationData(station);
            }, 3000);
        }

        // Update live station data
        function updateLiveStationData(station) {
            if (!mapData || !mapData.trains) return;
            
            console.log('üîç Updating station data for:', station.name, station.id);
            console.log('üöÇ Total trains available:', mapData.trains.length);
            
            // Find trains at or approaching this station - improved filtering
            const trainsAtStation = mapData.trains.filter(train => {
                const isAtStation = train.current_station === station.id;
                const isNextStation = train.next_station === station.id;
                const isOrigin = train.origin === station.id;
                const isDestination = train.destination === station.id;
                
                if (isAtStation || isNextStation || isOrigin || isDestination) {
                    console.log(`üöÇ Train ${train.train_number} found at ${station.name}:`, {
                        current_station: train.current_station,
                        next_station: train.next_station,
                        origin: train.origin,
                        destination: train.destination,
                        reason: isAtStation ? 'current' : isNextStation ? 'next' : isOrigin ? 'origin' : 'destination'
                    });
                }
                
                return isAtStation || isNextStation || isOrigin || isDestination;
            });
            
            // Find connected tracks
            const connectedTracks = mapData.tracks.filter(track => 
                track.from.lat === station.lat && track.from.lon === station.lon ||
                track.to.lat === station.lat && track.to.lon === station.lon
            );
            
            console.log(`üìä Found ${trainsAtStation.length} trains and ${connectedTracks.length} tracks for ${station.name}`);
            
            // Update display
            document.getElementById('monitor-tracks-count').textContent = connectedTracks.length;
            document.getElementById('monitor-trains-count').textContent = trainsAtStation.length;
            document.getElementById('monitor-status').textContent = 'Active';
            
            // Update trains list
            updateLiveTrainsList(trainsAtStation, connectedTracks);
        }

        // Update live trains list
        function updateLiveTrainsList(trains, tracks) {
            const container = document.getElementById('live-trains-container');
            
            console.log('üìã Updating trains list with:', trains.length, 'trains');
            
            if (trains.length === 0) {
                container.innerHTML = '<div class="no-trains"><p>üöÇ No trains at this station</p><p>Try selecting a different station or wait for trains to arrive</p></div>';
                return;
            }
            
            container.innerHTML = trains.map(train => {
                // Determine train location status
                let locationStatus = '';
                if (train.current_station === train.origin) {
                    locationStatus = 'üöâ At Origin Station';
                } else if (train.current_station === train.destination) {
                    locationStatus = 'üèÅ At Destination';
                } else if (train.next_station === train.origin) {
                    locationStatus = 'üöÇ Approaching Station';
                } else {
                    locationStatus = `üöÇ Current: ${train.current_station}`;
                }
                
                return `
                    <div class="train-item">
                        <div class="train-header">
                            <span class="train-number">${train.train_number}</span>
                            <span class="train-name">${train.train_type}</span>
                            <span class="train-status ${train.status.toLowerCase()}">${train.status}</span>
                        </div>
                        <div class="train-details">
                            <div class="train-route">
                                <span class="route-from">${train.origin}</span>
                                <span class="route-arrow">‚Üí</span>
                                <span class="route-to">${train.destination}</span>
                            </div>
                            <div class="train-location">
                                <span class="location-text">${locationStatus}</span>
                            </div>
                            <div class="train-metrics">
                                <div class="metric">Speed: ${train.speed} km/h</div>
                                <div class="metric">Progress: ${Math.round(train.progress * 100)}%</div>
                                <div class="metric">Delay: ${train.delay_minutes || 0} min</div>
                            </div>
                            ${train.collision_risk ? '<span class="alert-badge collision">‚ö†Ô∏è Collision Risk</span>' : ''}
                            ${train.rerouting_needed ? '<span class="alert-badge rerouting">üîÑ Rerouting Needed</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Close live monitor
        function closeLiveMonitor() {
            document.getElementById('live-station-monitor').style.display = 'none';
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
        }

        // Clear station focus
        function clearStationFocus() {
            selectedStation = null;
            document.getElementById('station-select').value = '';
            closeLiveMonitor();
        }

        // Populate station dropdown
        function populateStationDropdown() {
            const select = document.getElementById('station-select');
            select.innerHTML = '<option value="">Select station to monitor...</option>';
            
            if (mapData && mapData.stations) {
                mapData.stations.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `${station.name} (${station.id})`;
                    select.appendChild(option);
                });
            }
        }

        // Toggle functions
        function toggleFullscreen() {
            if (!isFullscreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                isFullscreen = false;
            }
        }

        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            const btn = document.getElementById('voice-btn');
            btn.textContent = voiceAlertsEnabled ? 'üîä Voice ON' : 'üîä Voice';
            btn.style.backgroundColor = voiceAlertsEnabled ? '#059669' : '';
            
            if (voiceAlertsEnabled) {
                updateStatus('üîä Voice alerts enabled');
                console.log('üîä Voice alerts enabled');
                // Test voice synthesis
                speakAlert('Voice alerts are now enabled');
            } else {
                updateStatus('üîá Voice alerts disabled');
                console.log('üîá Voice alerts disabled');
            }
        }
        
        // Voice synthesis function
        function speakAlert(message) {
            if (voiceAlertsEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 0.7;
                speechSynthesis.speak(utterance);
            }
        }

        function toggleLiveMovement() {
            liveMovementEnabled = !liveMovementEnabled;
            const btn = document.getElementById('movement-btn');
            btn.textContent = liveMovementEnabled ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Movement';
            btn.style.backgroundColor = liveMovementEnabled ? '#059669' : '';
            
            if (liveMovementEnabled) {
                // Start real-time updates
                startRealTimeUpdates();
                updateStatus('üöÇ Live movement started');
                console.log('üöÇ Live movement enabled');
            } else {
                // Stop real-time updates
                if (realTimeUpdateInterval) {
                    clearInterval(realTimeUpdateInterval);
                    realTimeUpdateInterval = null;
                }
                updateStatus('‚è∏Ô∏è Live movement paused');
                console.log('‚è∏Ô∏è Live movement paused');
            }
        }

        function showSectionController() {
            console.log('üéõÔ∏è Controller button clicked!');
            const panel = document.getElementById('ai-controller-panel');
            console.log('Panel found:', panel);
            
            if (panel) {
                panel.style.display = 'block';
                console.log('Panel displayed');
                
                // Load section controller data
                loadSectionControllerData();
                
                updateStatus('üéõÔ∏è Section Controller activated');
                console.log('üéõÔ∏è Section Controller activated');
            } else {
                console.error('‚ùå AI Controller Panel not found!');
                updateStatus('‚ùå Controller panel not found');
            }
        }
        
        // Load section controller data
        function loadSectionControllerData() {
            console.log('üìä Loading section controller data...');
            console.log('MapData available:', !!mapData);
            console.log('Trains available:', mapData ? mapData.trains?.length : 0);
            
            if (!mapData || !mapData.trains) {
                console.log('‚ùå No map data or trains available');
                return;
            }
            
            // Get section status
            fetch('http://localhost:8081/api/section-status')
                .then(response => response.json())
                .then(data => {
                    updateSectionControllerDisplay(data);
                })
                .catch(error => {
                    console.error('‚ùå Section controller data error:', error);
                    // Fallback to local data
                    updateSectionControllerDisplay({
                        sections: mapData.trains.reduce((acc, train) => {
                            const section = train.section_id || 'UNKNOWN_SECTION';
                            if (!acc[section]) {
                                acc[section] = {
                                    id: section,
                                    name: section.replace('_', ' '),
                                    trains: [],
                                    status: 'normal',
                                    priority: 0
                                };
                            }
                            acc[section].trains.push(train);
                            return acc;
                        }, {}),
                        alerts: mapData.collisions || [],
                        timestamp: new Date().toISOString()
                    });
                });
        }
        
        // Update section controller display
        function updateSectionControllerDisplay(data) {
            const container = document.getElementById('ai-controller-content');
            
            if (!data.sections) {
                container.innerHTML = '<p>No section data available</p>';
                return;
            }
            
            const sections = Object.values(data.sections);
            
            container.innerHTML = `
                <div class="section-overview">
                    <h4>üìä Section Overview</h4>
                    <div class="section-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Sections:</span>
                            <span class="stat-value">${sections.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Trains:</span>
                            <span class="stat-value">${sections.reduce((sum, section) => sum + section.trains.length, 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Alerts:</span>
                            <span class="stat-value">${data.alerts ? data.alerts.length : 0}</span>
                        </div>
                    </div>
                </div>
                
                <div class="section-list">
                    <h4>üöâ Section Details</h4>
                    ${sections.map(section => `
                        <div class="section-item">
                            <div class="section-header">
                                <span class="section-name">${section.name}</span>
                                <span class="section-status ${section.status}">${section.status}</span>
                            </div>
                            <div class="section-details">
                                <div class="section-info">
                                    <span>Trains: ${section.trains.length}</span>
                                    <span>Priority: ${section.priority}</span>
                                </div>
                                <div class="section-trains">
                                    ${section.trains.slice(0, 3).map(train => `
                                        <span class="train-badge">${train.train_number}</span>
                                    `).join('')}
                                    ${section.trains.length > 3 ? `<span class="more-trains">+${section.trains.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${data.alerts && data.alerts.length > 0 ? `
                    <div class="section-alerts">
                        <h4>‚ö†Ô∏è Active Alerts</h4>
                        ${data.alerts.map(alert => `
                            <div class="alert-item">
                                <span class="alert-train">${alert.train_number}</span>
                                <span class="alert-message">${alert.message}</span>
                                <span class="alert-severity ${alert.severity}">${alert.severity}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        function hideAIControllerPanel() {
            document.getElementById('ai-controller-panel').style.display = 'none';
        }

        // Utility functions
        function refreshMap() {
            if (map) {
                map.invalidateSize();
                updateStatus('üîÑ Map refreshed');
            }
        }

        function forceUpdateTrains() {
            // Force refresh train data
            fetch('http://localhost:8081/api/map-data')
                .then(response => response.json())
                .then(data => {
                    mapData = data;
                    
                    // Clear existing train markers
                    trainMarkers.forEach(marker => map.removeLayer(marker));
                    trainMarkers = [];
                    
                    // Re-add trains with fresh data
                    addTrainsToMap();
                    updateRealTimeDataDisplay();
                    
                    updateStatus('üöÇ Train data force updated');
                    console.log('üöÇ Force update completed');
                })
                .catch(error => {
                    console.error('‚ùå Force update error:', error);
                    updateStatus('‚ùå Force update failed');
                });
        }

        function updateStatus(message) {
            document.getElementById('status-display').textContent = message;
            console.log('üìä Status:', message);
        }

        // Debug function to show train movement
        function debugTrainMovement() {
            if (!mapData || !mapData.trains) return;
            
            console.log('üöÇ Debug: Train Movement Data');
            mapData.trains.slice(0, 5).forEach(train => {
                console.log(`Train ${train.train_number}:`, {
                    position: `[${train.lat.toFixed(4)}, ${train.lon.toFixed(4)}]`,
                    speed: `${train.speed} km/h`,
                    progress: `${Math.round(train.progress * 100)}%`,
                    status: train.status,
                    collision_risk: train.collision_risk,
                    rerouting_needed: train.rerouting_needed
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Railway Traffic Control System initialized');
            
            // Set up navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
                document.querySelector('.nav-links').classList.toggle('active');
            });
            
            // Auto-populate station dropdown
            setTimeout(() => {
                populateStationDropdown();
            }, 1000);
            
            // Debug train movement every 10 seconds
            setInterval(() => {
                if (mapData && mapData.trains) {
                    debugTrainMovement();
                }
            }, 10000);
        });
    </script>
</body>
</html>
