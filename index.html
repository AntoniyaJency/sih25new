<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Traffic Control System - Smart India Hackathon 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Railway Traffic Control</div>
            <button class="mobile-menu-toggle">‚ò∞</button>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="map">Live Map</a></li>
                <li><a href="#" class="nav-link" data-page="trains">Trains</a></li>
                <li><a href="#" class="nav-link" data-page="analytics">Analytics</a></li>
                <li><a href="#" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>AI-Powered Railway Traffic Control</h1>
                <p>Maximizing Section Throughput Using Intelligent Decision Support System</p>
                <p>Smart India Hackathon 2025 - Ministry of Railways</p>
                <a href="#" class="btn" onclick="showPage('dashboard')">View Dashboard</a>
                <a href="#" class="btn btn-secondary" onclick="showPage('map')">Live Map</a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>üöÇ Real-time Tracking</h3>
                    <p>Monitor all trains across the Indian railway network with live position updates and movement tracking.</p>
                </div>
                <div class="feature-card">
                    <h3>‚ö° AI Optimization</h3>
                    <p>Advanced algorithms for conflict detection, route optimization, and throughput maximization.</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Analytics Dashboard</h3>
                    <p>Comprehensive KPIs, performance metrics, and predictive analytics for better decision making.</p>
                </div>
                <div class="feature-card">
                    <h3>üéØ Simulation Engine</h3>
                    <p>What-if scenarios and disruption handling with rapid re-optimization capabilities.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="page-header">
                <h2>System Dashboard</h2>
                <p class="page-description">Real-time monitoring and control of the railway traffic system</p>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-stations">-</div>
                    <div class="stat-label">Total Stations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-trains">-</div>
                    <div class="stat-label">Active Trains</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-tracks">-</div>
                    <div class="stat-label">Track Segments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="system-efficiency">-</div>
                    <div class="stat-label">System Efficiency</div>
                </div>
            </div>

            <div class="train-list">
                <h3>Recent Train Activity</h3>
                <div id="recent-trains">
                    <div class="loading">Loading train data...</div>
                </div>
            </div>
        </div>

        <!-- Live Map Page -->
        <div id="map" class="page">
            <div class="page-header">
                <h2>Live Railway Map</h2>
                <p class="page-description">Interactive map showing real-time train positions and railway network</p>
            </div>
            <div class="map-container">
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button onclick="initializeMap()" class="btn">Initialize Map</button>
                    <button onclick="loadMapData()" class="btn btn-secondary">Load Data</button>
                    <button onclick="refreshMap()" class="btn btn-success">Refresh</button>
                    <button onclick="toggleFullscreen()" class="btn btn-warning">Fullscreen</button>
                    <button onclick="toggleVoiceAlerts()" class="btn" id="voice-btn">üîä Voice Alerts</button>
                    <button onclick="toggleLiveMovement()" class="btn" id="movement-btn">‚ñ∂Ô∏è Live Movement</button>
                    <button onclick="showSectionController()" class="btn" id="controller-btn">üéõÔ∏è Section Controller</button>
                    <button onclick="showAllTrains()" class="btn" id="trains-btn">üöÇ All Trains</button>
                </div>
                
                <!-- Station Selection -->
                <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label for="station-select" style="font-weight: 600; color: #1e3a8a;">üéØ Monitor Station:</label>
                            <select id="station-select" onchange="selectStation()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; min-width: 200px;">
                                <option value="">Select a station to monitor...</option>
                            </select>
                        </div>
                        <button onclick="clearStationFocus()" class="btn btn-secondary" id="clear-station-btn" style="display: none;">Clear Focus</button>
                        <button onclick="toggleStationMonitoring()" class="btn" id="monitor-btn">üì° Start Monitoring</button>
                    </div>
                </div>
                
                <!-- Alert Panel -->
                <div id="alert-panel" style="margin-bottom: 10px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 5px; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #dc2626;">üö® Active Alerts</h4>
                    <div id="alert-list"></div>
                </div>
                
                <div id="railway-map" style="height: 600px; border: 2px solid #e5e7eb; border-radius: 10px; position: relative;"></div>
                
                <!-- AI Message Overlay -->
                <div id="ai-overlay" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; display: none; max-width: 300px; z-index: 1000;">
                    <div id="ai-message"></div>
                </div>
                
                <!-- Section Controller Panel -->
                <div id="section-controller" style="position: absolute; top: 10px; right: 10px; background: white; border: 2px solid #1e3a8a; border-radius: 10px; padding: 15px; display: none; max-width: 400px; max-height: 600px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1e3a8a;">üéõÔ∏è Section Controller</h3>
                        <button onclick="hideSectionController()" style="background: #dc2626; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
                    </div>
                    <div id="section-list"></div>
                </div>
                
                <!-- All Trains Panel -->
                <div id="all-trains-panel" style="position: absolute; bottom: 10px; left: 10px; background: white; border: 2px solid #059669; border-radius: 10px; padding: 15px; display: none; max-width: 500px; max-height: 400px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #059669;">üöÇ All Trains Status</h3>
                        <button onclick="hideAllTrains()" style="background: #dc2626; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
                    </div>
                    <div id="trains-list"></div>
                </div>
                
                <!-- Station Monitoring Panel -->
                <div id="station-monitoring-panel" style="position: absolute; top: 10px; left: 10px; background: white; border: 2px solid #7c3aed; border-radius: 10px; padding: 15px; display: none; max-width: 600px; max-height: 700px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #7c3aed;">üì° Station Monitoring</h3>
                        <button onclick="hideStationMonitoring()" style="background: #dc2626; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
                    </div>
                    <div id="station-info"></div>
                    <div id="station-trains"></div>
                    <div id="station-paths"></div>
                </div>
                
                <div id="map-status" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Map Status:</strong> <span id="status-text">Ready to initialize</span>
                </div>
            </div>
        </div>

        <!-- Trains Page -->
        <div id="trains" class="page">
            <div class="page-header">
                <h2>Train Management</h2>
                <p class="page-description">Monitor and manage all active trains across the railway network</p>
            </div>
            <div class="train-list">
                <div id="all-trains">
                    <div class="loading">Loading train information...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="page-header">
                <h2>Performance Analytics</h2>
                <p class="page-description">Comprehensive performance metrics and system analytics</p>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number">95.2%</div>
                    <div class="stat-label">Punctuality Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">87.5%</div>
                    <div class="stat-label">Throughput Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">12</div>
                    <div class="stat-label">Conflicts Resolved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">2.3 min</div>
                    <div class="stat-label">Average Delay</div>
                </div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about" class="page">
            <div class="page-header">
                <h2>About the System</h2>
                <p class="page-description">Learn about our AI-powered railway traffic control technology</p>
            </div>
            <div class="features">
                <div class="feature-card">
                    <h3>üéØ Mission</h3>
                    <p>To revolutionize railway traffic control through AI-powered optimization, ensuring maximum efficiency and safety across India's vast railway network.</p>
                </div>
                <div class="feature-card">
                    <h3>üîß Technology</h3>
                    <p>Built with FastAPI, React, Leaflet.js, and advanced optimization algorithms using Google OR-Tools for real-time decision support.</p>
                </div>
                <div class="feature-card">
                    <h3>üìà Impact</h3>
                    <p>Reducing delays, maximizing throughput, and providing intelligent decision support for railway traffic controllers nationwide.</p>
                </div>
                <div class="feature-card">
                    <h3>üöÄ Future</h3>
                    <p>Integration with existing railway control systems, machine learning enhancements, and predictive analytics for proactive management.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Railway Traffic Control System - Smart India Hackathon</p>
        <p>Ministry of Railways | AI-Powered Decision Support System</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Global variables for map
        let map = null;
        let mapData = null;
        let stationMarkers = [];
        let trainMarkers = [];
        let trackLines = [];
        let liveMovementEnabled = false;
        let voiceAlertsEnabled = false;
        let updateInterval = null;
        let speechSynthesis = window.speechSynthesis;
        let selectedStation = null;
        let stationMonitoringEnabled = false;
        let stationUpdateInterval = null;

        // Update status text
        function updateStatus(message) {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = message;
            }
            console.log('üó∫Ô∏è Status:', message);
        }

        // Initialize the map
        function initializeMap() {
            try {
                updateStatus('Initializing map...');
                
                const mapContainer = document.getElementById('railway-map');
                if (!mapContainer) {
                    updateStatus('‚ùå Map container not found!');
                    return;
                }

                // Clear existing map if any
                if (map) {
                    map.remove();
                }

                // Create new map
                map = L.map('railway-map').setView([20.5937, 78.9629], 5);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                updateStatus('‚úÖ Map initialized successfully!');
                
                // Auto-load data after map is ready
                setTimeout(() => {
                    loadMapData();
                }, 500);
                
            } catch (error) {
                updateStatus('‚ùå Error initializing map: ' + error.message);
                console.error('Map initialization error:', error);
            }
        }


        // Add stations to map
        function addStationsToMap() {
            if (!map || !mapData) return;
            
            // Clear existing station markers
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            mapData.stations.forEach(station => {
                const marker = L.marker([station.lat, station.lon]).addTo(map);
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e3a8a;">${station.name}</h3>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${station.type}</p>
                        <p style="margin: 5px 0;"><strong>Platforms:</strong> ${station.platforms}</p>
                        <p style="margin: 5px 0;"><strong>ID:</strong> ${station.id}</p>
                    </div>
                `);
                stationMarkers.push(marker);
            });
        }

        // Add tracks to map
        function addTracksToMap() {
            if (!map || !mapData) return;
            
            // Clear existing track lines
            trackLines.forEach(line => map.removeLayer(line));
            trackLines = [];
            
            mapData.tracks.forEach(track => {
                const fromStation = mapData.stations.find(s => s.id === track.from_station);
                const toStation = mapData.stations.find(s => s.id === track.to_station);
                
                if (fromStation && toStation) {
                    const polyline = L.polyline([
                        [fromStation.lat, fromStation.lon],
                        [toStation.lat, toStation.lon]
                    ], {
                        color: getTrackColor(track.track_type),
                        weight: getTrackWeight(track.track_type),
                        opacity: 0.8
                    }).addTo(map);
                    
                    polyline.bindPopup(`
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0;">Track Segment</h4>
                            <p style="margin: 5px 0;"><strong>From:</strong> ${fromStation.name}</p>
                            <p style="margin: 5px 0;"><strong>To:</strong> ${toStation.name}</p>
                            <p style="margin: 5px 0;"><strong>Distance:</strong> ${track.distance} km</p>
                            <p style="margin: 5px 0;"><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${track.track_type}</p>
                        </div>
                    `);
                    trackLines.push(polyline);
                }
            });
        }

        // Add trains to map
        function addTrainsToMap() {
            if (!map || !mapData) return;
            
            // Clear existing train markers
            trainMarkers.forEach(marker => map.removeLayer(marker));
            trainMarkers = [];
            
            mapData.trains.forEach(train => {
                // Determine marker style based on alerts
                let markerClass = 'train-marker';
                let markerColor = '';
                
                if (train.collision_risk) {
                    markerClass += ' collision-risk';
                    markerColor = 'red';
                } else if (train.rerouting_needed) {
                    markerClass += ' rerouting-needed';
                    markerColor = 'orange';
                }
                
                const trainIcon = L.divIcon({
                    className: markerClass,
                    html: getTrainIcon(train.train_type, markerColor),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const trainMarker = L.marker([train.lat, train.lon], {
                    icon: trainIcon
                }).addTo(map);
                
                // Enhanced popup with AI messages and section info
                let popupContent = `
                    <div style="min-width: 320px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e3a8a;">${train.train_number}</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="background: ${getPriorityColor(train.priority)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                Priority ${train.priority}
                            </span>
                            <span style="background: ${getSectionColor(train.section_id)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                ${train.section_id.replace(/_/g, ' ')}
                            </span>
                        </div>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${train.train_type}</p>
                        <p style="margin: 5px 0;"><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</p>
                        <p style="margin: 5px 0;"><strong>Current:</strong> ${train.current_station}</p>
                        <p style="margin: 5px 0;"><strong>Next:</strong> ${train.next_station}</p>
                        <p style="margin: 5px 0;"><strong>Speed:</strong> ${train.speed} km/h</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> ${train.status}</p>
                        <p style="margin: 5px 0;"><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                        ${train.delay_minutes > 0 ? `<p style="margin: 5px 0; color: #dc2626;"><strong>Delay:</strong> ${train.delay_minutes} min</p>` : ''}
                `;
                
                if (train.ai_message) {
                    popupContent += `
                        <div style="margin-top: 10px; padding: 8px; background: ${train.collision_risk ? '#fef2f2' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${train.collision_risk ? '#dc2626' : '#d97706'};">
                            <strong>ü§ñ AI Alert:</strong><br>
                            ${train.ai_message}
                        </div>
                    `;
                }
                
                popupContent += `</div>`;
                
                trainMarker.bindPopup(popupContent);
                trainMarkers.push(trainMarker);
            });
        }

        // Helper functions
        function getTrackColor(trackType) {
            const colors = {
                'main': '#1e3a8a',
                'suburban': '#dc2626',
                'branch': '#d97706',
                'freight': '#6b7280'
            };
            return colors[trackType] || '#1e3a8a';
        }

        function getTrackWeight(trackType) {
            const weights = {
                'main': 4,
                'suburban': 3,
                'branch': 2,
                'freight': 2
            };
            return weights[trackType] || 3;
        }

        function getTrainIcon(trainType, color = '') {
            const icons = {
                'Rajdhani Express': 'üöÑ',
                'Shatabdi Express': 'üöÖ',
                'Duronto Express': 'üöÜ',
                'Vande Bharat Express': 'üöà',
                'Express': 'üöÇ',
                'Mail': 'üöÉ',
                'Freight': 'üöõ',
                'Local': 'üöã'
            };
            
            const icon = icons[trainType] || 'üöÇ';
            
            if (color === 'red') {
                return `<div style="color: red; font-size: 20px; text-shadow: 2px 2px 4px rgba(255,0,0,0.8); animation: pulse-red 1s infinite;">${icon}</div>`;
            } else if (color === 'orange') {
                return `<div style="color: orange; font-size: 20px; text-shadow: 2px 2px 4px rgba(255,165,0,0.8); animation: pulse-orange 1s infinite;">${icon}</div>`;
            } else {
                return `<div style="font-size: 20px;">${icon}</div>`;
            }
        }

        // Refresh map data
        function refreshMap() {
            if (map) {
                loadMapData();
            } else {
                updateStatus('‚ùå Please initialize map first');
            }
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            const mapContainer = document.getElementById('railway-map');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().then(() => {
                    mapContainer.style.height = '100vh';
                    if (map) {
                        map.invalidateSize();
                    }
                    updateStatus('‚úÖ Fullscreen mode enabled');
                }).catch(err => {
                    updateStatus('‚ùå Error entering fullscreen: ' + err.message);
                });
            } else {
                document.exitFullscreen().then(() => {
                    mapContainer.style.height = '600px';
                    if (map) {
                        map.invalidateSize();
                    }
                    updateStatus('‚úÖ Fullscreen mode disabled');
                });
            }
        }

        // Toggle voice alerts
        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.textContent = voiceAlertsEnabled ? 'üîá Voice Alerts' : 'üîä Voice Alerts';
            voiceBtn.style.backgroundColor = voiceAlertsEnabled ? '#dc2626' : '';
            updateStatus(voiceAlertsEnabled ? '‚úÖ Voice alerts enabled' : '‚úÖ Voice alerts disabled');
        }

        // Toggle live movement
        function toggleLiveMovement() {
            liveMovementEnabled = !liveMovementEnabled;
            const movementBtn = document.getElementById('movement-btn');
            movementBtn.textContent = liveMovementEnabled ? '‚è∏Ô∏è Live Movement' : '‚ñ∂Ô∏è Live Movement';
            movementBtn.style.backgroundColor = liveMovementEnabled ? '#dc2626' : '';
            
            if (liveMovementEnabled) {
                startLiveMovement();
                updateStatus('‚úÖ Live movement enabled');
            } else {
                stopLiveMovement();
                updateStatus('‚úÖ Live movement disabled');
            }
        }

        // Start live movement updates
        function startLiveMovement() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(() => {
                if (map && mapData) {
                    loadMapData();
                }
            }, 3000); // Update every 3 seconds
        }

        // Stop live movement updates
        function stopLiveMovement() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Speak alert message
        function speakAlert(message) {
            if (voiceAlertsEnabled && speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        // Show AI message overlay
        function showAIMessage(message, duration = 5000) {
            const overlay = document.getElementById('ai-overlay');
            const messageDiv = document.getElementById('ai-message');
            
            if (overlay && messageDiv) {
                messageDiv.textContent = message;
                overlay.style.display = 'block';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, duration);
            }
        }

        // Update alert panel
        function updateAlertPanel(collisions, rerouting) {
            const alertPanel = document.getElementById('alert-panel');
            const alertList = document.getElementById('alert-list');
            
            if (!alertPanel || !alertList) return;
            
            const allAlerts = [...collisions, ...rerouting];
            
            if (allAlerts.length > 0) {
                alertPanel.style.display = 'block';
                alertList.innerHTML = '';
                
                allAlerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = `
                        padding: 8px; margin: 5px 0; border-radius: 4px;
                        background: ${alert.severity === 'high' ? '#fef2f2' : '#fef3c7'};
                        border-left: 4px solid ${alert.severity === 'high' ? '#dc2626' : '#d97706'};
                    `;
                    alertDiv.innerHTML = `
                        <strong>${alert.train_number}</strong><br>
                        ${alert.message}<br>
                        <small>${new Date(alert.timestamp).toLocaleTimeString()}</small>
                    `;
                    alertList.appendChild(alertDiv);
                    
                    // Speak high priority alerts
                    if (alert.severity === 'high') {
                        speakAlert(`Collision risk detected for train ${alert.train_number}`);
                    }
                });
            } else {
                alertPanel.style.display = 'none';
            }
        }

        // Enhanced loadMapData function
        async function loadMapData() {
            try {
                updateStatus('Loading data from API...');
                
                const response = await fetch('http://localhost:8081/api/map-data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                mapData = await response.json();
                updateStatus(`‚úÖ Data loaded! Stations: ${mapData.stations.length}, Trains: ${mapData.trains.length}, Tracks: ${mapData.tracks.length}`);
                
                // Add data to map
                addStationsToMap();
                addTracksToMap();
                addTrainsToMap();
                
                // Populate station dropdown
                populateStationDropdown();
                
                // Update alerts
                if (mapData.collisions || mapData.rerouting) {
                    updateAlertPanel(mapData.collisions || [], mapData.rerouting || []);
                }
                
                // Show AI messages for trains with alerts
                mapData.trains.forEach(train => {
                    if (train.ai_message) {
                        showAIMessage(`${train.train_number}: ${train.ai_message}`, 3000);
                    }
                });
                
                updateStatus(`‚úÖ Map fully loaded with ${mapData.stations.length} stations, ${mapData.tracks.length} tracks, and ${mapData.trains.length} trains!`);
                
            } catch (error) {
                updateStatus('‚ùå Error loading data: ' + error.message);
                console.error('Data loading error:', error);
            }
        }

        // Show Section Controller
        function showSectionController() {
            const panel = document.getElementById('section-controller');
            if (panel) {
                panel.style.display = 'block';
                loadSectionData();
                updateStatus('‚úÖ Section Controller opened');
            }
        }

        // Hide Section Controller
        function hideSectionController() {
            const panel = document.getElementById('section-controller');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        // Show All Trains Panel
        function showAllTrains() {
            const panel = document.getElementById('all-trains-panel');
            if (panel) {
                panel.style.display = 'block';
                loadTrainsData();
                updateStatus('‚úÖ All Trains panel opened');
            }
        }

        // Hide All Trains Panel
        function hideAllTrains() {
            const panel = document.getElementById('all-trains-panel');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        // Load Section Data
        async function loadSectionData() {
            try {
                const response = await fetch('http://localhost:8081/api/section-status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const sectionData = await response.json();
                displaySectionData(sectionData);
                
            } catch (error) {
                console.error('Error loading section data:', error);
                updateStatus('‚ùå Error loading section data: ' + error.message);
            }
        }

        // Display Section Data
        function displaySectionData(sections) {
            const sectionList = document.getElementById('section-list');
            if (!sectionList) return;
            
            sectionList.innerHTML = '';
            
            Object.values(sections).forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.style.cssText = `
                    margin-bottom: 15px; padding: 12px; border-radius: 8px;
                    border-left: 4px solid ${getSectionColor(section)};
                    background: ${getSectionBackground(section)};
                `;
                
                sectionDiv.innerHTML = `
                    <h4 style="margin: 0 0 8px 0; color: #1e3a8a;">${section.section_id.replace(/_/g, ' ')}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                        <div><strong>Total Trains:</strong> ${section.total_trains}</div>
                        <div><strong>Delayed:</strong> ${section.delayed_trains}</div>
                        <div><strong>Collision Risks:</strong> ${section.collision_risks}</div>
                        <div><strong>Rerouting:</strong> ${section.rerouting_needed}</div>
                        <div><strong>Avg Delay:</strong> ${section.avg_delay} min</div>
                        <div><strong>Status:</strong> ${getSectionStatus(section)}</div>
                    </div>
                    <div style="margin-top: 8px;">
                        <strong>Trains:</strong>
                        <div style="max-height: 100px; overflow-y: auto; font-size: 12px;">
                            ${section.trains.map(train => `
                                <div style="margin: 2px 0; padding: 2px 4px; background: rgba(0,0,0,0.05); border-radius: 3px;">
                                    ${train.train_number} (${train.train_type}) - ${train.current_station}
                                    ${train.collision_risk ? ' üö®' : ''} ${train.rerouting_needed ? ' üîÑ' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                sectionList.appendChild(sectionDiv);
            });
        }

        // Load Trains Data
        function loadTrainsData() {
            if (!mapData || !mapData.trains) return;
            
            const trainsList = document.getElementById('trains-list');
            if (!trainsList) return;
            
            trainsList.innerHTML = '';
            
            // Sort trains by priority and status
            const sortedTrains = mapData.trains.sort((a, b) => {
                if (a.collision_risk !== b.collision_risk) {
                    return a.collision_risk ? -1 : 1;
                }
                if (a.rerouting_needed !== b.rerouting_needed) {
                    return a.rerouting_needed ? -1 : 1;
                }
                return a.priority - b.priority;
            });
            
            sortedTrains.forEach(train => {
                const trainDiv = document.createElement('div');
                trainDiv.style.cssText = `
                    margin-bottom: 8px; padding: 10px; border-radius: 6px;
                    border-left: 4px solid ${getTrainStatusColor(train)};
                    background: ${getTrainBackground(train)};
                    cursor: pointer;
                `;
                
                trainDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${train.train_number}</strong> (${train.train_type})
                            ${train.collision_risk ? ' üö®' : ''} ${train.rerouting_needed ? ' üîÑ' : ''}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            Priority: ${train.priority}
                        </div>
                    </div>
                    <div style="font-size: 12px; margin-top: 4px;">
                        <div><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</div>
                        <div><strong>Current:</strong> ${train.current_station} ‚Üí ${train.next_station}</div>
                        <div><strong>Speed:</strong> ${train.speed} km/h | <strong>Progress:</strong> ${Math.round(train.progress * 100)}%</div>
                        <div><strong>Section:</strong> ${train.section_id.replace(/_/g, ' ')}</div>
                        ${train.delay_minutes > 0 ? `<div style="color: #dc2626;"><strong>Delay:</strong> ${train.delay_minutes} min</div>` : ''}
                        ${train.ai_message ? `<div style="color: #d97706; font-style: italic;">ü§ñ ${train.ai_message}</div>` : ''}
                    </div>
                `;
                
                // Click to focus on train
                trainDiv.addEventListener('click', () => {
                    if (map) {
                        map.setView([train.lat, train.lon], 8);
                        // Open popup for this train
                        const marker = trainMarkers.find(m => m.getLatLng().lat === train.lat && m.getLatLng().lng === train.lon);
                        if (marker) {
                            marker.openPopup();
                        }
                    }
                });
                
                trainsList.appendChild(trainDiv);
            });
        }

        // Helper functions for styling
        function getSectionColor(section) {
            if (section.collision_risks > 0) return '#dc2626';
            if (section.rerouting_needed > 0) return '#d97706';
            if (section.delayed_trains > section.total_trains * 0.5) return '#f59e0b';
            return '#059669';
        }

        function getSectionBackground(section) {
            if (section.collision_risks > 0) return '#fef2f2';
            if (section.rerouting_needed > 0) return '#fef3c7';
            if (section.delayed_trains > section.total_trains * 0.5) return '#fffbeb';
            return '#f0fdf4';
        }

        function getSectionStatus(section) {
            if (section.collision_risks > 0) return 'üö® CRITICAL';
            if (section.rerouting_needed > 0) return 'üîÑ REROUTING';
            if (section.delayed_trains > section.total_trains * 0.5) return '‚ö†Ô∏è DELAYED';
            return '‚úÖ NORMAL';
        }

        function getTrainStatusColor(train) {
            if (train.collision_risk) return '#dc2626';
            if (train.rerouting_needed) return '#d97706';
            if (train.delay_minutes > 15) return '#f59e0b';
            return '#059669';
        }

        function getTrainBackground(train) {
            if (train.collision_risk) return '#fef2f2';
            if (train.rerouting_needed) return '#fef3c7';
            if (train.delay_minutes > 15) return '#fffbeb';
            return '#f0fdf4';
        }

        function getPriorityColor(priority) {
            const colors = {
                1: '#dc2626',  // Highest priority - Red
                2: '#d97706',  // High priority - Orange
                3: '#059669',  // Medium priority - Green
                4: '#2563eb',  // Low priority - Blue
                5: '#6b7280',  // Lower priority - Gray
                6: '#9ca3af'   // Lowest priority - Light Gray
            };
            return colors[priority] || '#059669';
        }

        function getSectionColor(sectionId) {
            const colors = {
                'NORTH_DELHI': '#dc2626',
                'SOUTH_DELHI': '#d97706',
                'MUMBAI_CENTRAL': '#059669',
                'MUMBAI_WESTERN': '#2563eb',
                'KOLKATA_HOWRAH': '#7c3aed',
                'KOLKATA_SEALDAH': '#db2777',
                'CHENNAI_CENTRAL': '#0891b2',
                'BANGALORE_CITY': '#16a34a',
                'BANGALORE_YESVANTPUR': '#ca8a04',
                'GUJARAT_NORTH': '#dc2626',
                'AHMEDABAD': '#d97706',
                'VADODARA': '#059669',
                'JAIPUR': '#2563eb',
                'JODHPUR': '#7c3aed',
                'BIKANER': '#db2777',
                'LUCKNOW': '#0891b2',
                'KANPUR': '#16a34a',
                'GHAZIABAD': '#ca8a04',
                'PATNA': '#dc2626',
                'GAYA': '#d97706',
                'MUZAFFARPUR': '#059669',
                'ASANSOL': '#2563eb',
                'DURGAPUR': '#7c3aed',
                'BURDWAN': '#db2777',
                'PUNE': '#0891b2',
                'KOLHAPUR': '#16a34a',
                'SURAT': '#ca8a04',
                'HYDERABAD': '#dc2626',
                'SECUNDERABAD': '#d97706',
                'KAZIPET': '#059669',
                'VIJAYAWADA': '#2563eb',
                'RAJAHMUNDRY': '#7c3aed',
                'VISAKHAPATNAM': '#db2777',
                'THIRUVANANTHAPURAM': '#0891b2',
                'KOLLAM': '#16a34a',
                'ALLEPPEY': '#ca8a04',
                'KANNUR': '#dc2626',
                'KOZHIKODE': '#d97706',
                'THRISSUR': '#059669'
            };
            return colors[sectionId] || '#6b7280';
        }

        // Populate station dropdown
        function populateStationDropdown() {
            const stationSelect = document.getElementById('station-select');
            if (!stationSelect || !mapData) return;
            
            stationSelect.innerHTML = '<option value="">Select a station to monitor...</option>';
            
            mapData.stations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = `${station.name} (${station.id})`;
                stationSelect.appendChild(option);
            });
        }

        // Select station for monitoring
        function selectStation() {
            const stationSelect = document.getElementById('station-select');
            const clearBtn = document.getElementById('clear-station-btn');
            
            if (stationSelect.value) {
                selectedStation = mapData.stations.find(s => s.id === stationSelect.value);
                clearBtn.style.display = 'inline-block';
                updateStatus(`‚úÖ Selected station: ${selectedStation.name}`);
                
                // Focus map on selected station
                if (map && selectedStation) {
                    map.setView([selectedStation.lat, selectedStation.lon], 10);
                    
                    // Highlight the selected station
                    highlightStation(selectedStation);
                }
            } else {
                clearStationFocus();
            }
        }

        // Clear station focus
        function clearStationFocus() {
            selectedStation = null;
            const stationSelect = document.getElementById('station-select');
            const clearBtn = document.getElementById('clear-station-btn');
            
            stationSelect.value = '';
            clearBtn.style.display = 'none';
            
            // Remove station highlight
            removeStationHighlight();
            
            updateStatus('‚úÖ Station focus cleared');
        }

        // Highlight selected station
        function highlightStation(station) {
            // Remove existing highlights
            removeStationHighlight();
            
            if (map) {
                // Create a special marker for the selected station
                const highlightIcon = L.divIcon({
                    className: 'station-highlight',
                    html: `<div style="background: #7c3aed; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 0 10px rgba(124, 58, 237, 0.8);">üéØ</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const highlightMarker = L.marker([station.lat, station.lon], {
                    icon: highlightIcon
                }).addTo(map);
                
                highlightMarker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #7c3aed;">üéØ ${station.name}</h3>
                        <p style="margin: 5px 0;"><strong>ID:</strong> ${station.id}</p>
                        <p style="margin: 5px 0;"><strong>Type:</strong> ${station.type}</p>
                        <p style="margin: 5px 0;"><strong>Platforms:</strong> ${station.platforms}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> Monitoring Active</p>
                    </div>
                `);
                
                // Store reference for removal
                window.highlightMarker = highlightMarker;
            }
        }

        // Remove station highlight
        function removeStationHighlight() {
            if (window.highlightMarker && map) {
                map.removeLayer(window.highlightMarker);
                window.highlightMarker = null;
            }
        }

        // Toggle station monitoring
        function toggleStationMonitoring() {
            if (!selectedStation) {
                updateStatus('‚ùå Please select a station first');
                return;
            }
            
            stationMonitoringEnabled = !stationMonitoringEnabled;
            const monitorBtn = document.getElementById('monitor-btn');
            const panel = document.getElementById('station-monitoring-panel');
            
            if (stationMonitoringEnabled) {
                monitorBtn.textContent = '‚è∏Ô∏è Stop Monitoring';
                monitorBtn.style.backgroundColor = '#dc2626';
                panel.style.display = 'block';
                startStationMonitoring();
                updateStatus(`‚úÖ Started monitoring ${selectedStation.name}`);
            } else {
                monitorBtn.textContent = 'üì° Start Monitoring';
                monitorBtn.style.backgroundColor = '';
                panel.style.display = 'none';
                stopStationMonitoring();
                updateStatus('‚úÖ Stopped station monitoring');
            }
        }

        // Start station monitoring
        function startStationMonitoring() {
            if (stationUpdateInterval) {
                clearInterval(stationUpdateInterval);
            }
            
            // Initial load
            loadStationMonitoringData();
            
            // Update every 2 seconds
            stationUpdateInterval = setInterval(() => {
                loadStationMonitoringData();
            }, 2000);
        }

        // Stop station monitoring
        function stopStationMonitoring() {
            if (stationUpdateInterval) {
                clearInterval(stationUpdateInterval);
                stationUpdateInterval = null;
            }
        }

        // Load station monitoring data
        function loadStationMonitoringData() {
            if (!selectedStation || !mapData) return;
            
            // Update station info
            updateStationInfo();
            
            // Update trains at station
            updateStationTrains();
            
            // Update train paths
            updateStationPaths();
        }

        // Update station information
        function updateStationInfo() {
            const stationInfo = document.getElementById('station-info');
            if (!stationInfo || !selectedStation) return;
            
            stationInfo.innerHTML = `
                <div style="margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #7c3aed;">
                    <h4 style="margin: 0 0 8px 0; color: #7c3aed;">üì° ${selectedStation.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                        <div><strong>Station ID:</strong> ${selectedStation.id}</div>
                        <div><strong>Type:</strong> ${selectedStation.type}</div>
                        <div><strong>Platforms:</strong> ${selectedStation.platforms}</div>
                        <div><strong>Coordinates:</strong> ${selectedStation.lat.toFixed(4)}, ${selectedStation.lon.toFixed(4)}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
        }

        // Update trains at station
        function updateStationTrains() {
            const stationTrains = document.getElementById('station-trains');
            if (!stationTrains || !selectedStation || !mapData) return;
            
            // Find trains at this station
            const trainsAtStation = mapData.trains.filter(train => 
                train.current_station === selectedStation.id || 
                train.next_station === selectedStation.id
            );
            
            stationTrains.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #7c3aed;">üöÇ Trains at Station (${trainsAtStation.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${trainsAtStation.length > 0 ? 
                            trainsAtStation.map(train => `
                                <div style="margin-bottom: 8px; padding: 10px; border-radius: 6px; border-left: 4px solid ${getTrainStatusColor(train)}; background: ${getTrainBackground(train)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${train.train_number}</strong> (${train.train_type})
                                            ${train.collision_risk ? ' üö®' : ''} ${train.rerouting_needed ? ' üîÑ' : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #666;">
                                            Priority: ${train.priority}
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; margin-top: 4px;">
                                        <div><strong>Route:</strong> ${train.origin} ‚Üí ${train.destination}</div>
                                        <div><strong>Status:</strong> ${train.current_station === selectedStation.id ? 'At Station' : 'Approaching'}</div>
                                        <div><strong>Speed:</strong> ${train.speed} km/h | <strong>Progress:</strong> ${Math.round(train.progress * 100)}%</div>
                                        ${train.delay_minutes > 0 ? `<div style="color: #dc2626;"><strong>Delay:</strong> ${train.delay_minutes} min</div>` : ''}
                                        ${train.ai_message ? `<div style="color: #d97706; font-style: italic;">ü§ñ ${train.ai_message}</div>` : ''}
                                    </div>
                                </div>
                            `).join('') :
                            '<div style="text-align: center; color: #6b7280; padding: 20px;">No trains currently at this station</div>'
                        }
                    </div>
                </div>
            `;
        }

        // Update station paths
        function updateStationPaths() {
            const stationPaths = document.getElementById('station-paths');
            if (!stationPaths || !selectedStation || !mapData) return;
            
            // Find tracks connected to this station
            const connectedTracks = mapData.tracks.filter(track => 
                track.from_station === selectedStation.id || track.to_station === selectedStation.id
            );
            
            stationPaths.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #7c3aed;">üõ§Ô∏è Connected Tracks (${connectedTracks.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${connectedTracks.map(track => {
                            const fromStation = mapData.stations.find(s => s.id === track.from_station);
                            const toStation = mapData.stations.find(s => s.id === track.to_station);
                            const isFromStation = track.from_station === selectedStation.id;
                            
                            return `
                                <div style="margin-bottom: 8px; padding: 10px; border-radius: 6px; border-left: 4px solid ${getTrackColor(track.type)}; background: #f8fafc;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">
                                        ${isFromStation ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'} ${isFromStation ? toStation.name : fromStation.name}
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280;">
                                        <div><strong>Distance:</strong> ${track.distance} km</div>
                                        <div><strong>Max Speed:</strong> ${track.max_speed} km/h</div>
                                        <div><strong>Type:</strong> ${track.type}</div>
                                        <div><strong>Direction:</strong> ${isFromStation ? 'Outbound' : 'Inbound'}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Hide station monitoring panel
        function hideStationMonitoring() {
            const panel = document.getElementById('station-monitoring-panel');
            if (panel) {
                panel.style.display = 'none';
            }
            stopStationMonitoring();
            stationMonitoringEnabled = false;
            const monitorBtn = document.getElementById('monitor-btn');
            monitorBtn.textContent = 'üì° Start Monitoring';
            monitorBtn.style.backgroundColor = '';
        }

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Ready to initialize map');
        });
    </script>
</body>
</html>
