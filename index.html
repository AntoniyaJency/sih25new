<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Traffic Control System - Smart India Hackathon 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Railway Traffic Control</div>
            <button class="mobile-menu-toggle">â˜°</button>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="map">Live Map</a></li>
                <li><a href="#" class="nav-link" data-page="trains">Trains</a></li>
                <li><a href="#" class="nav-link" data-page="analytics">Analytics</a></li>
                <li><a href="#" class="nav-link" data-page="about">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>AI-Powered Railway Traffic Control</h1>
                <p>Maximizing Section Throughput Using Intelligent Decision Support System</p>
                <p>Smart India Hackathon 2025 - Ministry of Railways</p>
                <a href="#" class="btn" onclick="showPage('dashboard')">View Dashboard</a>
                <a href="#" class="btn btn-secondary" onclick="showPage('map')">Live Map</a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>ğŸš‚ Real-time Tracking</h3>
                    <p>Monitor all trains across the Indian railway network with live position updates and movement tracking.</p>
                </div>
                <div class="feature-card">
                    <h3>âš¡ AI Optimization</h3>
                    <p>Advanced algorithms for conflict detection, route optimization, and throughput maximization.</p>
                </div>
                <div class="feature-card">
                    <h3>ğŸ“Š Analytics Dashboard</h3>
                    <p>Comprehensive analytics and reporting for railway operations and performance metrics.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="page-header">
                <h2>ğŸ“Š Dashboard</h2>
                <p class="page-description">Real-time overview of railway operations and system performance</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>ğŸš‚ Active Trains</h3>
                    <div class="metric-value">50</div>
                    <div class="metric-label">Currently Running</div>
                </div>
                <div class="dashboard-card">
                    <h3>ğŸš‰ Stations</h3>
                    <div class="metric-value">124</div>
                    <div class="metric-label">Total Stations</div>
                </div>
                <div class="dashboard-card">
                    <h3>ğŸ›¤ï¸ Track Segments</h3>
                    <div class="metric-value">86</div>
                    <div class="metric-label">Active Routes</div>
                </div>
                <div class="dashboard-card">
                    <h3>âš¡ System Status</h3>
                    <div class="metric-value online">Online</div>
                    <div class="metric-label">All Systems Operational</div>
                </div>
            </div>
        </div>

        <!-- Live Map Page -->
        <div id="map" class="page">
            <div class="page-header">
                <h2>ğŸ—ºï¸ Live Railway Map</h2>
                <p class="page-description">Interactive map showing real-time train positions and railway network across India</p>
            </div>
            
            <!-- Main Map Layout -->
            <div class="map-layout">
                <!-- Left Sidebar -->
                <div class="map-sidebar">
                    <!-- Map Controls -->
                    <div class="sidebar-section">
                        <h4>ğŸ® Map Controls</h4>
                        <div class="control-grid">
                            <button onclick="initializeMap()" class="btn btn-primary">ğŸ—ºï¸ Initialize</button>
                            <button onclick="loadMapData()" class="btn btn-secondary">ğŸ“Š Load Data</button>
                            <button onclick="refreshMap()" class="btn btn-success">ğŸ”„ Refresh</button>
                            <button onclick="forceUpdateTrains()" class="btn btn-info">ğŸš‚ Update</button>
                        </div>
                    </div>
                    
                    <!-- Display Options -->
                    <div class="sidebar-section">
                        <h4>âš™ï¸ Display Options</h4>
                        <div class="control-grid">
                            <button onclick="toggleFullscreen()" class="btn btn-warning">ğŸ“º Fullscreen</button>
                            <button onclick="toggleVoiceAlerts()" class="btn" id="voice-btn">ğŸ”Š Voice</button>
                            <button onclick="toggleLiveMovement()" class="btn" id="movement-btn">â–¶ï¸ Movement</button>
                            <button onclick="showSectionController()" class="btn" id="controller-btn">ğŸ›ï¸ Controller</button>
                        </div>
                    </div>
                    
                    <!-- Station Monitoring -->
                    <div class="sidebar-section">
                        <h4>ğŸ“¡ Station Monitoring</h4>
                        <div class="station-controls">
                            <select id="station-select" onchange="selectStation()" class="form-select">
                                <option value="">Select station to monitor...</option>
                            </select>
                            <div class="station-buttons">
                                <button onclick="populateStationDropdown()" class="btn btn-secondary">ğŸ”„ Load</button>
                                <button onclick="clearStationFocus()" class="btn btn-outline">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="sidebar-section">
                        <h4>ğŸ“Š System Status</h4>
                        <div id="status-display" class="status-display">Ready</div>
                    </div>
                </div>
                
                <!-- Main Map Area -->
                <div class="map-main">
                    <div id="railway-map" class="railway-map"></div>
                    
                    <!-- AI Message Overlay -->
                    <div id="ai-overlay" class="ai-overlay">
                        <div id="ai-message"></div>
                    </div>
                </div>
                
                <!-- Right Panel -->
                <div class="map-right-panel">
                    <!-- Real-Time Data -->
                    <div class="panel-section">
                        <h4>ğŸ“ˆ Real-Time Data</h4>
                        <div id="real-time-data" class="real-time-data">
                            <div class="data-item">
                                <span class="data-label">Active Trains:</span>
                                <span id="active-trains-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Total Stations:</span>
                                <span id="total-stations-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Track Segments:</span>
                                <span id="track-segments-count" class="data-value">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">System Status:</span>
                                <span id="system-status" class="data-value">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Live Station Monitoring Panel -->
            <div id="live-station-monitor" class="live-station-monitor" style="display: none;">
                <div class="monitor-header">
                    <h4>ğŸ“¡ Live Station Monitoring</h4>
                    <button onclick="closeLiveMonitor()" class="btn btn-secondary">âœ• Close</button>
                </div>
                <div class="monitor-content">
                    <div class="station-info">
                        <h5 id="monitor-station-name">Station Name</h5>
                        <div class="station-stats">
                            <div class="stat-item">
                                <span class="stat-label">Connected Tracks:</span>
                                <span id="monitor-tracks-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Active Trains:</span>
                                <span id="monitor-trains-count" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Monitoring Status:</span>
                                <span id="monitor-status" class="stat-value">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="live-trains-list">
                        <h6>ğŸš‚ Live Train Movements</h6>
                        <div id="live-trains-container" class="trains-container">
                            <div class="loading">Loading live train data...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Controller Panel -->
            <div id="ai-controller-panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid #dc2626; border-radius: 10px; padding: 20px; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #dc2626;">ğŸ›ï¸ AI Section Controller</h3>
                    <button onclick="hideAIControllerPanel()" style="background: #dc2626; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">Ã—</button>
                </div>
                <div id="ai-controller-content"></div>
            </div>
        </div>

        <!-- Trains Page -->
        <div id="trains" class="page">
            <div class="page-header">
                <h2>ğŸš‚ Train Management</h2>
                <p class="page-description">Monitor and manage all active trains across the railway network</p>
            </div>
            
            <div class="trains-grid">
                <div class="loading">Loading train data...</div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="page-header">
                <h2>ğŸ“Š Analytics</h2>
                <p class="page-description">Comprehensive analytics and performance metrics</p>
            </div>
            
            <div class="analytics-grid">
                <div class="loading">Loading analytics data...</div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about" class="page">
            <div class="page-header">
                <h2>â„¹ï¸ About</h2>
                <p class="page-description">Learn more about the Railway Traffic Control System</p>
            </div>
            
            <div class="about-content">
                <div class="about-card">
                    <h3>ğŸ¯ Mission</h3>
                    <p>To revolutionize railway traffic control through AI-powered decision support systems that maximize throughput while ensuring safety and efficiency.</p>
                </div>
                <div class="about-card">
                    <h3>ğŸš€ Technology</h3>
                    <p>Built with cutting-edge technologies including machine learning, real-time data processing, and advanced optimization algorithms.</p>
                </div>
                <div class="about-card">
                    <h3>ğŸ† Smart India Hackathon 2025</h3>
                    <p>Developed for the Ministry of Railways as part of the Smart India Hackathon 2025 initiative.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Railway Traffic Control System. Smart India Hackathon 2025 - Ministry of Railways</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let mapData = null;
        let trainMarkers = [];
        let stationMarkers = [];
        let trackLines = [];
        let isFullscreen = false;
        let voiceAlertsEnabled = false;
        let liveMovementEnabled = true;
        let realTimeUpdateInterval;
        let selectedStation = null;
        let liveStationMonitorInterval;

        // Navigation functionality
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Initialize map if on map page
            if (pageId === 'map') {
                setTimeout(() => {
                    initializeMap();
                    loadMapData();
                }, 100);
            }
        }

        // Map initialization
        function initializeMap() {
            try {
                console.log('ğŸ—ºï¸ Initializing map...');
                
                if (map) {
                    map.remove();
                }
                
                // Create new map with stable settings - centered on India
                map = L.map('railway-map', {
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    touchZoom: true,
                    zoomSnap: 0.25,
                    zoomDelta: 0.5,
                    wheelPxPerZoomLevel: 120
                }).setView([20.5937, 78.9629], 6); // Centered on India with zoom level 6
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 4,
                    opacity: 0.9
                }).addTo(map);
                
                // Prevent map resize issues
                map.on('resize', () => {
                    setTimeout(() => map.invalidateSize(), 100);
                });
                
                // Initial size validation
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                // Debug: Check if map is visible
                setTimeout(() => {
                    if (map) {
                        console.log('ğŸ—ºï¸ Map is ready and visible');
                        console.log('ğŸ“ Map center:', map.getCenter());
                        console.log('ğŸ” Map zoom:', map.getZoom());
                        
                        // Force map to be visible
                        map.invalidateSize();
                        
                        // Auto-load data after map is ready
                        loadMapData();
                    } else {
                        console.error('âŒ Map failed to initialize');
                        updateStatus('âŒ Map failed to initialize');
                    }
                }, 1000);
                
                updateStatus('âœ… Map initialized successfully');
                
            } catch (error) {
                console.error('âŒ Map initialization error:', error);
                updateStatus('âŒ Map initialization failed: ' + error.message);
            }
        }

        // Load map data
        function loadMapData() {
            console.log('ğŸ“Š Loading map data...');
            updateStatus('ğŸ“Š Loading map data...');
            
            fetch('http://localhost:8081/api/map-data')
                .then(response => response.json())
                .then(data => {
                    console.log('âœ… Map data loaded:', data);
                    mapData = data;
                    
                    // Add elements to map
                    addStationsToMap();
                    addTracksToMap();
                    addTrainsToMap();
                    
                    // Update real-time data display
                    updateRealTimeDataDisplay();
                    
                    // Start real-time updates
                    startRealTimeUpdates();
                    
                    // Populate station dropdown
                    populateStationDropdown();
                    
                    updateStatus('âœ… Map data loaded successfully');
                })
                .catch(error => {
                    console.error('âŒ Error loading map data:', error);
                    updateStatus('âŒ Failed to load map data: ' + error.message);
                });
        }

        // Add stations to map
        function addStationsToMap() {
            if (!mapData || !mapData.stations) return;
            
            console.log('ğŸš‰ Adding stations to map...');
            
            mapData.stations.forEach(station => {
                const stationMarker = L.marker([station.lat, station.lon], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: 'ğŸš‰',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                stationMarker.bindPopup(`
                    <div class="station-popup">
                        <h4>${station.name}</h4>
                        <p><strong>Code:</strong> ${station.id}</p>
                        <p><strong>Type:</strong> ${station.type}</p>
                        <p><strong>Platforms:</strong> ${station.platforms}</p>
                    </div>
                `);
                
                stationMarkers.push(stationMarker);
            });
            
            console.log(`âœ… Added ${mapData.stations.length} stations to map`);
        }

        // Add tracks to map
        function addTracksToMap() {
            if (!mapData || !mapData.tracks) return;
            
            console.log('ğŸ›¤ï¸ Adding tracks to map...');
            
            mapData.tracks.forEach(track => {
                const trackLine = L.polyline([
                    [track.from.lat, track.from.lon],
                    [track.to.lat, track.to.lon]
                ], {
                    color: '#1e40af',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 5'
                }).addTo(map);
                
                trackLine.bindPopup(`
                    <div class="track-popup">
                        <h4>Track ${track.id}</h4>
                        <p><strong>Distance:</strong> ${track.distance} km</p>
                        <p><strong>Max Speed:</strong> ${track.max_speed} km/h</p>
                        <p><strong>Type:</strong> ${track.type}</p>
                    </div>
                `);
                
                trackLines.push(trackLine);
            });
            
            console.log(`âœ… Added ${mapData.tracks.length} tracks to map`);
        }

        // Add trains to map
        function addTrainsToMap() {
            if (!mapData || !mapData.trains) return;
            
            console.log('ğŸš‚ Adding trains to map...');
            
            mapData.trains.forEach(train => {
                const trainMarker = L.marker([train.lat, train.lon], {
                    icon: L.divIcon({
                        className: 'train-marker',
                        html: getTrainIcon(train),
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                trainMarker.bindPopup(`
                    <div class="train-popup">
                        <h4>${train.train_number} - ${train.train_type}</h4>
                        <p><strong>Speed:</strong> ${train.speed} km/h</p>
                        <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                        <p><strong>Status:</strong> ${train.status}</p>
                        <p><strong>Route:</strong> ${train.origin} â†’ ${train.destination}</p>
                        ${train.collision_risk ? '<p style="color: red;"><strong>âš ï¸ Collision Risk!</strong></p>' : ''}
                        ${train.rerouting_needed ? '<p style="color: orange;"><strong>ğŸ”„ Rerouting Needed</strong></p>' : ''}
                    </div>
                `);
                
                trainMarker.trainNumber = train.train_number;
                trainMarkers.push(trainMarker);
            });
            
            console.log(`âœ… Added ${mapData.trains.length} trains to map`);
        }

        // Get train icon
        function getTrainIcon(train) {
            return `<span style="font-size: 18px; color: #1e40af; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">ğŸš‚</span>`;
        }

        // Update train positions
        function updateTrainPositions() {
            if (!mapData || !mapData.trains) return;
            
            mapData.trains.forEach(train => {
                const marker = trainMarkers.find(m => m.trainNumber === train.train_number);
                if (marker) {
                    // Smooth animation to new position
                    marker.setLatLng([train.lat, train.lon], { animate: true, duration: 1.5 });
                    
                    // Update popup with fresh data
                    marker.bindPopup(`
                        <div class="train-popup">
                            <h4>${train.train_number} - ${train.train_type}</h4>
                            <p><strong>Speed:</strong> ${train.speed} km/h</p>
                            <p><strong>Progress:</strong> ${Math.round(train.progress * 100)}%</p>
                            <p><strong>Status:</strong> ${train.status}</p>
                            <p><strong>Route:</strong> ${train.origin} â†’ ${train.destination}</p>
                            ${train.collision_risk ? '<p style="color: red;"><strong>âš ï¸ Collision Risk!</strong></p>' : ''}
                            ${train.rerouting_needed ? '<p style="color: orange;"><strong>ğŸ”„ Rerouting Needed</strong></p>' : ''}
                        </div>
                    `);
                    
                    // Add visual effects for collision risk
                    if (train.collision_risk) {
                        marker.getElement().style.animation = 'train-alert 1s infinite';
                    } else if (train.rerouting_needed) {
                        marker.getElement().style.animation = 'train-warning 1s infinite';
                    } else {
                        marker.getElement().style.animation = 'train-move 2s infinite';
                    }
                }
            });
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            realTimeUpdateInterval = setInterval(() => {
                // Fetch fresh data from backend
                fetch('http://localhost:8081/api/map-data')
                    .then(response => response.json())
                    .then(data => {
                        mapData = data;
                        updateTrainPositions();
                        updateRealTimeDataDisplay();
                        console.log('ğŸ”„ Real-time update completed');
                    })
                    .catch(error => {
                        console.error('âŒ Real-time update error:', error);
                    });
            }, 2000);
        }

        // Update real-time data display
        function updateRealTimeDataDisplay() {
            if (!mapData) return;
            
            document.getElementById('active-trains-count').textContent = mapData.trains.length;
            document.getElementById('total-stations-count').textContent = mapData.stations.length;
            document.getElementById('track-segments-count').textContent = mapData.tracks.length;
            document.getElementById('system-status').textContent = 'Online';
        }

        // Station selection
        function selectStation() {
            const select = document.getElementById('station-select');
            const stationId = select.value;
            
            if (stationId) {
                const station = mapData.stations.find(s => s.id === stationId);
                if (station) {
                    selectedStation = station;
                    map.setView([station.lat, station.lon], 12, { animate: false });
                    startLiveStationMonitoring(station);
                }
            } else {
                clearStationFocus();
            }
        }

        // Start live station monitoring
        function startLiveStationMonitoring(station) {
            document.getElementById('live-station-monitor').style.display = 'block';
            document.getElementById('monitor-station-name').textContent = station.name;
            
            updateLiveStationData(station);
            
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
            
            liveStationMonitorInterval = setInterval(() => {
                updateLiveStationData(station);
            }, 3000);
        }

        // Update live station data
        function updateLiveStationData(station) {
            if (!mapData || !mapData.trains) return;
            
            console.log('ğŸ” Updating station data for:', station.name, station.id);
            console.log('ğŸš‚ Total trains available:', mapData.trains.length);
            
            // Find trains at or approaching this station - improved filtering
            const trainsAtStation = mapData.trains.filter(train => {
                const isAtStation = train.current_station === station.id;
                const isNextStation = train.next_station === station.id;
                const isOrigin = train.origin === station.id;
                const isDestination = train.destination === station.id;
                
                if (isAtStation || isNextStation || isOrigin || isDestination) {
                    console.log(`ğŸš‚ Train ${train.train_number} found at ${station.name}:`, {
                        current_station: train.current_station,
                        next_station: train.next_station,
                        origin: train.origin,
                        destination: train.destination,
                        reason: isAtStation ? 'current' : isNextStation ? 'next' : isOrigin ? 'origin' : 'destination'
                    });
                }
                
                return isAtStation || isNextStation || isOrigin || isDestination;
            });
            
            // Find connected tracks
            const connectedTracks = mapData.tracks.filter(track => 
                track.from.lat === station.lat && track.from.lon === station.lon ||
                track.to.lat === station.lat && track.to.lon === station.lon
            );
            
            console.log(`ğŸ“Š Found ${trainsAtStation.length} trains and ${connectedTracks.length} tracks for ${station.name}`);
            
            // Update display
            document.getElementById('monitor-tracks-count').textContent = connectedTracks.length;
            document.getElementById('monitor-trains-count').textContent = trainsAtStation.length;
            document.getElementById('monitor-status').textContent = 'Active';
            
            // Update trains list
            updateLiveTrainsList(trainsAtStation, connectedTracks);
        }

        // Update live trains list
        function updateLiveTrainsList(trains, tracks) {
            const container = document.getElementById('live-trains-container');
            
            console.log('ğŸ“‹ Updating trains list with:', trains.length, 'trains');
            
            if (trains.length === 0) {
                container.innerHTML = '<div class="no-trains"><p>ğŸš‚ No trains at this station</p><p>Try selecting a different station or wait for trains to arrive</p></div>';
                return;
            }
            
            container.innerHTML = trains.map(train => {
                // Determine train location status
                let locationStatus = '';
                if (train.current_station === train.origin) {
                    locationStatus = 'ğŸš‰ At Origin Station';
                } else if (train.current_station === train.destination) {
                    locationStatus = 'ğŸ At Destination';
                } else if (train.next_station === train.origin) {
                    locationStatus = 'ğŸš‚ Approaching Station';
                } else {
                    locationStatus = `ğŸš‚ Current: ${train.current_station}`;
                }
                
                return `
                    <div class="train-item">
                        <div class="train-header">
                            <span class="train-number">${train.train_number}</span>
                            <span class="train-name">${train.train_type}</span>
                            <span class="train-status ${train.status.toLowerCase()}">${train.status}</span>
                        </div>
                        <div class="train-details">
                            <div class="train-route">
                                <span class="route-from">${train.origin}</span>
                                <span class="route-arrow">â†’</span>
                                <span class="route-to">${train.destination}</span>
                            </div>
                            <div class="train-location">
                                <span class="location-text">${locationStatus}</span>
                            </div>
                            <div class="train-metrics">
                                <div class="metric">Speed: ${train.speed} km/h</div>
                                <div class="metric">Progress: ${Math.round(train.progress * 100)}%</div>
                                <div class="metric">Delay: ${train.delay_minutes || 0} min</div>
                            </div>
                            ${train.collision_risk ? '<span class="alert-badge collision">âš ï¸ Collision Risk</span>' : ''}
                            ${train.rerouting_needed ? '<span class="alert-badge rerouting">ğŸ”„ Rerouting Needed</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Close live monitor
        function closeLiveMonitor() {
            document.getElementById('live-station-monitor').style.display = 'none';
            if (liveStationMonitorInterval) {
                clearInterval(liveStationMonitorInterval);
            }
        }

        // Clear station focus
        function clearStationFocus() {
            selectedStation = null;
            document.getElementById('station-select').value = '';
            closeLiveMonitor();
        }

        // Populate station dropdown
        function populateStationDropdown() {
            const select = document.getElementById('station-select');
            select.innerHTML = '<option value="">Select station to monitor...</option>';
            
            if (mapData && mapData.stations) {
                mapData.stations.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `${station.name} (${station.id})`;
                    select.appendChild(option);
                });
            }
        }

        // Toggle functions
        function toggleFullscreen() {
            if (!isFullscreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                isFullscreen = false;
            }
        }

        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            const btn = document.getElementById('voice-btn');
            btn.textContent = voiceAlertsEnabled ? 'ğŸ”Š Voice ON' : 'ğŸ”Š Voice';
            btn.style.backgroundColor = voiceAlertsEnabled ? '#059669' : '';
        }

        function toggleLiveMovement() {
            liveMovementEnabled = !liveMovementEnabled;
            const btn = document.getElementById('movement-btn');
            btn.textContent = liveMovementEnabled ? 'â¸ï¸ Pause' : 'â–¶ï¸ Movement';
            btn.style.backgroundColor = liveMovementEnabled ? '#059669' : '';
        }

        function showSectionController() {
            document.getElementById('ai-controller-panel').style.display = 'block';
        }

        function hideAIControllerPanel() {
            document.getElementById('ai-controller-panel').style.display = 'none';
        }

        // Utility functions
        function refreshMap() {
            if (map) {
                map.invalidateSize();
                updateStatus('ğŸ”„ Map refreshed');
            }
        }

        function forceUpdateTrains() {
            // Force refresh train data
            fetch('http://localhost:8081/api/map-data')
                .then(response => response.json())
                .then(data => {
                    mapData = data;
                    
                    // Clear existing train markers
                    trainMarkers.forEach(marker => map.removeLayer(marker));
                    trainMarkers = [];
                    
                    // Re-add trains with fresh data
                    addTrainsToMap();
                    updateRealTimeDataDisplay();
                    
                    updateStatus('ğŸš‚ Train data force updated');
                    console.log('ğŸš‚ Force update completed');
                })
                .catch(error => {
                    console.error('âŒ Force update error:', error);
                    updateStatus('âŒ Force update failed');
                });
        }

        function updateStatus(message) {
            document.getElementById('status-display').textContent = message;
            console.log('ğŸ“Š Status:', message);
        }

        // Debug function to show train movement
        function debugTrainMovement() {
            if (!mapData || !mapData.trains) return;
            
            console.log('ğŸš‚ Debug: Train Movement Data');
            mapData.trains.slice(0, 5).forEach(train => {
                console.log(`Train ${train.train_number}:`, {
                    position: `[${train.lat.toFixed(4)}, ${train.lon.toFixed(4)}]`,
                    speed: `${train.speed} km/h`,
                    progress: `${Math.round(train.progress * 100)}%`,
                    status: train.status,
                    collision_risk: train.collision_risk,
                    rerouting_needed: train.rerouting_needed
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Railway Traffic Control System initialized');
            
            // Set up navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
                document.querySelector('.nav-links').classList.toggle('active');
            });
            
            // Auto-populate station dropdown
            setTimeout(() => {
                populateStationDropdown();
            }, 1000);
            
            // Debug train movement every 10 seconds
            setInterval(() => {
                if (mapData && mapData.trains) {
                    debugTrainMovement();
                }
            }, 10000);
        });
    </script>
</body>
</html>
